<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AK后台监控系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #e4e4e4;
            --text-secondary: #8892b0;
            --accent: #00d4ff;
            --accent-green: #00ff88;
            --accent-red: #ff4757;
            --accent-yellow: #ffa502;
            --border: #2d2d44;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-green) 100%);
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #00b8d4 0%, #00e676 100%);
        }
        
        /* Firefox 滚动条 */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-secondary);
        }
        
        /* 头部 */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            background: linear-gradient(90deg, var(--accent), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-primary);
            border-radius: 20px;
            font-size: 14px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-red);
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: var(--accent-green);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px 30px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.1);
        }
        
        .stat-card .label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent);
        }
        
        .stat-card.green .value { color: var(--accent-green); }
        .stat-card.red .value { color: var(--accent-red); }
        .stat-card.yellow .value { color: var(--accent-yellow); }
        
        /* 流光边框效果 */
        .glow-border {
            position: relative;
            background: var(--bg-card);
            border: none !important;
            overflow: hidden;
            isolation: isolate;
        }
        
        .glow-border::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg 60deg,
                var(--glow-color, var(--accent)) 60deg 120deg,
                transparent 120deg 180deg,
                var(--glow-color, var(--accent)) 180deg 240deg,
                transparent 240deg 300deg,
                var(--glow-color, var(--accent)) 300deg 360deg
            );
            animation: glow-spin 3s linear infinite;
            z-index: -2;
        }
        
        .glow-border::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: var(--bg-card);
            border-radius: 10px;
            z-index: -1;
        }
        
        @keyframes glow-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* 不同颜色主题 */
        .glow-border.glow-cyan { --glow-color: #00d4ff; }
        .glow-border.glow-green { --glow-color: #00ff88; }
        .glow-border.glow-pink { --glow-color: #ff6b9d; }
        .glow-border.glow-yellow { --glow-color: #f7b731; }
        .glow-border.glow-purple { --glow-color: #a55eea; }
        
        .glow-border {
            box-shadow: 0 0 20px rgba(var(--glow-rgb, 0, 212, 255), 0.25);
        }
        
        .glow-border.glow-cyan { box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
        .glow-border.glow-green { box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
        .glow-border.glow-pink { box-shadow: 0 0 20px rgba(255, 107, 157, 0.3); }
        .glow-border.glow-yellow { box-shadow: 0 0 20px rgba(247, 183, 49, 0.3); }
        .glow-border.glow-purple { box-shadow: 0 0 20px rgba(165, 94, 234, 0.3); }
        
        .glow-border:hover::before {
            animation-duration: 1.5s;
        }
        
        .glow-border.glow-cyan:hover { box-shadow: 0 0 30px rgba(0, 212, 255, 0.5); }
        .glow-border.glow-green:hover { box-shadow: 0 0 30px rgba(0, 255, 136, 0.5); }
        .glow-border.glow-pink:hover { box-shadow: 0 0 30px rgba(255, 107, 157, 0.5); }
        .glow-border.glow-yellow:hover { box-shadow: 0 0 30px rgba(247, 183, 49, 0.5); }
        .glow-border.glow-purple:hover { box-shadow: 0 0 30px rgba(165, 94, 234, 0.5); }
        
        /* 可排序表头 */
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            white-space: nowrap;
        }
        
        th.sortable:hover {
            background: rgba(0, 212, 255, 0.15);
        }
        
        th.sortable .sort-icon {
            display: inline-block;
            margin-left: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        
        th.sortable.asc .sort-icon,
        th.sortable.desc .sort-icon {
            color: var(--accent);
        }
        
        /* ===== 权限标识样式 ===== */
        .role-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        
        .role-badge.super-admin {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 50%, #ffd700 100%);
            background-size: 200% 200%;
            animation: shimmer 2s ease-in-out infinite;
            color: #1a1a2e;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 140, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .role-badge.sub-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 200%;
            animation: shimmer 3s ease-in-out infinite;
            color: white;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .role-badge::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 70%
            );
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .role-icon {
            font-size: 16px;
            z-index: 1;
        }
        
        .role-text {
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .role-badge.super-admin .role-icon {
            animation: crown-bounce 1s ease-in-out infinite;
        }
        
        @keyframes crown-bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-2px) rotate(-5deg); }
            75% { transform: translateY(-2px) rotate(5deg); }
        }
        
        /* ===== 流量仪表盘样式 ===== */
        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .metric-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .metric-info {
            flex: 1;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* 24小时趋势图 */
        .dashboard-chart {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            margin-bottom: 25px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h4 {
            margin: 0;
            color: var(--accent);
        }
        
        .chart-update-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .chart-container {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 150px;
            padding: 0 10px;
        }
        
        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #00d4ff, #667eea);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.5s ease, background 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .chart-bar:hover {
            background: linear-gradient(to top, #00ff88, #00d4ff);
        }
        
        .chart-bar::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        
        .chart-bar:hover::after {
            opacity: 1;
        }
        
        .chart-labels {
            display: flex;
            gap: 4px;
            padding: 10px 10px 0;
        }
        
        .chart-label {
            flex: 1;
            text-align: center;
            font-size: 10px;
            color: var(--text-secondary);
        }
        
        /* 排行榜 */
        .dashboard-rankings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .ranking-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .ranking-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        
        .ranking-header h4 {
            margin: 0;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .ranking-list {
            padding: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            gap: 12px;
            transition: background 0.2s;
        }
        
        .ranking-item:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        
        .ranking-rank {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }
        
        .ranking-item:nth-child(1) .ranking-rank {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
        }
        
        .ranking-item:nth-child(2) .ranking-rank {
            background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
            color: #000;
        }
        
        .ranking-item:nth-child(3) .ranking-rank {
            background: linear-gradient(135deg, #cd7f32, #a0522d);
            color: #fff;
        }
        
        .ranking-name {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .ranking-value {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent);
        }
        
        .ranking-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* 实时活动流 */
        .dashboard-activity {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .activity-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-header h4 {
            margin: 0;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .activity-status {
            font-size: 12px;
            color: var(--accent-green);
            animation: pulse 2s infinite;
        }
        
        .activity-stream {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            animation: slideInLeft 0.3s ease;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: var(--bg-secondary);
        }
        
        .activity-icon.success { background: rgba(0, 255, 136, 0.15); }
        .activity-icon.failed { background: rgba(255, 71, 87, 0.15); }
        .activity-icon.info { background: rgba(0, 212, 255, 0.15); }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .activity-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .activity-empty {
            padding: 40px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* ===== 激活码管理样式 ===== */
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background: rgba(0, 255, 136, 0.15);
            color: var(--accent-green);
        }
        
        .status-inactive {
            background: rgba(150, 150, 150, 0.15);
            color: var(--text-secondary);
        }
        
        .status-expired {
            background: rgba(255, 165, 0, 0.15);
            color: #ffa500;
        }
        
        .status-revoked {
            background: rgba(255, 71, 87, 0.15);
            color: var(--accent-red);
        }
        
        .btn-small {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            margin-right: 4px;
            transition: all 0.2s;
        }
        
        .btn-small:hover {
            background: var(--accent);
            transform: scale(1.05);
        }
        
        .btn-small.btn-danger:hover {
            background: var(--accent-red);
        }
        
        /* 响应式 */
        @media screen and (max-width: 1024px) {
            .dashboard-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-rankings {
                grid-template-columns: 1fr;
            }
            
            .metric-card {
                padding: 15px;
            }
            
            .metric-value {
                font-size: 22px;
            }
            
            .license-stats {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* 标签页 */
        .tabs {
            display: flex;
            padding: 0 30px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab:hover {
            color: var(--text-primary);
        }
        
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        
        /* 内容区 */
        .content {
            padding: 20px 30px;
        }
        
        .panel {
            display: none;
        }
        
        .panel.active {
            display: block;
        }
        
        /* 表格 */
        .table-container {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
        }
        
        tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge.success {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }
        
        .badge.danger {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
        }
        
        .badge.warning {
            background: rgba(255, 165, 2, 0.2);
            color: var(--accent-yellow);
        }
        
        /* 按钮 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .btn-danger {
            background: var(--accent-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff6b7a;
        }
        
        .btn-page {
            padding: 6px 14px;
            background: #ffffff;
            color: #1a1a2e;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-page:hover:not(:disabled) {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .btn-page:disabled {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }
        
        .btn-page.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .btn-success {
            background: var(--accent-green);
            color: #000;
        }
        
        .btn-success:hover {
            background: #33ff99;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #000;
        }
        
        .btn-primary:hover {
            background: #33ddff;
        }
        
        /* 实时日志 */
        .live-log {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-item {
            padding: 10px;
            border-left: 3px solid var(--accent);
            margin-bottom: 10px;
            background: var(--bg-secondary);
            border-radius: 0 8px 8px 0;
            animation: slideIn 0.3s ease;
        }
        
        .log-item.success {
            border-left-color: var(--accent-green);
        }
        
        .log-item.failed {
            border-left-color: var(--accent-red);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .log-item .time {
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        .log-item .info {
            margin-top: 5px;
        }
        
        /* 弹窗 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            min-width: 400px;
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                min-width: unset;
                width: 90%;
                max-width: 500px;
                padding: 20px;
                max-height: 85vh;
            }
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--accent);
        }
        
        .modal-content input {
            width: 100%;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .modal-content input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* 刷新按钮 */
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: scale(1.1);
        }
        
        .refresh-btn svg {
            width: 24px;
            height: 24px;
            fill: #000;
        }
        
        /* 登录页面 */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 380px;
            box-shadow: 0 20px 60px rgba(0, 212, 255, 0.1);
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
            background: linear-gradient(90deg, var(--accent), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .login-box .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .login-input {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent), #0099cc);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }
        
        .login-error {
            color: var(--accent-red);
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        
        .main-content {
            display: none;
        }
        
        .main-content.visible {
            display: block;
        }
        
        /* ===== 横屏提示 ===== */
        .rotate-hint {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 99999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
        }
        
        .rotate-hint .icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: rotate-phone 2s ease-in-out infinite;
        }
        
        @keyframes rotate-phone {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(90deg); }
        }
        
        .rotate-hint h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--accent);
        }
        
        .rotate-hint p {
            color: var(--text-secondary);
            font-size: 16px;
            line-height: 1.6;
        }
        
        /* ===== 移动端适配 ===== */
        @media screen and (max-width: 1024px) {
            .header {
                padding: 12px 15px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 10px 15px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-card .value {
                font-size: 20px;
            }
            
            .tabs {
                padding: 0 10px;
                gap: 5px;
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 12px;
                white-space: nowrap;
            }
            
            .content {
                padding: 10px;
            }
            
            .table-container {
                font-size: 12px;
            }
            
            table th, table td {
                padding: 8px 6px;
            }
            
            .btn {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .login-box {
                width: 90%;
                max-width: 350px;
                padding: 30px 25px;
            }
            
            /* 在线用户页面适配 */
            #online > div {
                grid-template-columns: 1fr !important;
                height: auto !important;
            }
            
            #online .table-container {
                max-height: 200px;
            }
            
            /* 激活码表格移动端适配 */
            .license-table-wrap {
                max-height: 50vh !important;
                min-height: 200px;
                -webkit-overflow-scrolling: touch;
            }
            
            .license-table-wrap table {
                min-width: 650px;
            }
            
            /* 激活码管理顶部工具栏 */
            #license > div:first-child {
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            /* 聊天区域适配 */
            #chatMessages {
                height: 200px !important;
                flex: none !important;
            }
        }
        
        /* 横屏时隐藏提示 */
        @media screen and (orientation: landscape) {
            .rotate-hint {
                display: none !important;
            }
        }
        
        /* 竖屏且是移动设备时显示提示 */
        @media screen and (orientation: portrait) and (max-width: 768px) {
            .rotate-hint {
                display: flex !important;
            }
        }
    </style>
</head>
<body>
    <!-- 横屏提示 -->
    <div class="rotate-hint" id="rotateHint">
        <div class="icon">📱</div>
        <h2>请旋转设备</h2>
        <p>为了获得最佳体验，<br>请将手机横屏使用</p>
    </div>
    
    <!-- 登录页面 -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h2>AK后台监控系统</h2>
            <p class="subtitle">管理员登录</p>
            <input type="password" class="login-input" id="loginPassword" 
                   placeholder="请输入管理员密码" onkeypress="if(event.keyCode===13)doLogin()">
            <button class="login-btn" onclick="doLogin()"> 登 录</button>
            <p class="login-error" id="loginError">密码错误，请重试</p>
        </div>
    </div>
    
    <!-- 主内容 -->
    <div class="main-content" id="mainContent">
    <header class="header">
        <h1>AK后台监控系统</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <!-- 显示模式切换 -->
            <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary);">
                <span>显示模式:</span>
                <div style="display: flex; background: var(--bg-primary); border-radius: 4px; border: 1px solid var(--border); overflow: hidden;">
                    <div id="modeFullBtn" onclick="setViewMode(false)" 
                         style="padding: 4px 10px; cursor: pointer; color: white; background: var(--accent); transition: all 0.2s;">完全</div>
                    <div id="modeCompactBtn" onclick="setViewMode(true)" 
                         style="padding: 4px 10px; cursor: pointer; color: var(--text-secondary); background: transparent; transition: all 0.2s;">精简</div>
                </div>
            </div>
            <!-- 权限标识 -->
            <div class="role-badge" id="roleBadge">
                <span class="role-icon">👑</span>
                <span class="role-text" id="roleText">加载中...</span>
            </div>
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">连接中...</span>
            </div>
            <button onclick="logout()" style="padding: 8px 16px; background: var(--accent-red); border: none; 
                    border-radius: 6px; color: white; cursor: pointer; font-size: 13px;">
                退出登录
            </button>
        </div>
    </header>
    
    <!-- 统计卡片 -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="label">总用户数</div>
            <div class="value" id="statUsers">-</div>
        </div>
        <div class="stat-card green">
            <div class="label">今日登录</div>
            <div class="value" id="statToday">-</div>
        </div>
        <div class="stat-card yellow">
            <div class="label">总登录次数</div>
            <div class="value" id="statLogins">-</div>
        </div>
        <div class="stat-card">
            <div class="label">独立IP</div>
            <div class="value" id="statIPs">-</div>
        </div>
        <div class="stat-card glow-border glow-cyan">
            <div class="label">总AK数量</div>
            <div class="value" id="statTotalAce">-</div>
        </div>
        <div class="stat-card glow-border glow-green">
            <div class="label">总EP</div>
            <div class="value" id="statTotalEP" style="color: var(--accent-green);">-</div>
        </div>
        <div class="stat-card glow-border glow-pink">
            <div class="label">总SP</div>
            <div class="value" id="statTotalSP" style="color: #ff6b9d;">-</div>
        </div>
        <div class="stat-card glow-border glow-yellow">
            <div class="label">总RP</div>
            <div class="value" id="statTotalRP" style="color: #f7b731;">-</div>
        </div>
        <div class="stat-card glow-border glow-purple">
            <div class="label">总TP</div>
            <div class="value" id="statTotalTP" style="color: #a55eea;">-</div>
        </div>
        <div class="stat-card red">
            <div class="label">封禁数量</div>
            <div class="value" id="statBanned">-</div>
        </div>
    </div>
    
    <!-- 标签页 -->
    <div class="tabs">
        <div class="tab active" data-panel="dashboard" id="tabDashboard">📈 流量仪表盘</div>
        <div class="tab" data-panel="online">🟢 在线用户</div>
        <div class="tab" data-panel="usage">📊 使用情况</div>
        <div class="tab" data-panel="users">👥 用户管理</div>
        <div class="tab" data-panel="ips">🌐 IP管理</div>
        <div class="tab" data-panel="banlist">🚫 封禁列表</div>
        <div class="tab" data-panel="license">🔑 激活码</div>
        <div class="tab" data-panel="database">🗄️ 数据库</div>
        <div class="tab" data-panel="settings">⚙️ 设置</div>
    </div>
    
    <!-- 内容区 -->
    <div class="content">
        <!-- 流量仪表盘 -->
        <div class="panel active" id="dashboard">
            <!-- 实时指标卡片 -->
            <div class="dashboard-metrics">
                <div class="metric-card">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #00d4ff, #0099cc);"></div>
                    <div class="metric-info">
                        <div class="metric-value" id="dashTodayRequests">0</div>
                        <div class="metric-label">今日请求</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #00ff88, #00cc6a);"></div>
                    <div class="metric-info">
                        <div class="metric-value" id="dashSuccessRate">0%</div>
                        <div class="metric-label">成功率</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                    <div class="metric-info">
                        <div class="metric-value" id="dashActiveUsers">0</div>
                        <div class="metric-label">今日活跃</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);"></div>
                    <div class="metric-info">
                        <div class="metric-value" id="dashPeakRPM">0</div>
                        <div class="metric-label">峰值RPM</div>
                    </div>
                </div>
            </div>
            
            <!-- 24小时趋势图 -->
            <div class="dashboard-chart">
                <div class="chart-header">
                    <h4>24小时请求趋势</h4>
                    <span class="chart-update-time" id="chartUpdateTime">--:--</span>
                </div>
                <div class="chart-container" id="hourlyChart">
                    <!-- 柱状图将由JS生成 -->
                </div>
                <div class="chart-labels" id="chartLabels">
                    <!-- 时间标签将由JS生成 -->
                </div>
            </div>
            
            <!-- 排行榜区域 -->
            <div class="dashboard-rankings">
                <!-- Top用户 -->
                <div class="ranking-card">
                    <div class="ranking-header">
                        <h4>🏆 今日活跃用户 Top10</h4>
                    </div>
                    <div class="ranking-list" id="topUsersList">
                        <div class="ranking-empty">暂无数据</div>
                    </div>
                </div>
                
                <!-- Top IP -->
                <div class="ranking-card">
                    <div class="ranking-header">
                        <h4>🌐 今日访问IP Top10</h4>
                    </div>
                    <div class="ranking-list" id="topIpsList">
                        <div class="ranking-empty">暂无数据</div>
                    </div>
                </div>
            </div>
            
            <!-- 实时活动流 -->
            <div class="dashboard-activity">
                <div class="activity-header">
                    <h4>⏱ 实时活动</h4>
                    <span class="activity-status">● 实时更新中</span>
                </div>
                <div class="activity-stream" id="activityStream">
                    <div class="activity-empty">等待活动数据...</div>
                </div>
            </div>
        </div>
        
        <!-- 在线用户 -->
        <div class="panel" id="online">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: calc(100vh - 350px);">
                <!-- 在线用户列表 -->
                <div class="table-container" style="overflow: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>用户名</th>
                                <th>当前操作</th>
                                <th>上线时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="onlineTable">
                            <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">暂无在线用户</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 聊天区域 -->
                <div style="background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column;">
                    <div style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0; color: var(--accent);">💬 与 <span id="chatTarget">-</span> 聊天</h4>
                        <span id="chatStatus" style="font-size: 12px; color: var(--text-secondary);">选择用户开始聊天</span>
                    </div>
                    <div id="chatMessages" style="flex: 1; padding: 15px; overflow-y: auto; background: var(--bg-primary);">
                        <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            点击用户列表中的"聊天"按钮开始对话
                        </div>
                    </div>
                    <div style="padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 10px;">
                        <input type="text" id="chatInput" placeholder="输入消息..." disabled
                               style="flex: 1; padding: 10px 15px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 20px; color: var(--text-primary); outline: none;">
                        <button class="btn btn-primary" id="chatSendBtn" onclick="sendChatMessage()" disabled>发送</button>
                    </div>
                    <div style="padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="broadcastInput" placeholder="群发消息给所有在线用户..."
                               style="flex: 1; padding: 10px 15px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 20px; color: var(--text-primary); outline: none;">
                        <button class="btn" style="background: linear-gradient(135deg, #f39c12, #e74c3c);" onclick="broadcastMessage()">📢 群发</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 使用情况（登录尝试记录） -->
        <div class="panel" id="usage">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="usageSearchInput" placeholder="🔍 搜索用户名..." 
                       style="flex: 1; max-width: 300px; padding: 10px 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                       oninput="searchUsage()">
                <button class="btn btn-primary" onclick="searchUsage()" style="padding: 10px 20px;">搜索</button>
                <button class="btn-page" onclick="clearUsageSearch()" style="padding: 10px 20px;">清除</button>
                <span id="usageSearchCount" style="color: var(--text-secondary); font-size: 14px; margin-left: auto;"></span>
            </div>
            <div class="table-container" style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th>密码</th>
                            <th>登录次数</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="usageTable">
                        <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 用户管理（用户资产信息） -->
        <div class="panel" id="users">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="usersSearchInput" placeholder="搜索用户名..." 
                       style="flex: 1; max-width: 300px; padding: 10px 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                       oninput="searchUsers()" onkeypress="if(event.keyCode===13)searchUsers()">
                <button class="btn btn-primary" onclick="searchUsers()" style="padding: 10px 20px;">搜索</button>
                <button class="btn-page" onclick="clearUsersSearch()" style="padding: 10px 20px;">清除</button>
                <label style="display: flex; align-items: center; gap: 6px; color: var(--text-secondary); font-size: 14px; cursor: pointer; margin-left: 10px;">
                    <input type="checkbox" id="usersLoadAll" onchange="onUsersLoadAllChange()" style="cursor: pointer; width: 16px; height: 16px; accent-color: var(--accent);">
                    加载全部
                </label>
                <span id="usersSearchCount" style="color: var(--text-secondary); font-size: 14px; margin-left: auto;"></span>
            </div>
            <div class="table-container" style="overflow-x: auto;">
                <table style="min-width: 1400px;">
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th class="sortable" onclick="sortUsersBy('ace_count')" data-field="ace_count">主账户AK <span class="sort-icon" id="sort-ace_count">⇅</span></th>
                            <th class="sortable" onclick="sortUsersBy('total_ace')" data-field="total_ace">子账户AK <span class="sort-icon" id="sort-total_ace">⇅</span></th>
                            <th class="sortable" onclick="sortUsersBy('ep')" data-field="ep">EP <span class="sort-icon" id="sort-ep">⇅</span></th>
                            <th class="sortable" onclick="sortUsersBy('sp')" data-field="sp">SP <span class="sort-icon" id="sort-sp">⇅</span></th>
                            <th class="sortable" onclick="sortUsersBy('rp')" data-field="rp">RP <span class="sort-icon" id="sort-rp">⇅</span></th>
                            <th class="sortable" onclick="sortUsersBy('tp')" data-field="tp">TP <span class="sort-icon" id="sort-tp">⇅</span></th>
                            <th class="sortable" onclick="sortUsersBy('weekly_money')" data-field="weekly_money">本周收益 <span class="sort-icon" id="sort-weekly_money">⇅</span></th>
                            <th class="sortable" onclick="sortUsersBy('honor_name')" data-field="honor_name">等级 <span class="sort-icon" id="sort-honor_name">⇅</span></th>
                            <th class="sortable" onclick="sortUsersBy('updated_at')" data-field="updated_at">更新时间 <span class="sort-icon" id="sort-updated_at">⇅</span></th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <tr><td colspan="11" style="text-align: center; color: var(--text-secondary);">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
            <!-- 分页控件 -->
            <div id="usersPagination" style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 15px; padding: 10px 0;">
                <button class="btn-page" onclick="usersGoPage(0)" id="usersFirstBtn" disabled>首页</button>
                <button class="btn-page" onclick="usersGoPage(usersCurrentPage - 1)" id="usersPrevBtn" disabled>上一页</button>
                <span id="usersPageInfo" style="color: var(--text-secondary); font-size: 14px; min-width: 120px; text-align: center;">第 1 页</span>
                <button class="btn-page" onclick="usersGoPage(usersCurrentPage + 1)" id="usersNextBtn" disabled>下一页</button>
                <button class="btn-page" onclick="usersGoPage(usersTotalPages - 1)" id="usersLastBtn" disabled>末页</button>
            </div>
        </div>
        
        <!-- IP管理 -->
        <div class="panel" id="ips">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>IP地址</th>
                            <th>请求次数</th>
                            <th>首次访问</th>
                            <th>最后访问</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="ipsTable">
                        <tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 封禁列表 -->
        <div class="panel" id="banlist">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>类型</th>
                            <th>值</th>
                            <th>封禁时间</th>
                            <th>原因</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="banlistTable">
                        <tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 激活码管理 -->
        <div class="panel" id="license">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h3 style="margin: 0; color: var(--accent);">🔑 激活码管理</h3>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="licenseSearch" placeholder="搜索激活码..." 
                           style="padding: 8px 15px; background: var(--bg-card); border: 1px solid var(--border); 
                                  border-radius: 8px; color: var(--text-primary); width: 180px;"
                           onkeypress="if(event.keyCode===13)searchLicenses()">
                    <select id="licBillingFilter" onchange="applyLicenseFilters()" 
                            style="padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 13px;">
                        <option value="">全部计费</option>
                        <option value="per_use">按次数</option>
                        <option value="time_based">按时间</option>
                        <option value="unlimited">无限制</option>
                    </select>
                    <select id="licStatusFilter" onchange="applyLicenseFilters()" 
                            style="padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 13px;">
                        <option value="">全部状态</option>
                        <option value="active">已激活</option>
                        <option value="inactive">未激活</option>
                        <option value="expired">已过期</option>
                        <option value="revoked">已撤销</option>
                    </select>
                    <button onclick="searchLicenses()" class="btn btn-primary" style="padding: 8px 15px;">🔍 搜索</button>
                    <button onclick="clearLicenseFilters()" class="btn-page" style="padding: 8px 15px;">清除</button>
                    <button onclick="showCreateLicenseModal()" class="btn btn-primary" style="padding: 8px 15px; background: linear-gradient(135deg, #00ff88, #00cc6a);">
                        ➕ 创建激活码
                    </button>
                </div>
            </div>
            
            <!-- 激活码统计 -->
            <div class="license-stats overview-section" id="licenseStatsGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="stat-mini" style="background: var(--bg-card); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
                    <div style="color: var(--text-secondary); font-size: 12px;">总激活码</div>
                    <div style="color: var(--accent); font-size: 24px; font-weight: bold;" id="licStatTotal">-</div>
                </div>
                <div class="stat-mini" style="background: var(--bg-card); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
                    <div style="color: var(--text-secondary); font-size: 12px;">已激活</div>
                    <div style="color: var(--accent-green); font-size: 24px; font-weight: bold;" id="licStatActive">-</div>
                </div>
                <div class="stat-mini" style="background: var(--bg-card); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
                    <div style="color: var(--text-secondary); font-size: 12px;">活跃客户端</div>
                    <div style="color: #667eea; font-size: 24px; font-weight: bold;" id="licStatClients">-</div>
                </div>
                <div class="stat-mini" style="background: var(--bg-card); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
                    <div style="color: var(--text-secondary); font-size: 12px;">黑名单</div>
                    <div style="color: var(--accent-red); font-size: 24px; font-weight: bold;" id="licStatBlacklist">-</div>
                </div>
            </div>
            
            <!-- 子标签切换 -->
            <div style="display: flex; gap: 0; margin-bottom: 15px; border-bottom: 2px solid var(--border);">
                <button class="btn" id="licTabList" onclick="switchLicenseTab('list')" 
                        style="padding: 10px 20px; border-radius: 8px 8px 0 0; border: 2px solid var(--border); border-bottom: none; 
                               margin-bottom: -2px; background: var(--accent); color: #fff; font-weight: bold;">
                    激活码列表
                </button>
                <button class="btn" id="licTabCreate" onclick="switchLicenseTab('create')" 
                        style="padding: 10px 20px; border-radius: 8px 8px 0 0; border: 2px solid var(--border); border-bottom: none; 
                               margin-bottom: -2px; background: var(--bg-card); color: var(--text-secondary);">
                    创建记录
                </button>
                <button class="btn" id="licTabUsage" onclick="switchLicenseTab('usage')" 
                        style="padding: 10px 20px; border-radius: 8px 8px 0 0; border: 2px solid var(--border); border-bottom: none; 
                               margin-bottom: -2px; background: var(--bg-card); color: var(--text-secondary);">
                    使用记录
                </button>
            </div>
            
            <!-- 激活码列表 -->
            <div id="licPanelList">
                <div class="table-container license-table-wrap" style="overflow: auto; max-height: max(300px, calc(100vh - 500px));">
                    <table>
                        <thead>
                            <tr>
                                <th>激活码</th>
                                <th>产品</th>
                                <th>计费模式</th>
                                <th class="sortable" onclick="toggleLicenseSort()" style="cursor: pointer; user-select: none;">
                                    剩余 <span id="licSortIcon" style="font-size: 12px;">⇅</span>
                                </th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="licenseTable">
                            <tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="licensePagination" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;"></div>
            </div>
            
            <!-- 创建记录 -->
            <div id="licPanelCreate" style="display: none;">
                <div class="table-container license-table-wrap" style="overflow: auto; max-height: max(300px, calc(100vh - 500px));">
                    <table>
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>激活码</th>
                                <th>产品</th>
                                <th>计费模式</th>
                                <th>详情</th>
                                <th>操作人</th>
                            </tr>
                        </thead>
                        <tbody id="licCreateLogsTable">
                            <tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="licCreateLogsPagination" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;"></div>
            </div>
            
            <!-- 使用记录 -->
            <div id="licPanelUsage" style="display: none;">
                <div class="table-container license-table-wrap" style="overflow: auto; max-height: max(300px, calc(100vh - 500px));">
                    <table>
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>激活码</th>
                                <th>操作</th>
                                <th>详情</th>
                                <th>操作人</th>
                            </tr>
                        </thead>
                        <tbody id="licUsageLogsTable">
                            <tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="licUsageLogsPagination" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;"></div>
            </div>
        </div>
        
        <!-- 数据库管理 -->
        <div class="panel" id="database">
            <!-- 二级密码验证提示 -->
            <div id="dbAuthOverlay" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px;">
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 40px; max-width: 400px; width: 100%; text-align: center;">
                    <h3 style="color: var(--accent); margin-bottom: 10px;">数据库操作验证</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 25px; font-size: 14px;">
                        数据库操作需要二级密码验证<br>验证通过后有效期30分钟
                    </p>
                    <button onclick="showDbAuthModal()" class="btn btn-primary" 
                            style="padding: 12px 40px; font-size: 15px; font-weight: bold;">
                        验证密码
                    </button>
                </div>
            </div>
            
            <!-- 数据库操作界面（验证后显示） -->
            <div id="dbContent" style="display: none;">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                    <select id="dbTableSelect" onchange="loadTableData()" style="padding: 10px 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 200px;">
                        <option value="">选择表...</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadTableData()" style="padding: 10px 20px;">🔄 刷新</button>
                    <button class="btn btn-primary" onclick="showAddRowModal()" style="padding: 10px 20px;">➕ 新增</button>
                    <button class="btn btn-danger" onclick="showSqlModal()" style="padding: 10px 20px;">📝 执行SQL</button>
                    <span id="dbRowCount" style="color: var(--text-secondary); font-size: 14px; margin-left: auto;"></span>
                    <button class="btn" onclick="lockDatabase()" style="padding: 10px 20px; background: var(--bg-secondary);">🔒 锁定</button>
                </div>
                
                <div class="table-container" style="overflow: auto; max-height: max(300px, calc(100vh - 400px));">
                    <table id="dbTable" style="min-width: 100%;">
                        <thead id="dbTableHead">
                            <tr><th>请先选择一个表</th></tr>
                        </thead>
                        <tbody id="dbTableBody">
                            <tr><td style="text-align: center; color: var(--text-secondary); padding: 40px;">从上方下拉菜单选择要查看的表</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div id="dbPagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;"></div>
            </div>
        </div>
        
        <!-- 设置 -->
        <div class="panel" id="settings">
            <div style="max-width: 600px;">
                <h3 style="margin-bottom: 20px; color: var(--accent);">⚙️ 系统设置</h3>
                
                <!-- 修改密码 -->
                <div style="background: var(--bg-card); border-radius: 12px; padding: 25px; border: 1px solid var(--border); margin-bottom: 20px;">
                    <h4 style="margin-bottom: 20px; color: var(--text-primary);">🔐 修改管理员密码</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">当前密码</label>
                        <input type="password" id="currentPassword" placeholder="输入当前密码" 
                               style="width: 100%; padding: 12px 15px; background: var(--bg-primary); border: 1px solid var(--border); 
                                      border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">新密码</label>
                        <input type="password" id="newPassword" placeholder="输入新密码（至少6位）" 
                               style="width: 100%; padding: 12px 15px; background: var(--bg-primary); border: 1px solid var(--border); 
                                      border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">确认新密码</label>
                        <input type="password" id="confirmPassword" placeholder="再次输入新密码" 
                               style="width: 100%; padding: 12px 15px; background: var(--bg-primary); border: 1px solid var(--border); 
                                      border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--accent-yellow); font-size: 14px;">🔑 二级密码（必填）</label>
                        <input type="password" id="secondaryPasswordForChange" placeholder="输入二级密码以确认操作" 
                               style="width: 100%; padding: 12px 15px; background: var(--bg-primary); border: 1px solid var(--accent-yellow); 
                                      border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                    </div>
                    
                    <button onclick="changePassword()" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        🔄 修改密码
                    </button>
                    
                    <div id="passwordMsg" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                </div>
                
                <!-- 子管理员管理（仅系统总管理可见） -->
                <div id="subAdminSection" style="display: none;">
                    <div style="background: linear-gradient(135deg, var(--bg-card), #1e2a4a); border-radius: 12px; padding: 25px; border: 1px solid #667eea; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 20px; color: #667eea; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">👥</span> 子管理员管理
                            <span id="subAdminCount" style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">（仅系统总管理可操作）</span>
                        </h4>
                        
                        <!-- 子管理员列表 -->
                        <div id="subAdminList" style="margin-bottom: 20px;">
                            <span style="color: var(--text-secondary);">加载中...</span>
                        </div>
                        
                        <!-- 添加/更新子管理员 -->
                        <div style="background: var(--bg-primary); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="margin-bottom: 12px; color: var(--accent); font-size: 14px; font-weight: bold;">➕ 添加/更新子管理员</div>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 150px;">
                                    <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px;">名称</label>
                                    <input type="text" id="newSubAdminName" placeholder="子管理员名称（如：运营1号）" 
                                           style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); 
                                                  border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                </div>
                                <div style="flex: 1; min-width: 150px;">
                                    <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px;">登录密码</label>
                                    <input type="password" id="newSubAdminPassword" placeholder="至少6位" 
                                           style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); 
                                                  border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 150px;">
                                    <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 12px;">系统总管理员密码</label>
                                    <input type="password" id="subAdminSuperPassword" placeholder="验证身份" 
                                           style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); 
                                                  border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                </div>
                                <div style="flex: 1; min-width: 150px;">
                                    <label style="display: block; margin-bottom: 6px; color: var(--accent-yellow); font-size: 12px;">🔑 二级密码</label>
                                    <input type="password" id="subAdminSecondaryPassword" placeholder="确认操作" 
                                           style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--accent-yellow); 
                                                  border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="setSubAdmin()" class="btn btn-primary" style="flex: 1; padding: 10px; min-width: 140px;">
                                    ✅ 添加/更新子管理员
                                </button>
                                <button onclick="kickAllSubAdmins()" style="padding: 10px 16px; background: var(--bg-secondary); color: var(--accent-yellow); border: 1px solid rgba(255,165,2,0.3); border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    踢出全部
                                </button>
                            </div>
                        </div>
                        
                        <div id="subAdminMsg" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    </div><!-- 主内容结束 -->
    
    <!-- 封禁弹窗 -->
    <div class="modal" id="banModal">
        <div class="modal-content">
            <h3>🚫 封禁确认</h3>
            <p style="margin-bottom: 15px; color: var(--text-secondary);">
                确定要封禁 <strong id="banTarget" style="color: var(--accent-red);"></strong> 吗？
            </p>
            <input type="text" id="banReason" placeholder="封禁原因（可选）">
            <div class="modal-buttons">
                <button class="btn" onclick="closeBanModal()" style="background: var(--bg-secondary);">取消</button>
                <button class="btn btn-danger" onclick="confirmBan()">确认封禁</button>
            </div>
        </div>
    </div>
    
    <!-- 解封弹窗 -->
    <div class="modal" id="unbanModal">
        <div class="modal-content">
            <h3>✅ 解封确认</h3>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">
                确定要解封 <strong id="unbanTarget" style="color: var(--accent-green);"></strong> 吗？
            </p>
            <div class="modal-buttons">
                <button class="btn" onclick="closeUnbanModal()" style="background: var(--bg-secondary);">取消</button>
                <button class="btn btn-success" onclick="confirmUnban()">确认解封</button>
            </div>
        </div>
    </div>
    
    <!-- 创建激活码弹窗 -->
    <div class="modal" id="createLicenseModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="flex-shrink: 0;">➕ 创建激活码</h3>
            
            <div style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">产品类型</label>
                    <select id="licProductId" style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                            border-radius: 8px; color: var(--text-primary);">
                        <option value="ak_admin_panel">管理面板 (ak_admin_panel)</option>
                        <option value="auto_sell_system">自动销售系统 (auto_sell_system)</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">计费模式</label>
                    <select id="licBillingMode" onchange="onBillingModeChange()" style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                            border-radius: 8px; color: var(--text-primary);">
                        <option value="unlimited">无限制 (unlimited)</option>
                        <option value="per_use">按次数 (per_use)</option>
                        <option value="time_based">按时间 (time_based)</option>
                    </select>
                </div>
                
                <div id="licMaxUsesRow" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">最大使用次数</label>
                    <input type="number" id="licMaxUses" value="100" min="1"
                           style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                                  border-radius: 8px; color: var(--text-primary);">
                </div>
                
                <div id="licUsageTimeRow" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">使用时长（天）</label>
                    <input type="number" id="licUsageTime" value="30" min="1" step="0.5"
                           style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                                  border-radius: 8px; color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">有效期（天）</label>
                    <input type="number" id="licExpiryDays" value="365" min="1" 
                           style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                                  border-radius: 8px; color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">创建数量</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="licBatchCount" value="1" min="1" max="100" 
                               style="flex: 1; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                                      border-radius: 8px; color: var(--text-primary);">
                        <span style="color: var(--text-secondary); font-size: 12px; white-space: nowrap;">最多100个</span>
                    </div>
                </div>
                
                <div id="createLicenseMsg" style="margin-bottom: 15px; padding: 10px; border-radius: 6px; display: none; max-height: 150px; overflow-y: auto;"></div>
                
                <!-- 创建进度 -->
                <div id="createLicenseProgress" style="display: none; margin-bottom: 15px;">
                    <div style="background: var(--bg-primary); border-radius: 6px; height: 6px; overflow: hidden;">
                        <div id="createProgressBar" style="height: 100%; background: var(--accent); width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="createProgressText" style="text-align: center; color: var(--text-secondary); font-size: 12px; margin-top: 5px;">0/0</div>
                </div>
            </div>
            
            <div class="modal-buttons" style="flex-shrink: 0;">
                <button class="btn-page" onclick="closeCreateLicenseModal()">取消</button>
                <button class="btn btn-primary" id="createLicenseBtn" onclick="doCreateLicense()">创建</button>
            </div>
        </div>
    </div>
    
    <!-- 激活码详情弹窗 -->
    <div class="modal" id="licenseDetailModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>📋 激活码详情</h3>
            <div id="licenseDetailContent" style="max-height: 400px; overflow-y: auto;">
                <!-- 内容由JS填充 -->
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="btn" onclick="closeLicenseDetailModal()" style="background: var(--bg-secondary);">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 数据库二级密码验证弹窗 -->
    <div class="modal" id="dbAuthModal">
        <div class="modal-content" style="max-width: 420px; text-align: center;">
            <h3 style="margin-bottom: 10px;">数据库操作验证</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                请输入二级密码以访问数据库操作<br>验证通过后有效期30分钟
            </p>
            <input type="password" id="dbSecondaryPassword" placeholder="请输入二级密码" 
                   onkeypress="if(event.keyCode===13)verifyDbPassword()"
                   style="width: 100%; padding: 14px 18px; background: var(--bg-primary); border: 1px solid var(--border); 
                          border-radius: 10px; color: var(--text-primary); font-size: 15px; margin-bottom: 10px; text-align: center;">
            <p id="dbAuthError" style="color: var(--accent-red); margin-bottom: 10px; font-size: 14px; display: none;"></p>
            <div class="modal-buttons">
                <button class="btn" onclick="closeDbAuthModal()" style="background: var(--bg-secondary);">取消</button>
                <button class="btn btn-primary" onclick="verifyDbPassword()">确定</button>
            </div>
        </div>
    </div>
    
    <!-- 会话失效提示弹窗 -->
    <div class="modal" id="sessionExpiredModal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="font-size: 40px; margin-bottom: 15px; line-height: 1;">⚠️</div>
            <h3 style="margin-bottom: 10px; color: var(--text-primary);">会话已失效</h3>
            <p id="sessionExpiredMsg" style="color: var(--text-secondary); margin-bottom: 25px; font-size: 14px; line-height: 1.6;">
                您的登录状态已过期，请重新登录
            </p>
            <div class="modal-buttons" style="justify-content: center;">
                <button class="btn btn-primary" onclick="confirmSessionExpired()" style="min-width: 120px;">重新登录</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        let ws = null;
        let banType = '';
        let banValue = '';
        let isLoggedIn = false;
        let currentUserRole = null;  // 当前用户权限
        let dashboardTimer = null;
        let activityItems = [];
        
        // 权限常量
        const ROLE_SUPER_ADMIN = 'super_admin';
        const ROLE_SUB_ADMIN = 'sub_admin';
        
        // 更新权限标识
        function updateRoleBadge(role, roleName) {
            const badge = document.getElementById('roleBadge');
            const icon = badge.querySelector('.role-icon');
            const text = document.getElementById('roleText');
            
            badge.classList.remove('super-admin', 'sub-admin');
            
            if (role === ROLE_SUPER_ADMIN) {
                badge.classList.add('super-admin');
                icon.textContent = '👑';
                text.textContent = roleName || '系统总管理';
            } else if (role === ROLE_SUB_ADMIN) {
                badge.classList.add('sub-admin');
                icon.textContent = '⭐';
                text.textContent = roleName || '子管理员';
            } else {
                icon.textContent = '❓';
                text.textContent = '未知权限';
            }
        }
        
        // 检查是否是系统总管理员
        function isSuperAdmin() {
            return currentUserRole === ROLE_SUPER_ADMIN;
        }
        
        // 显示模式切换
        let isCompactMode = false;
        function setViewMode(compact) {
            if (isCompactMode === compact) return;
            isCompactMode = compact;
            const fullBtn = document.getElementById('modeFullBtn');
            const compactBtn = document.getElementById('modeCompactBtn');
            const statsGrid = document.getElementById('statsGrid');
            const tabDashboard = document.getElementById('tabDashboard');
            const licenseStats = document.getElementById('licenseStatsGrid');
            const displayVal = isCompactMode ? 'none' : '';
            
            statsGrid.style.display = displayVal;
            tabDashboard.style.display = displayVal;
            if (licenseStats) licenseStats.style.display = displayVal;
            
            if (isCompactMode) {
                fullBtn.style.background = 'transparent';
                fullBtn.style.color = 'var(--text-secondary)';
                compactBtn.style.background = 'var(--accent)';
                compactBtn.style.color = 'white';
                if (tabDashboard.classList.contains('active')) {
                    document.querySelector('.tab[data-panel="online"]').click();
                }
            } else {
                fullBtn.style.background = 'var(--accent)';
                fullBtn.style.color = 'white';
                compactBtn.style.background = 'transparent';
                compactBtn.style.color = 'var(--text-secondary)';
            }
        }
        
        // ===== 移动端方向检测 =====
        function checkOrientation() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isPortrait = window.innerHeight > window.innerWidth;
            const rotateHint = document.getElementById('rotateHint');
            
            if (isMobile && isPortrait && window.innerWidth < 768) {
                rotateHint.style.display = 'flex';
            } else {
                rotateHint.style.display = 'none';
            }
        }
        
        // 监听方向变化
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', () => {
            setTimeout(checkOrientation, 100);
        });
        
        // 初始检测
        checkOrientation();
        
        // ===== 登录验证 =====
        function checkLogin() {
            const token = sessionStorage.getItem('admin_token');
            if (token) {
                isLoggedIn = true;
                currentUserRole = sessionStorage.getItem('admin_role');
                const roleName = sessionStorage.getItem('admin_role_name');
                showMainContent();
                updateRoleBadge(currentUserRole, roleName);
            }
        }
        
        async function doLogin() {
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            if (!password) {
                errorEl.textContent = '请输入密码';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    sessionStorage.setItem('admin_token', data.token);
                    sessionStorage.setItem('admin_role', data.role);
                    sessionStorage.setItem('admin_role_name', data.role_name);
                    isLoggedIn = true;
                    currentUserRole = data.role;
                    showMainContent();
                    updateRoleBadge(data.role, data.role_name);
                } else {
                    errorEl.textContent = data.message || '密码错误';
                    errorEl.style.display = 'block';
                    document.getElementById('loginPassword').value = '';
                }
            } catch (e) {
                errorEl.textContent = '连接服务器失败';
                errorEl.style.display = 'block';
            }
        }
        
        function showMainContent() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContent').classList.add('visible');
            // 非系统总管理员隐藏设置和数据库标签
            if (!isSuperAdmin()) {
                const settingsTab = document.querySelector('.tab[data-panel="settings"]');
                if (settingsTab) settingsTab.style.display = 'none';
                const dbTab = document.querySelector('.tab[data-panel="database"]');
                if (dbTab) dbTab.style.display = 'none';
            }
            // 初始化应用
            initApp();
        }
        
        function logout() {
            sessionStorage.removeItem('admin_token');
            sessionStorage.removeItem('admin_role');
            sessionStorage.removeItem('admin_role_name');
            isLoggedIn = false;
            currentUserRole = null;
            location.reload();
        }
        
        // 会话失效提示（主题风格弹窗）
        let sessionExpiredShown = false;
        function handleKickedOut(message) {
            if (sessionExpiredShown) return; // 防止重复弹窗
            sessionExpiredShown = true;
            document.getElementById('sessionExpiredMsg').textContent = message || '您的登录状态已过期，请重新登录';
            document.getElementById('sessionExpiredModal').style.display = 'flex';
        }
        
        function confirmSessionExpired() {
            document.getElementById('sessionExpiredModal').style.display = 'none';
            sessionExpiredShown = false;
            logout();
        }
        
        // 检查API响应是否为token失效
        function checkTokenValid(response) {
            if (response.status === 401) {
                handleKickedOut('您的登录状态已过期，请重新登录');
                return false;
            }
            return true;
        }
        
        // 页面加载时检查登录状态
        checkLogin();
        
        // 初始化WebSocket
        function initWebSocket() {
            // 先关闭已存在的连接，避免重复连接
            if (ws && ws.readyState !== WebSocket.CLOSED) {
                console.log('[Admin] 关闭旧WebSocket连接');
                ws.close();
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/admin/ws`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = '已连接';
            };
            
            ws.onclose = () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = '已断开';
                // 重连
                setTimeout(initWebSocket, 3000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }
        
        // 当前聊天用户
        let currentChatUser = null;
        let chatRefreshTimer = null;
        
        // 处理WebSocket消息
        function handleWebSocketMessage(data) {
            const time = data.data?.time || new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            
            if (data.type === 'new_login') {
                addLogItem(data.data);
                refreshStats();
                // 添加到活动流
                if (data.data.status === 'success') {
                    addActivityItem('success', '✅', `<strong>${data.data.username}</strong> 登录成功`, time);
                } else {
                    addActivityItem('failed', '❌', `<strong>${data.data.username}</strong> 登录失败`, time);
                }
                // 如果有资产数据，也刷新用户列表
                if (data.data.assets) {
                    loadUsers();
                }
            } else if (data.type === 'asset_update') {
                addAssetLogItem(data.data);
                loadUsers();
                refreshStats();
                addActivityItem('info', '💰', `<strong>${data.data.username}</strong> 资产已更新`, time);
            } else if (data.type === 'user_banned' || data.type === 'user_unbanned') {
                loadUsers();
                loadBanlist();
                refreshStats();
                const action = data.type === 'user_banned' ? '已封禁' : '已解封';
                addActivityItem(data.type === 'user_banned' ? 'failed' : 'success', 
                    data.type === 'user_banned' ? '🚫' : '✅', 
                    `用户 <strong>${data.data?.value || ''}</strong> ${action}`, time);
            } else if (data.type === 'ip_banned' || data.type === 'ip_unbanned') {
                loadIPs();
                loadBanlist();
                refreshStats();
            } else if (data.type === 'user_online') {
                loadOnlineUsers();
                addActivityItem('success', '🟢', `<strong>${data.data?.username || ''}</strong> 上线`, time);
            } else if (data.type === 'user_offline') {
                loadOnlineUsers();
                addActivityItem('info', '⚪', `<strong>${data.data?.username || ''}</strong> 离线`, time);
            } else if (data.type === 'chat_message') {
                if (data.data.username === currentChatUser) {
                    if (!data.data.is_admin) {
                        addChatMessage(data.data.content, false, data.data.time);
                    }
                }
                if (!data.data.is_admin) {
                    addChatLogItem(data.data);
                    addActivityItem('info', '💬', `<strong>${data.data.username}</strong> 发送消息`, time);
                }
            }
        }
        
        // 添加聊天日志（已移除实时日志面板，此函数仅作占位）
        function addChatLogItem(data) {
            // liveLog 面板已移除，不再显示实时日志
            console.log('[Chat]', data.username, ':', data.content);
        }
        
        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 添加资产更新日志（已移除实时日志面板，此函数仅作占位）
        function addAssetLogItem(data) {
            // liveLog 面板已移除，不再显示实时日志
            console.log('[Asset Update]', data.username, 'AK:', data.ace_count, 'EP:', data.ep);
        }
        
        // 添加日志项（已移除实时日志面板，此函数仅作占位）
        function addLogItem(data) {
            // liveLog 面板已移除，不再显示实时日志
            console.log('[Login]', data.username, data.status);
        }
        
        // 加载统计
        async function refreshStats() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/stats`);
                const data = await res.json();
                document.getElementById('statUsers').textContent = data.total_users;
                document.getElementById('statToday').textContent = data.today_logins;
                document.getElementById('statLogins').textContent = data.total_logins;
                document.getElementById('statIPs').textContent = data.total_ips;
                document.getElementById('statBanned').textContent = data.banned_count;
                document.getElementById('statTotalAce').textContent = formatNumber(data.total_ace);
                document.getElementById('statTotalEP').textContent = formatNumber(data.total_ep);
                document.getElementById('statTotalSP').textContent = formatNumber(data.total_sp);
                document.getElementById('statTotalRP').textContent = formatNumber(data.total_rp);
                document.getElementById('statTotalTP').textContent = formatNumber(data.total_tp);
            } catch (e) {
                console.error('加载统计失败', e);
            }
        }
        
        // 存储原始数据用于搜索
        let usageDataCache = [];
        let usersDataCache = [];
        
        // 加载使用情况（user_stats表 - 所有登录尝试）
        async function loadUsage() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/usage?limit=500`);
                const data = await res.json();
                usageDataCache = data || [];
                renderUsageTable(usageDataCache);
            } catch (e) {
                console.error('加载使用情况失败', e);
            }
        }
        
        // 渲染使用情况表格
        function renderUsageTable(users) {
            const tbody = document.getElementById('usageTable');
            document.getElementById('usageSearchCount').textContent = `共 ${users.length} 条记录`;
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">暂无数据</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td style="color: var(--accent-yellow); font-family: monospace; font-size: 12px;">${user.password || '-'}</td>
                    <td>${user.login_count || 0}</td>
                    <td>
                        <span class="badge ${user.is_banned ? 'danger' : 'success'}">
                            ${user.is_banned ? '已封禁' : '正常'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
        
        // 搜索使用情况
        function searchUsage() {
            const keyword = document.getElementById('usageSearchInput').value.trim().toLowerCase();
            if (!keyword) {
                renderUsageTable(usageDataCache);
                return;
            }
            const filtered = usageDataCache.filter(user => 
                user.username && user.username.toLowerCase().includes(keyword)
            );
            renderUsageTable(filtered);
        }
        
        // 清除使用情况搜索
        function clearUsageSearch() {
            document.getElementById('usageSearchInput').value = '';
            renderUsageTable(usageDataCache);
        }
        
        // 用户管理分页相关
        let usersCurrentPage = 0;
        const usersPageSize = 100;
        let usersTotalCount = 0;
        let usersTotalPages = 0;
        let usersIsLoadAll = false;
        let usersSearchKeyword = '';
        
        // 加载用户列表（user_assets表 - 只显示资产信息）
        async function loadUsers(page = 0) {
            usersCurrentPage = page;
            const offset = page * usersPageSize;
            
            try {
                let url;
                if (usersIsLoadAll) {
                    url = `${API_BASE}/admin/api/assets?limit=99999&offset=0`;
                } else {
                    url = `${API_BASE}/admin/api/assets?limit=${usersPageSize}&offset=${offset}`;
                }
                if (usersSearchKeyword) {
                    url += `&search=${encodeURIComponent(usersSearchKeyword)}`;
                }
                
                const res = await fetch(url);
                const data = await res.json();
                
                const rows = data.rows || [];
                usersTotalCount = data.total || 0;
                usersDataCache = rows;
                
                if (usersIsLoadAll) {
                    usersTotalPages = 1;
                    usersCurrentPage = 0;
                } else {
                    usersTotalPages = Math.ceil(usersTotalCount / usersPageSize) || 1;
                }
                
                renderUsersTable(usersDataCache);
                updateUsersPagination();
            } catch (e) {
                console.error('加载用户失败', e);
            }
        }
        
        // 渲染用户表格
        function renderUsersTable(users, keepSortInfo = false) {
            const tbody = document.getElementById('usersTable');
            const sortInfo = usersSortField ? ` (按${getSortFieldName(usersSortField)}${usersSortAsc ? '↑' : '↓'})` : '';
            const countText = usersIsLoadAll 
                ? `共 ${usersTotalCount} 条记录（已全部加载）` 
                : `共 ${usersTotalCount} 条记录，当前显示 ${users.length} 条`;
            document.getElementById('usersSearchCount').textContent = countText + (keepSortInfo ? sortInfo : '');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--text-secondary);">暂无数据</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td style="color: var(--accent);">${formatNumber(user.ace_count)}</td>
                    <td>${formatNumber(user.total_ace)}</td>
                    <td style="color: var(--accent-green);">${formatNumber(user.ep)}</td>
                    <td style="color: #ff6b9d;">${formatNumber(user.sp)}</td>
                    <td style="color: #f7b731;">${formatNumber(user.rp)}</td>
                    <td style="color: #a55eea;">${formatNumber(user.tp)}</td>
                    <td style="color: var(--accent-yellow);">${formatNumber(user.weekly_money)}</td>
                    <td><span class="badge warning">${user.honor_name || '-'}</span></td>
                    <td style="color: var(--text-secondary); font-size: 11px;">${user.updated_at || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="showBanModal('user', '${user.username}')" style="padding: 4px 12px; font-size: 12px;">封禁</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // 更新分页控件
        function updateUsersPagination() {
            const pagination = document.getElementById('usersPagination');
            if (usersIsLoadAll) {
                pagination.style.display = 'none';
                return;
            }
            pagination.style.display = 'flex';
            
            document.getElementById('usersFirstBtn').disabled = usersCurrentPage <= 0;
            document.getElementById('usersPrevBtn').disabled = usersCurrentPage <= 0;
            document.getElementById('usersNextBtn').disabled = usersCurrentPage >= usersTotalPages - 1;
            document.getElementById('usersLastBtn').disabled = usersCurrentPage >= usersTotalPages - 1;
            document.getElementById('usersPageInfo').textContent = `第 ${usersCurrentPage + 1} / ${usersTotalPages} 页`;
        }
        
        // 跳转到指定页
        function usersGoPage(page) {
            if (page < 0 || page >= usersTotalPages) return;
            loadUsers(page);
        }
        
        // 搜索用户（从数据库查询，带防抖）
        let usersSearchTimer = null;
        function searchUsers() {
            clearTimeout(usersSearchTimer);
            usersSearchTimer = setTimeout(() => {
                usersSearchKeyword = document.getElementById('usersSearchInput').value.trim();
                usersCurrentPage = 0;
                loadUsers(0);
            }, 300);
        }
        
        // 清除用户搜索
        function clearUsersSearch() {
            document.getElementById('usersSearchInput').value = '';
            usersSearchKeyword = '';
            usersCurrentPage = 0;
            loadUsers(0);
        }
        
        // 加载全部数据切换
        function onUsersLoadAllChange() {
            usersIsLoadAll = document.getElementById('usersLoadAll').checked;
            usersCurrentPage = 0;
            loadUsers(0);
        }
        
        // 用户表格排序相关
        let usersSortField = null;
        let usersSortAsc = true;
        
        // 排序用户表格（前端排序当前页数据）
        function sortUsersBy(field) {
            // 切换排序方向
            if (usersSortField === field) {
                usersSortAsc = !usersSortAsc;
            } else {
                usersSortField = field;
                usersSortAsc = false;  // 默认降序（数值大的在前）
            }
            
            // 更新排序图标
            updateSortIcons(field, usersSortAsc);
            
            let dataToSort = [...usersDataCache];
            
            // 排序
            dataToSort.sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                
                // 处理 null/undefined
                if (valA == null) valA = field === 'updated_at' || field === 'honor_name' ? '' : 0;
                if (valB == null) valB = field === 'updated_at' || field === 'honor_name' ? '' : 0;
                
                // 数值字段
                if (typeof valA === 'number' || !isNaN(parseFloat(valA))) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                }
                
                // 比较
                if (valA < valB) return usersSortAsc ? -1 : 1;
                if (valA > valB) return usersSortAsc ? 1 : -1;
                return 0;
            });
            
            renderUsersTable(dataToSort, true);
        }
        
        // 更新排序图标
        function updateSortIcons(activeField, isAsc) {
            const fields = ['ace_count', 'total_ace', 'ep', 'sp', 'rp', 'tp', 'weekly_money', 'honor_name', 'updated_at'];
            fields.forEach(f => {
                const icon = document.getElementById('sort-' + f);
                const th = icon?.parentElement;
                if (icon && th) {
                    th.classList.remove('asc', 'desc');
                    if (f === activeField) {
                        icon.textContent = isAsc ? '↑' : '↓';
                        th.classList.add(isAsc ? 'asc' : 'desc');
                    } else {
                        icon.textContent = '⇅';
                    }
                }
            });
        }
        
        // 获取排序字段中文名
        function getSortFieldName(field) {
            const names = {
                'ace_count': '主账户AK',
                'total_ace': '子账户AK',
                'ep': 'EP',
                'sp': 'SP',
                'rp': 'RP',
                'tp': 'TP',
                'weekly_money': '本周收益',
                'honor_name': '等级',
                'updated_at': '更新时间'
            };
            return names[field] || field;
        }
        
        // 加载IP列表
        async function loadIPs() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/ips`);
                const data = await res.json();
                const tbody = document.getElementById('ipsTable');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">暂无数据</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(ip => `
                    <tr>
                        <td><strong>${ip.ip_address}</strong></td>
                        <td>${ip.request_count}</td>
                        <td>${ip.first_seen || '-'}</td>
                        <td>${ip.last_seen || '-'}</td>
                        <td>
                            <span class="badge ${ip.is_banned ? 'danger' : 'success'}">
                                ${ip.is_banned ? '已封禁' : '正常'}
                            </span>
                        </td>
                        <td>
                            ${ip.is_banned 
                                ? `<button class="btn btn-success" onclick="unban('ip', '${ip.ip_address}')">解封</button>`
                                : `<button class="btn btn-danger" onclick="showBanModal('ip', '${ip.ip_address}')">封禁</button>`
                            }
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('加载IP失败', e);
            }
        }
        
        // 加载封禁列表
        async function loadBanlist() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/banlist`);
                const data = await res.json();
                const tbody = document.getElementById('banlistTable');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">暂无封禁</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(item => `
                    <tr>
                        <td><span class="badge ${item.ban_type === 'ip' ? 'warning' : 'danger'}">${item.ban_type === 'ip' ? 'IP' : '用户'}</span></td>
                        <td><strong>${item.ban_value}</strong></td>
                        <td>${item.banned_at}</td>
                        <td>${item.banned_reason || '-'}</td>
                        <td>
                            <button class="btn btn-success" onclick="unban('${item.ban_type}', '${item.ban_value}')">解封</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('加载封禁列表失败', e);
            }
        }
        
        // 格式化数字
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return Number(num).toLocaleString('zh-CN', {maximumFractionDigits: 2});
        }
        
        // 加载在线用户
        // 页面路径 → 中文描述映射
        const PAGE_NAME_MAP = {
            '/pages/home.html': '位于首页',
            '/pages/ace.list.html': 'AK交易页面',
            '/pages/ep.list.html': 'EP交易界面',
            '/pages/center.html': '位于个人主页',
            '/pages/center/sell.ace.html': 'AK出售界面',
            '/pages/center/sell.ep.html': 'EP出售界面',
            '/pages/center/ep.out.html': 'EP转出界面',
            '/pages/center/ep.to.rp.html': 'EP转RP界面',
            '/pages/center/ep.to.sp.html': 'EP转SP界面',
            '/pages/center/rp.to.sp.html': 'RP转SP界面',
            '/pages/center/rp.out.html': 'RP转出界面',
            '/pages/center/rptp.out.html': 'TP+RP转出界面',
            '/pages/center/sub.account.html': '查看子账户',
            '/pages/center/my.friend.html': '查看附近玩家',
            '/pages/center/my.fans.list.html': '查看全球玩家表',
            '/pages/center/my.fans.tree.html': '查看全球玩家图',
            '/pages/center/records/rp.record.html': '查看RP记录',
            '/pages/center/records/sp.record.html': '查看SP记录',
            '/pages/center/records/ep.record.html': '查看EP记录',
            '/pages/center/records/tp.record.html': '查看TP记录',
            '/pages/center/profit.html': '查看收益明细',
            '/pages/center/records/ep.out.record.html': '查看EP转出记录',
            '/pages/center/records/ep.in.record.html': '查看EP转入记录',
            '/pages/center/business.center.html': '查看EP交易信息',
            '/pages/center/split.record.html': '查看拆分记录',
            '/pages/center/Summary_Record.html': '查看一键归集明细',
            '/pages/center/Donate_Record.html': '查看捐赠销毁记录',
            '/pages/center/Donate.html': '自愿捐赠界面',
            '/pages/center/google/activation.code.html': '查看谷歌激活码',
            '/pages/center/security/change.password.html': '修改登录密码',
            '/pages/center/security/change.pin.html': '修改交易密码',
            '/pages/center/security/reset.mnemonic.html': '重置助记词',
            '/pages/center/child/upgrade_record.html': '查看荣耀历程',
            '/pages/center/security.html': '账户安全界面'
        };
        
        function getPageName(path) {
            if (!path || path === '/') return '首页';
            return PAGE_NAME_MAP[path] || path;
        }
        
        async function loadOnlineUsers() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/online`);
                const data = await res.json();
                const tbody = document.getElementById('onlineTable');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">暂无在线用户</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(user => `
                    <tr>
                        <td>
                            <span style="display: inline-block; width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%; margin-right: 8px;"></span>
                            <strong>${user.username}</strong>
                        </td>
                        <td style="color: var(--text-secondary); font-size: 12px;">${getPageName(user.page)}</td>
                        <td style="color: var(--text-secondary); font-size: 12px;">${user.online_time}</td>
                        <td>
                            <button class="btn btn-primary" onclick="startChat('${user.username}')" style="padding: 4px 12px; font-size: 12px;">聊天</button>
                            <button class="btn btn-danger" onclick="showBanModal('user', '${user.username}')" style="padding: 4px 12px; font-size: 12px;">封禁</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('加载在线用户失败', e);
            }
        }
        
        // 刷新聊天记录
        async function refreshChatHistory() {
            if (!currentChatUser) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/chat/history/${currentChatUser}`);
                const messages = await res.json();
                
                // 重新渲染聊天记录
                const container = document.getElementById('chatMessages');
                const scrollAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
                
                container.innerHTML = '';
                messages.forEach(msg => {
                    addChatMessage(msg.content, msg.is_admin, msg.time);
                });
                
                // 如果之前在底部，保持在底部
                if (scrollAtBottom) {
                    container.scrollTop = container.scrollHeight;
                }
            } catch (e) {
                console.error('刷新聊天记录失败', e);
            }
        }
        
        // 开始聊天
        async function startChat(username) {
            // 清除旧的定时器
            if (chatRefreshTimer) {
                clearInterval(chatRefreshTimer);
            }
            
            currentChatUser = username;
            document.getElementById('chatTarget').textContent = username;
            document.getElementById('chatStatus').textContent = '在线';
            document.getElementById('chatStatus').style.color = 'var(--accent-green)';
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
            
            // 加载聊天历史
            await refreshChatHistory();
            
            // 每3秒刷新一次聊天记录（作为WebSocket的备份）
            chatRefreshTimer = setInterval(refreshChatHistory, 3000);
            
            document.getElementById('chatInput').focus();
        }
        
        // 添加聊天消息
        function addChatMessage(content, isAdmin, time) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.style.cssText = `
                margin-bottom: 12px;
                display: flex;
                flex-direction: column;
                ${isAdmin ? 'align-items: flex-end;' : 'align-items: flex-start;'}
            `;
            msg.innerHTML = `
                <div style="
                    padding: 10px 14px;
                    border-radius: 12px;
                    font-size: 14px;
                    max-width: 80%;
                    word-break: break-word;
                    display: inline-block;
                    ${isAdmin 
                        ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px;' 
                        : 'background: var(--bg-secondary); color: var(--text-primary); border-bottom-left-radius: 4px;'}
                ">${escapeHtml(content)}</div>
                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${time}</div>
            `;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }
        
        // 发送聊天消息
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content || !currentChatUser) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/chat/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentChatUser, content: content })
                });
                
                if (res.ok) {
                    // 立即添加管理员消息到聊天界面
                    const now = new Date();
                    const timeStr = now.toTimeString().split(' ')[0].substring(0, 5);
                    addChatMessage(content, true, timeStr);
                    input.value = '';
                } else {
                    alert('发送失败，用户可能已离线');
                }
            } catch (e) {
                alert('发送失败: ' + e.message);
            }
        }
        
        // 聊天输入框回车发送
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            document.getElementById('broadcastInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') broadcastMessage();
            });
        });
        
        // 群发消息
        async function broadcastMessage() {
            const input = document.getElementById('broadcastInput');
            const content = input.value.trim();
            if (!content) return;
            
            try {
                const response = await fetch('/admin/api/chat/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    input.value = '';
                    alert(`消息已发送给 ${result.sent_count} 个在线用户`);
                } else {
                    alert('发送失败');
                }
            } catch (e) {
                alert('发送失败: ' + e.message);
            }
        }
        
        // 显示封禁弹窗
        function showBanModal(type, value) {
            banType = type;
            banValue = value;
            document.getElementById('banTarget').textContent = `${type === 'ip' ? 'IP: ' : '用户: '}${value}`;
            document.getElementById('banReason').value = '';
            document.getElementById('banModal').classList.add('active');
        }
        
        function closeBanModal() {
            document.getElementById('banModal').classList.remove('active');
        }
        
        // 确认封禁
        async function confirmBan() {
            const reason = document.getElementById('banReason').value;
            try {
                await fetch(`${API_BASE}/admin/api/ban/${banType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: banValue, reason: reason })
                });
                closeBanModal();
            } catch (e) {
                alert('封禁失败: ' + e.message);
            }
        }
        
        // 解封相关变量
        let unbanType = '';
        let unbanValue = '';
        
        // 显示解封弹窗
        function showUnbanModal(type, value) {
            unbanType = type;
            unbanValue = value;
            document.getElementById('unbanTarget').textContent = `${type === 'ip' ? 'IP: ' : '用户: '}${value}`;
            document.getElementById('unbanModal').classList.add('active');
        }
        
        function closeUnbanModal() {
            document.getElementById('unbanModal').classList.remove('active');
        }
        
        // 确认解封
        async function confirmUnban() {
            try {
                // API type 映射：username -> user
                const apiType = unbanType === 'username' ? 'user' : unbanType;
                const res = await fetch(`${API_BASE}/admin/api/unban/${apiType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: unbanValue })
                });
                if (res.ok) {
                    closeUnbanModal();
                    // 刷新相关列表
                    loadBanlist();
                    if (unbanType === 'ip') {
                        loadIPs();
                    } else {
                        loadUsers();
                        loadUsage();
                    }
                    refreshStats();
                } else {
                    const data = await res.json();
                    alert('解封失败: ' + (data.detail || '未知错误'));
                }
            } catch (e) {
                alert('解封失败: ' + e.message);
            }
        }
        
        // 兼容旧的 unban 调用
        function unban(type, value) {
            showUnbanModal(type, value);
        }
        
        // 修改密码
        async function changePassword() {
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;
            const secondaryPwd = document.getElementById('secondaryPasswordForChange').value;
            const msgDiv = document.getElementById('passwordMsg');
            
            // 验证
            if (!currentPwd || !newPwd || !confirmPwd || !secondaryPwd) {
                showPasswordMsg('请填写所有字段（包括二级密码）', 'error');
                return;
            }
            
            if (newPwd.length < 6) {
                showPasswordMsg('新密码至少需要6位', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                showPasswordMsg('两次输入的新密码不一致', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/change_password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPwd,
                        new_password: newPwd,
                        secondary_password: secondaryPwd
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showPasswordMsg('✅ 密码修改成功！', 'success');
                    // 清空输入框
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    document.getElementById('secondaryPasswordForChange').value = '';
                } else {
                    showPasswordMsg('❌ ' + (data.message || '修改失败'), 'error');
                }
            } catch (e) {
                showPasswordMsg('❌ 网络错误: ' + e.message, 'error');
            }
        }
        
        function showPasswordMsg(msg, type) {
            const msgDiv = document.getElementById('passwordMsg');
            msgDiv.style.display = 'block';
            msgDiv.textContent = msg;
            msgDiv.style.background = type === 'success' ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 71, 87, 0.1)';
            msgDiv.style.color = type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)';
            msgDiv.style.border = `1px solid ${type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)'}`;
            
            if (type === 'success') {
                setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
            }
        }
        
        // ===== 子管理员管理 =====
        
        let subAdminStatusTimer = null;
        
        // 启动子管理员状态定时刷新
        function startSubAdminStatusRefresh() {
            if (!isSuperAdmin()) return;
            stopSubAdminStatusRefresh();
            subAdminStatusTimer = setInterval(loadSubAdminStatus, 10000);
        }
        
        // 停止子管理员状态定时刷新
        function stopSubAdminStatusRefresh() {
            if (subAdminStatusTimer) {
                clearInterval(subAdminStatusTimer);
                subAdminStatusTimer = null;
            }
        }
        
        // 显示子管理员消息
        function showSubAdminMsg(msg, type) {
            const msgDiv = document.getElementById('subAdminMsg');
            msgDiv.style.display = 'block';
            msgDiv.textContent = msg;
            msgDiv.style.background = type === 'success' ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 71, 87, 0.1)';
            msgDiv.style.color = type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)';
            msgDiv.style.border = `1px solid ${type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)'}`;
            
            if (type === 'success') {
                setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
            }
        }
        
        // 加载子管理员状态
        async function loadSubAdminStatus() {
            if (!isSuperAdmin()) {
                document.getElementById('subAdminSection').style.display = 'none';
                return;
            }
            
            document.getElementById('subAdminSection').style.display = 'block';
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin`);
                const data = await res.json();
                
                const listDiv = document.getElementById('subAdminList');
                const countSpan = document.getElementById('subAdminCount');
                const subAdmins = data.sub_admins || [];
                
                countSpan.textContent = `（共 ${subAdmins.length} 个子管理员）`;
                
                if (subAdmins.length === 0) {
                    listDiv.innerHTML = `
                        <div style="padding: 20px; text-align: center; background: var(--bg-primary); border-radius: 8px; border: 1px dashed var(--border);">
                            <span style="color: var(--text-secondary); font-size: 14px;">暂无子管理员，请在下方添加</span>
                        </div>
                    `;
                    return;
                }
                
                listDiv.innerHTML = subAdmins.map(sub => {
                    const onlineDot = sub.is_online 
                        ? `<span style="width: 10px; height: 10px; background: var(--accent-green); border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite;"></span>`
                        : `<span style="width: 10px; height: 10px; background: #555; border-radius: 50%; display: inline-block;"></span>`;
                    const statusText = sub.is_online 
                        ? `<span style="color: var(--accent-green); font-size: 12px;">在线 · ${sub.login_time || ''}</span>`
                        : `<span style="color: var(--text-secondary); font-size: 12px;">离线</span>`;
                    
                    return `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: var(--bg-primary); 
                                    border-radius: 8px; border: 1px solid ${sub.is_online ? 'rgba(0,255,136,0.3)' : 'var(--border)'}; margin-bottom: 8px;">
                            ${onlineDot}
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: bold; color: var(--text-primary); font-size: 14px;">⭐ ${sub.name}</div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                    ${statusText}
                                    <span style="color: var(--text-secondary); font-size: 11px;">密码: ${sub.password_hint}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                <button onclick="kickOneSubAdmin('${sub.name}')" style="padding: 4px 10px; font-size: 12px; background: var(--bg-secondary); color: var(--accent-yellow); border: 1px solid rgba(255,165,2,0.3); border-radius: 4px; cursor: pointer;">踢出</button>
                                <button onclick="deleteOneSubAdmin('${sub.name}')" style="padding: 4px 10px; font-size: 12px; background: var(--bg-secondary); color: var(--accent-red); border: 1px solid rgba(255,71,87,0.3); border-radius: 4px; cursor: pointer;">删除</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('加载子管理员状态失败', e);
            }
        }
        
        // 添加/更新子管理员
        async function setSubAdmin() {
            const subName = document.getElementById('newSubAdminName').value.trim();
            const newSubPassword = document.getElementById('newSubAdminPassword').value;
            const superPassword = document.getElementById('subAdminSuperPassword').value;
            const secondaryPassword = document.getElementById('subAdminSecondaryPassword').value;
            
            if (!subName || !newSubPassword || !superPassword || !secondaryPassword) {
                showSubAdminMsg('请填写所有字段', 'error');
                return;
            }
            
            if (newSubPassword.length < 6) {
                showSubAdminMsg('子管理员密码至少需要6位', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin/set`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_password: superPassword,
                        secondary_password: secondaryPassword,
                        sub_name: subName,
                        new_sub_password: newSubPassword
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showSubAdminMsg('✅ ' + data.message, 'success');
                    document.getElementById('newSubAdminName').value = '';
                    document.getElementById('newSubAdminPassword').value = '';
                    loadSubAdminStatus();
                } else {
                    showSubAdminMsg('❌ ' + (data.message || '设置失败'), 'error');
                }
            } catch (e) {
                showSubAdminMsg('❌ 网络错误: ' + e.message, 'error');
            }
        }
        
        // 踢出指定子管理员
        async function kickOneSubAdmin(name) {
            const superPassword = document.getElementById('subAdminSuperPassword').value;
            if (!superPassword) {
                showSubAdminMsg('请先在下方填写系统总管理员密码', 'error');
                return;
            }
            
            if (!confirm(`确定要踢出子管理员 [${name}] 吗？`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin/kick`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_password: superPassword, sub_name: name })
                });
                const data = await res.json();
                if (data.success) {
                    showSubAdminMsg('✅ ' + data.message, 'success');
                    loadSubAdminStatus();
                } else {
                    showSubAdminMsg('❌ ' + (data.message || '操作失败'), 'error');
                }
            } catch (e) {
                showSubAdminMsg('❌ 网络错误: ' + e.message, 'error');
            }
        }
        
        // 踢出全部子管理员
        async function kickAllSubAdmins() {
            const superPassword = document.getElementById('subAdminSuperPassword').value;
            if (!superPassword) {
                showSubAdminMsg('请填写系统总管理员密码', 'error');
                return;
            }
            
            if (!confirm('确定要踢出所有在线的子管理员吗？')) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin/kick`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_password: superPassword, sub_name: '' })
                });
                const data = await res.json();
                if (data.success) {
                    showSubAdminMsg('✅ ' + data.message, 'success');
                    loadSubAdminStatus();
                } else {
                    showSubAdminMsg('❌ ' + (data.message || '操作失败'), 'error');
                }
            } catch (e) {
                showSubAdminMsg('❌ 网络错误: ' + e.message, 'error');
            }
        }
        
        // 删除指定子管理员
        async function deleteOneSubAdmin(name) {
            const superPassword = document.getElementById('subAdminSuperPassword').value;
            const secondaryPassword = document.getElementById('subAdminSecondaryPassword').value;
            
            if (!superPassword || !secondaryPassword) {
                showSubAdminMsg('请先在下方填写系统总管理员密码和二级密码', 'error');
                return;
            }
            
            if (!confirm(`确定要删除子管理员 [${name}] 吗？删除后该管理员将无法登录。`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_password: superPassword,
                        secondary_password: secondaryPassword,
                        sub_name: name
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showSubAdminMsg('✅ ' + data.message, 'success');
                    loadSubAdminStatus();
                } else {
                    showSubAdminMsg('❌ ' + (data.message || '删除失败'), 'error');
                }
            } catch (e) {
                showSubAdminMsg('❌ 网络错误: ' + e.message, 'error');
            }
        }
        
        // 标签页切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel).classList.add('active');
                
                // 加载对应数据
                if (tab.dataset.panel === 'dashboard') {
                    startDashboard();
                } else {
                    stopDashboard();
                }
                if (tab.dataset.panel === 'online') loadOnlineUsers();
                if (tab.dataset.panel === 'usage') loadUsage();
                if (tab.dataset.panel === 'users') loadUsers();
                if (tab.dataset.panel === 'ips') loadIPs();
                if (tab.dataset.panel === 'banlist') loadBanlist();
                if (tab.dataset.panel === 'license') {
                    loadLicenseStats();
                    loadLicenses(0);
                }
                if (tab.dataset.panel === 'database') {
                    // 检查数据库授权状态
                    checkDbAuth().then(authed => {
                        if (authed) loadDbTables();
                    });
                }
                if (tab.dataset.panel === 'settings') {
                    // 加载子管理员状态（仅系统总管理可见）
                    loadSubAdminStatus();
                    // 启动定时刷新（每10秒刷新一次）
                    startSubAdminStatusRefresh();
                } else {
                    // 离开设置页面时停止刷新
                    stopSubAdminStatusRefresh();
                }
            });
        });
        
        // 刷新所有数据
        function refreshAll() {
            refreshStats();
            loadUsers();
            loadIPs();
            loadBanlist();
        }
        
        // ===== 数据库管理功能 =====
        let dbCurrentTable = '';
        let dbCurrentPage = 0;
        let dbPageSize = 50;
        let dbSchema = [];
        let dbPkColumn = 'id';
        let dbAuthToken = null;  // 数据库操作Token
        
        // 获取数据库请求头（包含Token）
        function getDbHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-DB-Token': dbAuthToken || ''
            };
        }
        
        // 显示数据库验证弹窗
        function showDbAuthModal() {
            document.getElementById('dbAuthModal').style.display = 'flex';
            document.getElementById('dbSecondaryPassword').value = '';
            document.getElementById('dbAuthError').style.display = 'none';
            setTimeout(() => document.getElementById('dbSecondaryPassword').focus(), 100);
        }
        
        // 关闭数据库验证弹窗
        function closeDbAuthModal() {
            document.getElementById('dbAuthModal').style.display = 'none';
            document.getElementById('dbSecondaryPassword').value = '';
            document.getElementById('dbAuthError').style.display = 'none';
        }
        
        // 验证二级密码
        async function verifyDbPassword() {
            const password = document.getElementById('dbSecondaryPassword').value;
            const errorEl = document.getElementById('dbAuthError');
            
            if (!password) {
                errorEl.textContent = '请输入二级密码';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/db/auth`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: password })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    dbAuthToken = data.token;
                    // 保存到 sessionStorage
                    sessionStorage.setItem('db_auth_token', dbAuthToken);
                    // 关闭弹窗
                    closeDbAuthModal();
                    // 显示数据库操作界面
                    showDbContent();
                    // 加载表列表
                    loadDbTables();
                } else {
                    errorEl.textContent = '二级密码错误';
                    errorEl.style.display = 'block';
                    document.getElementById('dbSecondaryPassword').value = '';
                }
            } catch (e) {
                errorEl.textContent = '验证失败: ' + e.message;
                errorEl.style.display = 'block';
            }
        }
        
        // 显示数据库操作界面
        function showDbContent() {
            document.getElementById('dbAuthOverlay').style.display = 'none';
            document.getElementById('dbContent').style.display = 'block';
        }
        
        // 锁定数据库（清除Token）
        function lockDatabase() {
            dbAuthToken = null;
            sessionStorage.removeItem('db_auth_token');
            document.getElementById('dbAuthOverlay').style.display = 'flex';
            document.getElementById('dbContent').style.display = 'none';
            closeDbAuthModal();
        }
        
        // 检查并恢复Token
        async function checkDbAuth() {
            const savedToken = sessionStorage.getItem('db_auth_token');
            if (savedToken) {
                try {
                    const res = await fetch(`${API_BASE}/admin/api/db/verify`, {
                        headers: {'X-DB-Token': savedToken}
                    });
                    const data = await res.json();
                    if (data.valid) {
                        dbAuthToken = savedToken;
                        showDbContent();
                        return true;
                    }
                } catch (e) {
                    console.log('Token验证失败');
                }
            }
            // Token无效，显示验证界面
            lockDatabase();
            return false;
        }
        
        // 处理数据库API错误（Token过期时自动锁定）
        function handleDbError(res) {
            if (res.status === 403) {
                lockDatabase();
                alert('数据库操作授权已过期，请重新验证二级密码');
                return true;
            }
            return false;
        }
        
        // 加载表列表
        async function loadDbTables() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/db/tables`, {
                    headers: getDbHeaders()
                });
                if (handleDbError(res)) return;
                const tables = await res.json();
                const select = document.getElementById('dbTableSelect');
                select.innerHTML = '<option value="">选择表...</option>' + 
                    tables.map(t => `<option value="${t}">${t}</option>`).join('');
            } catch (e) {
                console.error('加载表列表失败', e);
            }
        }
        
        // 加载表数据
        async function loadTableData() {
            const table = document.getElementById('dbTableSelect').value;
            if (!table) return;
            
            dbCurrentTable = table;
            
            try {
                // 获取表结构
                const schemaRes = await fetch(`${API_BASE}/admin/api/db/schema/${table}`, {
                    headers: getDbHeaders()
                });
                if (handleDbError(schemaRes)) return;
                dbSchema = await schemaRes.json();
                
                // 找到主键列
                const pkCol = dbSchema.find(c => c.pk === 1);
                dbPkColumn = pkCol ? pkCol.name : dbSchema[0]?.name || 'id';
                
                // 获取数据
                const dataRes = await fetch(`${API_BASE}/admin/api/db/query/${table}?limit=${dbPageSize}&offset=${dbCurrentPage * dbPageSize}`, {
                    headers: getDbHeaders()
                });
                if (handleDbError(dataRes)) return;
                const data = await dataRes.json();
                
                // 渲染表头
                const thead = document.getElementById('dbTableHead');
                thead.innerHTML = '<tr>' + 
                    dbSchema.map(c => `<th style="white-space: nowrap;">${c.name}<br><span style="font-size: 10px; color: var(--text-secondary);">${c.type}</span></th>`).join('') +
                    '<th>操作</th></tr>';
                
                // 渲染数据
                const tbody = document.getElementById('dbTableBody');
                if (data.rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="' + (dbSchema.length + 1) + '" style="text-align: center; color: var(--text-secondary); padding: 40px;">暂无数据</td></tr>';
                } else {
                    tbody.innerHTML = data.rows.map(row => {
                        const pkValue = row[dbPkColumn];
                        return '<tr>' + 
                            dbSchema.map(c => {
                                let val = row[c.name];
                                if (val === null) val = '<span style="color: #666;">NULL</span>';
                                else if (typeof val === 'string' && val.length > 50) val = val.substring(0, 50) + '...';
                                return `<td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${String(row[c.name] || '')}">${val}</td>`;
                            }).join('') +
                            `<td style="white-space: nowrap;">
                                <button class="btn btn-primary" onclick="showEditRowModal('${pkValue}')" style="padding: 4px 10px; font-size: 12px;">编辑</button>
                                <button class="btn btn-danger" onclick="deleteDbRow('${pkValue}')" style="padding: 4px 10px; font-size: 12px;">删除</button>
                            </td></tr>`;
                    }).join('');
                }
                
                // 显示行数
                document.getElementById('dbRowCount').textContent = `共 ${data.total} 条记录`;
                
                // 渲染分页
                const totalPages = Math.ceil(data.total / dbPageSize);
                const pagination = document.getElementById('dbPagination');
                if (totalPages > 1) {
                    let html = '';
                    html += `<button class="btn-page" onclick="dbGoPage(${dbCurrentPage - 1})" ${dbCurrentPage <= 0 ? 'disabled' : ''}>上一页</button>`;
                    html += `<span style="color: var(--text-secondary); line-height: 32px;">第 ${dbCurrentPage + 1} / ${totalPages} 页</span>`;
                    html += `<button class="btn-page" onclick="dbGoPage(${dbCurrentPage + 1})" ${dbCurrentPage >= totalPages - 1 ? 'disabled' : ''}>下一页</button>`;
                    pagination.innerHTML = html;
                } else {
                    pagination.innerHTML = '';
                }
            } catch (e) {
                console.error('加载表数据失败', e);
            }
        }
        
        function dbGoPage(page) {
            dbCurrentPage = page;
            loadTableData();
        }
        
        // 显示新增行弹窗
        function showAddRowModal() {
            if (!dbCurrentTable || dbSchema.length === 0) {
                alert('请先选择一个表');
                return;
            }
            
            const fields = dbSchema.filter(c => !c.pk || c.dflt_value !== null).map(c => `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 14px;">${c.name} (${c.type})${c.notnull ? ' *' : ''}</label>
                    <input type="text" id="dbAdd_${c.name}" placeholder="${c.dflt_value || ''}" 
                           style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                </div>
            `).join('');
            
            showModal('新增记录', fields, async () => {
                const data = {};
                dbSchema.forEach(c => {
                    if (c.pk && c.dflt_value === null) return; // 跳过自增主键
                    const val = document.getElementById(`dbAdd_${c.name}`)?.value;
                    if (val !== undefined && val !== '') data[c.name] = val;
                });
                
                try {
                    const res = await fetch(`${API_BASE}/admin/api/db/insert/${dbCurrentTable}`, {
                        method: 'POST',
                        headers: getDbHeaders(),
                        body: JSON.stringify(data)
                    });
                    if (handleDbError(res)) return;
                    const result = await res.json();
                    if (result.success) {
                        closeModal();
                        loadTableData();
                    } else {
                        alert('新增失败: ' + (result.detail || '未知错误'));
                    }
                } catch (e) {
                    alert('新增失败: ' + e.message);
                }
            });
        }
        
        // 显示编辑行弹窗
        async function showEditRowModal(pkValue) {
            if (!dbCurrentTable) return;
            
            // 获取当前行数据
            const res = await fetch(`${API_BASE}/admin/api/db/query/${dbCurrentTable}?limit=1&offset=0`, {
                headers: getDbHeaders()
            });
            if (handleDbError(res)) return;
            const data = await res.json();
            let row = data.rows.find(r => String(r[dbPkColumn]) === String(pkValue));
            
            if (!row) {
                // 重新查询
                const allRes = await fetch(`${API_BASE}/admin/api/db/sql`, {
                    method: 'POST',
                    headers: getDbHeaders(),
                    body: JSON.stringify({sql: `SELECT * FROM ${dbCurrentTable} WHERE ${dbPkColumn} = '${pkValue}'`})
                });
                if (handleDbError(allRes)) return;
                const allData = await allRes.json();
                if (allData.success && allData.result.length > 0) {
                    row = allData.result[0];
                }
            }
            
            const fields = dbSchema.map(c => `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 14px;">${c.name} (${c.type})${c.pk ? ' [主键]' : ''}</label>
                    <input type="text" id="dbEdit_${c.name}" value="${row?.[c.name] ?? ''}" ${c.pk ? 'readonly style="background: #333;"' : ''}
                           style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                </div>
            `).join('');
            
            showModal('编辑记录', fields, async () => {
                const data = {_pk_column: dbPkColumn, _pk_value: pkValue};
                dbSchema.forEach(c => {
                    if (c.pk) return; // 跳过主键
                    const val = document.getElementById(`dbEdit_${c.name}`)?.value;
                    if (val !== undefined) data[c.name] = val;
                });
                
                try {
                    const res = await fetch(`${API_BASE}/admin/api/db/update/${dbCurrentTable}`, {
                        method: 'PUT',
                        headers: getDbHeaders(),
                        body: JSON.stringify(data)
                    });
                    if (handleDbError(res)) return;
                    const result = await res.json();
                    if (result.success) {
                        closeModal();
                        loadTableData();
                    } else {
                        alert('更新失败: ' + (result.detail || '未知错误'));
                    }
                } catch (e) {
                    alert('更新失败: ' + e.message);
                }
            });
        }
        
        // 删除行
        async function deleteDbRow(pkValue) {
            if (!confirm(`确定要删除 ${dbPkColumn}=${pkValue} 的记录吗？`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/db/delete/${dbCurrentTable}?pk_column=${dbPkColumn}&pk_value=${pkValue}`, {
                    method: 'DELETE',
                    headers: getDbHeaders()
                });
                if (handleDbError(res)) return;
                const result = await res.json();
                if (result.success) {
                    loadTableData();
                } else {
                    alert('删除失败: ' + (result.detail || '未知错误'));
                }
            } catch (e) {
                alert('删除失败: ' + e.message);
            }
        }
        
        // 显示SQL执行弹窗
        function showSqlModal() {
            const content = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">输入SQL语句</label>
                    <textarea id="sqlInput" rows="5" placeholder="SELECT * FROM user_stats LIMIT 10" 
                              style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: monospace;"></textarea>
                </div>
                <div id="sqlResult" style="max-height: 300px; overflow: auto; background: var(--bg-primary); border-radius: 6px; padding: 10px; display: none;"></div>
            `;
            
            showModal('执行SQL', content, async () => {
                const sql = document.getElementById('sqlInput').value.trim();
                if (!sql) return;
                
                try {
                    const res = await fetch(`${API_BASE}/admin/api/db/sql`, {
                        method: 'POST',
                        headers: getDbHeaders(),
                        body: JSON.stringify({sql})
                    });
                    if (handleDbError(res)) { closeModal(); return; }
                    const result = await res.json();
                    const resultDiv = document.getElementById('sqlResult');
                    resultDiv.style.display = 'block';
                    
                    if (result.success) {
                        if (Array.isArray(result.result)) {
                            if (result.result.length === 0) {
                                resultDiv.innerHTML = '<span style="color: var(--text-secondary);">查询结果为空</span>';
                            } else {
                                const cols = Object.keys(result.result[0]);
                                resultDiv.innerHTML = `<table style="width: 100%; font-size: 12px;"><thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody>${result.result.map(r => `<tr>${cols.map(c => `<td>${r[c]}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
                            }
                        } else {
                            resultDiv.innerHTML = `<span style="color: var(--accent-green);">执行成功，影响 ${result.result.affected_rows} 行</span>`;
                            loadTableData();
                        }
                    } else {
                        resultDiv.innerHTML = `<span style="color: var(--accent-red);">错误: ${result.detail}</span>`;
                    }
                } catch (e) {
                    document.getElementById('sqlResult').innerHTML = `<span style="color: var(--accent-red);">错误: ${e.message}</span>`;
                    document.getElementById('sqlResult').style.display = 'block';
                }
            }, '执行');
        }
        
        // 通用弹窗函数
        function showModal(title, content, onConfirm, confirmText = '确定') {
            // 移除旧弹窗
            const oldModal = document.getElementById('dbModal');
            if (oldModal) oldModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'dbModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 12px; padding: 25px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 20px; color: var(--accent);">${title}</h3>
                    ${content}
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button class="btn" onclick="closeModal()" style="padding: 10px 20px; background: var(--bg-primary);">取消</button>
                        <button class="btn btn-primary" id="modalConfirmBtn" style="padding: 10px 20px;">${confirmText}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modalConfirmBtn').onclick = onConfirm;
        }
        
        function closeModal() {
            const modal = document.getElementById('dbModal');
            if (modal) modal.remove();
        }
        
        // ===== 激活码管理功能 =====
        let licenseCurrentPage = 0;
        let licensePageSize = 50;
        let licenseSearchTerm = '';
        let licenseAllData = []; // 当前页原始数据缓存
        let licenseTotalCount = 0;
        let licenseSortDir = 0; // 0=不排序, 1=升序, -1=降序
        let licenseBillingFilter = '';
        let licenseStatusFilter = '';
        
        // 获取带Token的请求头
        function getLicenseHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('admin_token') || ''}`
            };
        }
        
        // 加载激活码统计
        async function loadLicenseStats() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/license/statistics`, {
                    headers: getLicenseHeaders()
                });
                if (!checkTokenValid(res)) return;
                const data = await res.json();
                
                if (!data.error && data.data) {
                    document.getElementById('licStatTotal').textContent = data.data.total_licenses || 0;
                    document.getElementById('licStatActive').textContent = data.data.active_licenses || 0;
                    document.getElementById('licStatClients').textContent = data.data.active_clients || 0;
                    document.getElementById('licStatBlacklist').textContent = data.data.blacklist_count || 0;
                }
            } catch (e) {
                console.error('加载激活码统计失败', e);
            }
        }
        
        // 获取剩余值的数值（用于排序）
        function getLicenseRemainingValue(license) {
            if (license.billing_mode === 'unlimited') return Infinity;
            if (license.billing_mode === 'per_use') return license.remaining_uses || 0;
            if (license.billing_mode === 'time_based') return license.remaining_time || 0;
            return 0;
        }
        
        // 加载激活码列表
        async function loadLicenses(page = 0) {
            licenseCurrentPage = page;
            const offset = page * licensePageSize;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/license/list?limit=${licensePageSize}&offset=${offset}`, {
                    headers: getLicenseHeaders()
                });
                if (!checkTokenValid(res)) return;
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('licenseTable').innerHTML = 
                        `<tr><td colspan="7" style="text-align: center; color: var(--accent-red);">加载失败: ${data.message}</td></tr>`;
                    return;
                }
                
                licenseAllData = data.data?.items || [];
                licenseTotalCount = data.data?.total || 0;
                
                renderLicenseTable();
                
            } catch (e) {
                console.error('加载激活码列表失败', e);
                document.getElementById('licenseTable').innerHTML = 
                    `<tr><td colspan="7" style="text-align: center; color: var(--accent-red);">网络错误: ${e.message}</td></tr>`;
            }
        }
        
        // 渲染激活码表格（应用筛选+搜索+排序）
        function renderLicenseTable() {
            let filtered = [...licenseAllData];
            
            // 搜索过滤
            if (licenseSearchTerm) {
                const term = licenseSearchTerm.toLowerCase();
                filtered = filtered.filter(l => 
                    l.license_key?.toLowerCase().includes(term) ||
                    l.product_id?.toLowerCase().includes(term) ||
                    l.machine_id?.toLowerCase().includes(term)
                );
            }
            
            // 计费模式筛选
            if (licenseBillingFilter) {
                filtered = filtered.filter(l => l.billing_mode === licenseBillingFilter);
            }
            
            // 状态筛选
            if (licenseStatusFilter) {
                filtered = filtered.filter(l => l.status === licenseStatusFilter);
            }
            
            // 按剩余排序
            if (licenseSortDir !== 0) {
                filtered.sort((a, b) => {
                    const va = getLicenseRemainingValue(a);
                    const vb = getLicenseRemainingValue(b);
                    return licenseSortDir === 1 ? va - vb : vb - va;
                });
            }
            
            if (filtered.length === 0) {
                document.getElementById('licenseTable').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">无匹配的激活码</td></tr>';
                renderLicensePagination(licenseTotalCount);
                return;
            }
            
            document.getElementById('licenseTable').innerHTML = filtered.map(license => {
                const statusClass = {
                    'active': 'status-active',
                    'inactive': 'status-inactive',
                    'expired': 'status-expired',
                    'revoked': 'status-revoked'
                }[license.status] || '';
                
                const statusText = {
                    'active': '已激活',
                    'inactive': '未激活',
                    'expired': '已过期',
                    'revoked': '已撤销',
                    'suspended': '已暂停'
                }[license.status] || license.status;
                
                const billingText = {
                    'per_use': '按次数',
                    'time_based': '按时间',
                    'unlimited': '无限制'
                }[license.billing_mode] || license.billing_mode;
                
                // 剩余显示
                let remainingText = '-';
                if (license.billing_mode === 'per_use') {
                    remainingText = `${license.remaining_uses || 0} 次`;
                } else if (license.billing_mode === 'time_based') {
                    const minutes = license.remaining_time || 0;
                    const days = (minutes / 1440).toFixed(1);
                    remainingText = `${days} 天`;
                } else if (license.billing_mode === 'unlimited') {
                    remainingText = '∞';
                }
                
                return `
                    <tr>
                        <td style="font-family: monospace; font-size: 12px;">
                            <span style="cursor: pointer;" onclick="copyToClipboard('${license.license_key}')" title="点击复制">${license.license_key}</span>
                        </td>
                        <td>${license.product_id || '-'}</td>
                        <td>${billingText}</td>
                        <td>${remainingText}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>${license.created_at ? new Date(license.created_at).toLocaleString('zh-CN') : '-'}</td>
                        <td>
                            <button class="btn-small" onclick="showLicenseDetail('${license.license_key}')" style="padding: 4px 10px; font-size: 12px; background: var(--bg-secondary); color: var(--accent); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">详情</button>
                            ${license.status === 'active' ? `<button class="btn-small" onclick="revokeLicense('${license.license_key}')" style="padding: 4px 10px; font-size: 12px; background: var(--bg-secondary); color: var(--accent-red); border: 1px solid rgba(255,71,87,0.3); border-radius: 4px; cursor: pointer;">撤销</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // 渲染分页
            renderLicensePagination(licenseTotalCount);
        }
        
        // 渲染分页
        function renderLicensePagination(total) {
            const totalPages = Math.ceil(total / licensePageSize);
            const container = document.getElementById('licensePagination');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // 上一页
            html += `<button class="btn-page" onclick="loadLicenses(${licenseCurrentPage - 1})" ${licenseCurrentPage <= 0 ? 'disabled' : ''}>上一页</button>`;
            
            // 页码
            for (let i = 0; i < totalPages && i < 10; i++) {
                const activeClass = i === licenseCurrentPage ? ' active' : '';
                html += `<button class="btn-page${activeClass}" onclick="loadLicenses(${i})">${i + 1}</button>`;
            }
            
            // 下一页
            html += `<button class="btn-page" onclick="loadLicenses(${licenseCurrentPage + 1})" ${licenseCurrentPage >= totalPages - 1 ? 'disabled' : ''}>下一页</button>`;
            
            container.innerHTML = html;
        }
        
        // 搜索激活码
        function searchLicenses() {
            licenseSearchTerm = document.getElementById('licenseSearch').value.trim();
            licenseBillingFilter = document.getElementById('licBillingFilter').value;
            licenseStatusFilter = document.getElementById('licStatusFilter').value;
            renderLicenseTable();
        }
        
        // 应用筛选（下拉框变化时触发）
        function applyLicenseFilters() {
            licenseBillingFilter = document.getElementById('licBillingFilter').value;
            licenseStatusFilter = document.getElementById('licStatusFilter').value;
            renderLicenseTable();
        }
        
        // 清除所有筛选
        function clearLicenseFilters() {
            document.getElementById('licenseSearch').value = '';
            document.getElementById('licBillingFilter').value = '';
            document.getElementById('licStatusFilter').value = '';
            licenseSearchTerm = '';
            licenseBillingFilter = '';
            licenseStatusFilter = '';
            licenseSortDir = 0;
            document.getElementById('licSortIcon').textContent = '⇅';
            renderLicenseTable();
        }
        
        // 切换剩余排序方向
        function toggleLicenseSort() {
            // 0 -> 1(升序) -> -1(降序) -> 0(不排序)
            if (licenseSortDir === 0) licenseSortDir = 1;
            else if (licenseSortDir === 1) licenseSortDir = -1;
            else licenseSortDir = 0;
            
            const iconEl = document.getElementById('licSortIcon');
            if (licenseSortDir === 1) iconEl.textContent = '↑';
            else if (licenseSortDir === -1) iconEl.textContent = '↓';
            else iconEl.textContent = '⇅';
            
            renderLicenseTable();
        }
        
        // ===== 激活码子标签切换 =====
        let licCurrentTab = 'list';
        let licCreateLogsPage = 0;
        let licUsageLogsPage = 0;
        const licLogsPageSize = 50;
        
        function switchLicenseTab(tab) {
            licCurrentTab = tab;
            // 切换面板
            document.getElementById('licPanelList').style.display = tab === 'list' ? 'block' : 'none';
            document.getElementById('licPanelCreate').style.display = tab === 'create' ? 'block' : 'none';
            document.getElementById('licPanelUsage').style.display = tab === 'usage' ? 'block' : 'none';
            
            // 切换tab按钮样式
            ['licTabList', 'licTabCreate', 'licTabUsage'].forEach(id => {
                const btn = document.getElementById(id);
                const isActive = (id === 'licTab' + tab.charAt(0).toUpperCase() + tab.slice(1)) ||
                                 (tab === 'list' && id === 'licTabList') ||
                                 (tab === 'create' && id === 'licTabCreate') ||
                                 (tab === 'usage' && id === 'licTabUsage');
                btn.style.background = isActive ? 'var(--accent)' : 'var(--bg-card)';
                btn.style.color = isActive ? '#fff' : 'var(--text-secondary)';
                btn.style.fontWeight = isActive ? 'bold' : 'normal';
            });
            
            // 加载对应数据
            if (tab === 'create') loadLicenseCreateLogs(0);
            else if (tab === 'usage') loadLicenseUsageLogs(0);
        }
        
        // 加载创建记录
        async function loadLicenseCreateLogs(page = 0) {
            licCreateLogsPage = page;
            const tbody = document.getElementById('licCreateLogsTable');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">加载中...</td></tr>';
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/license/local-logs?action=create&limit=${licLogsPageSize}&offset=${page * licLogsPageSize}`, {
                    headers: getLicenseHeaders()
                });
                if (!checkTokenValid(res)) return;
                const data = await res.json();
                
                const rows = data.rows || [];
                const total = data.total || 0;
                
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">暂无创建记录</td></tr>';
                } else {
                    const billingTextMap = {'per_use': '按次数', 'time_based': '按时间', 'unlimited': '无限制'};
                    tbody.innerHTML = rows.map(row => `
                        <tr>
                            <td style="white-space: nowrap;">${row.created_at ? new Date(row.created_at).toLocaleString('zh-CN') : '-'}</td>
                            <td style="font-family: monospace; font-size: 12px;">
                                <span style="cursor: pointer;" onclick="copyToClipboard('${row.license_key || ''}')" title="点击复制">${row.license_key || '-'}</span>
                            </td>
                            <td>${row.product_id || '-'}</td>
                            <td>${billingTextMap[row.billing_mode] || row.billing_mode || '-'}</td>
                            <td>${row.detail || '-'}</td>
                            <td>${row.operator || '-'}</td>
                        </tr>
                    `).join('');
                }
                
                // 分页
                renderLogsPagination('licCreateLogsPagination', total, licLogsPageSize, page, 'loadLicenseCreateLogs');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--accent-red);">加载失败: ${e.message}</td></tr>`;
            }
        }
        
        // 加载使用记录（从远程服务器 + 本地撤销记录）
        async function loadLicenseUsageLogs(page = 0) {
            licUsageLogsPage = page;
            const tbody = document.getElementById('licUsageLogsTable');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">加载中...</td></tr>';
            
            try {
                // 同时请求远程使用日志和本地操作日志
                const [remoteRes, localRes] = await Promise.all([
                    fetch(`${API_BASE}/admin/api/license/logs?limit=${licLogsPageSize}&offset=${page * licLogsPageSize}`, {
                        headers: getLicenseHeaders()
                    }).catch(() => null),
                    fetch(`${API_BASE}/admin/api/license/local-logs?limit=${licLogsPageSize}&offset=${page * licLogsPageSize}`, {
                        headers: getLicenseHeaders()
                    }).catch(() => null)
                ]);
                
                let allRows = [];
                let total = 0;
                
                // 远程日志
                if (remoteRes && remoteRes.ok) {
                    const remoteData = await remoteRes.json();
                    if (!remoteData.error && remoteData.data) {
                        const items = remoteData.data.items || remoteData.data || [];
                        if (Array.isArray(items)) {
                            allRows = items.map(r => ({
                                time: r.timestamp || r.created_at || '',
                                license_key: r.license_key || '',
                                action: r.action || r.event || '',
                                detail: r.details || r.message || r.machine_id || '',
                                operator: r.client_ip || r.ip || '-'
                            }));
                            total = remoteData.data.total || items.length;
                        }
                    }
                }
                
                // 如果远程没数据，用本地非create的日志
                if (allRows.length === 0 && localRes && localRes.ok) {
                    const localData = await localRes.json();
                    const rows = localData.rows || [];
                    total = localData.total || 0;
                    const actionMap = {'create': '创建', 'revoke': '撤销', 'activate': '激活', 'use': '使用'};
                    allRows = rows.map(r => ({
                        time: r.created_at || '',
                        license_key: r.license_key || '',
                        action: actionMap[r.action] || r.action || '',
                        detail: r.detail || '-',
                        operator: r.operator || '-'
                    }));
                }
                
                if (allRows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">暂无使用记录</td></tr>';
                } else {
                    tbody.innerHTML = allRows.map(row => {
                        const actionClass = {
                            'activate': 'status-active', 'use': 'status-active', '激活': 'status-active', '使用': 'status-active',
                            'revoke': 'status-revoked', '撤销': 'status-revoked',
                            'create': 'status-inactive', '创建': 'status-inactive'
                        }[row.action] || '';
                        return `
                            <tr>
                                <td style="white-space: nowrap;">${row.time ? new Date(row.time).toLocaleString('zh-CN') : '-'}</td>
                                <td style="font-family: monospace; font-size: 12px;">${row.license_key || '-'}</td>
                                <td><span class="status ${actionClass}">${row.action || '-'}</span></td>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${row.detail || '-'}</td>
                                <td>${row.operator || '-'}</td>
                            </tr>
                        `;
                    }).join('');
                }
                
                renderLogsPagination('licUsageLogsPagination', total, licLogsPageSize, page, 'loadLicenseUsageLogs');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--accent-red);">加载失败: ${e.message}</td></tr>`;
            }
        }
        
        // 渲染日志分页
        function renderLogsPagination(containerId, total, pageSize, currentPage, loadFnName) {
            const totalPages = Math.ceil(total / pageSize);
            const container = document.getElementById(containerId);
            if (totalPages <= 1) { container.innerHTML = ''; return; }
            
            let html = '';
            html += `<button class="btn-page" onclick="${loadFnName}(${currentPage - 1})" ${currentPage <= 0 ? 'disabled' : ''}>上一页</button>`;
            html += `<span style="color: var(--text-secondary); line-height: 32px; font-size: 13px;">第 ${currentPage + 1} / ${totalPages} 页</span>`;
            html += `<button class="btn-page" onclick="${loadFnName}(${currentPage + 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>下一页</button>`;
            container.innerHTML = html;
        }
        
        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('已复制到剪贴板: ' + text);
            }).catch(e => {
                console.error('复制失败', e);
            });
        }
        
        // 显示创建激活码弹窗
        function showCreateLicenseModal() {
            document.getElementById('createLicenseModal').style.display = 'flex';
            document.getElementById('licBatchCount').value = 1;
            document.getElementById('createLicenseMsg').style.display = 'none';
            document.getElementById('createLicenseProgress').style.display = 'none';
            document.getElementById('createLicenseBtn').disabled = false;
            document.getElementById('createLicenseBtn').textContent = '创建';
            onBillingModeChange();
        }
        
        // 关闭创建激活码弹窗
        function closeCreateLicenseModal() {
            document.getElementById('createLicenseModal').style.display = 'none';
            document.getElementById('createLicenseMsg').style.display = 'none';
            document.getElementById('createLicenseProgress').style.display = 'none';
        }
        
        // 计费模式变化
        function onBillingModeChange() {
            const mode = document.getElementById('licBillingMode').value;
            document.getElementById('licMaxUsesRow').style.display = mode === 'per_use' ? 'block' : 'none';
            document.getElementById('licUsageTimeRow').style.display = mode === 'time_based' ? 'block' : 'none';
        }
        
        // 创建激活码（支持批量）
        async function doCreateLicense() {
            const productId = document.getElementById('licProductId').value;
            const billingMode = document.getElementById('licBillingMode').value;
            const maxUses = parseInt(document.getElementById('licMaxUses').value) || 100;
            const usageTime = parseFloat(document.getElementById('licUsageTime').value) || 30;
            const expiryDays = parseInt(document.getElementById('licExpiryDays').value) || 365;
            const batchCount = Math.min(Math.max(parseInt(document.getElementById('licBatchCount').value) || 1, 1), 100);
            
            const msgDiv = document.getElementById('createLicenseMsg');
            const progressDiv = document.getElementById('createLicenseProgress');
            const progressBar = document.getElementById('createProgressBar');
            const progressText = document.getElementById('createProgressText');
            const createBtn = document.getElementById('createLicenseBtn');
            
            // 禁用按钮防止重复点击
            createBtn.disabled = true;
            createBtn.textContent = '创建中...';
            
            const body = {
                product_id: productId,
                billing_mode: billingMode,
                expiry_days: expiryDays
            };
            if (billingMode === 'per_use') body.max_uses = maxUses;
            else if (billingMode === 'time_based') body.usage_time = usageTime;
            
            let successKeys = [];
            let failCount = 0;
            
            // 批量创建时显示进度条
            if (batchCount > 1) {
                progressDiv.style.display = 'block';
                progressBar.style.width = '0%';
                progressText.textContent = `0/${batchCount}`;
            }
            
            for (let i = 0; i < batchCount; i++) {
                try {
                    const res = await fetch(`${API_BASE}/admin/api/license/create`, {
                        method: 'POST',
                        headers: getLicenseHeaders(),
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    
                    if (data.error) {
                        failCount++;
                    } else {
                        successKeys.push(data.data?.license_key || '');
                    }
                } catch (e) {
                    failCount++;
                }
                
                // 更新进度
                if (batchCount > 1) {
                    const pct = ((i + 1) / batchCount * 100).toFixed(0);
                    progressBar.style.width = pct + '%';
                    progressText.textContent = `${i + 1}/${batchCount}`;
                }
            }
            
            // 恢复按钮
            createBtn.disabled = false;
            createBtn.textContent = '创建';
            
            if (failCount === batchCount) {
                // 全部失败
                msgDiv.textContent = `❌ 创建失败（${failCount}个）`;
                msgDiv.style.background = 'rgba(255, 71, 87, 0.1)';
                msgDiv.style.color = 'var(--accent-red)';
                msgDiv.style.display = 'block';
            } else if (successKeys.length > 0) {
                // 有成功的 → 刷新列表并自动关闭弹窗
                loadLicenses(0);
                loadLicenseStats();
                
                if (batchCount === 1) {
                    // 单个创建：短暂显示成功后关闭
                    msgDiv.innerHTML = `✅ 创建成功！激活码: <strong style="font-family: monospace; user-select: all;">${successKeys[0]}</strong>`;
                    msgDiv.style.background = 'rgba(0, 255, 136, 0.1)';
                    msgDiv.style.color = 'var(--accent-green)';
                    msgDiv.style.display = 'block';
                    setTimeout(() => closeCreateLicenseModal(), 1500);
                } else {
                    // 批量创建：显示结果后自动关闭
                    let summary = `✅ 成功创建 ${successKeys.length} 个`;
                    if (failCount > 0) summary += `，失败 ${failCount} 个`;
                    msgDiv.innerHTML = summary + `<br><div style="margin-top: 8px; font-family: monospace; font-size: 11px; max-height: 80px; overflow-y: auto; user-select: all; line-height: 1.8;">${successKeys.join('<br>')}</div>`;
                    msgDiv.style.background = 'rgba(0, 255, 136, 0.1)';
                    msgDiv.style.color = 'var(--accent-green)';
                    msgDiv.style.display = 'block';
                    setTimeout(() => closeCreateLicenseModal(), 3000);
                }
            }
        }
        
        // 显示激活码详情
        async function showLicenseDetail(licenseKey) {
            try {
                const res = await fetch(`${API_BASE}/admin/api/license/info/${licenseKey}`, {
                    headers: getLicenseHeaders()
                });
                if (!checkTokenValid(res)) return;
                const data = await res.json();
                
                if (data.error) {
                    alert('获取详情失败: ' + data.message);
                    return;
                }
                
                const license = data.data;
                const billingText = {
                    'per_use': '按次数',
                    'time_based': '按时间',
                    'unlimited': '无限制'
                }[license.billing_mode] || license.billing_mode;
                
                const statusText = {
                    'active': '已激活',
                    'inactive': '未激活',
                    'expired': '已过期',
                    'revoked': '已撤销'
                }[license.status] || license.status;
                
                let remainingText = '-';
                if (license.billing_mode === 'per_use') {
                    remainingText = `${license.remaining_uses || 0} / ${license.max_uses || 0} 次`;
                } else if (license.billing_mode === 'time_based') {
                    const minutes = license.remaining_time || 0;
                    const days = (minutes / 1440).toFixed(1);
                    remainingText = `${days} 天 (${license.usage_time ? (license.usage_time/1440).toFixed(1) : '-'} 天总时长)`;
                } else {
                    remainingText = '∞ 无限制';
                }
                
                document.getElementById('licenseDetailContent').innerHTML = `
                    <table style="width: 100%;">
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">激活码</td>
                            <td style="font-family: monospace; padding: 8px 0;">${license.license_key}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">产品</td>
                            <td style="padding: 8px 0;">${license.product_id}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">计费模式</td>
                            <td style="padding: 8px 0;">${billingText}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">剩余</td>
                            <td style="padding: 8px 0; color: var(--accent-green);">${remainingText}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">状态</td>
                            <td style="padding: 8px 0;">${statusText}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">绑定机器</td>
                            <td style="padding: 8px 0; font-family: monospace; font-size: 11px;">${license.machine_id || '未绑定'}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">创建时间</td>
                            <td style="padding: 8px 0;">${license.created_at ? new Date(license.created_at).toLocaleString('zh-CN') : '-'}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">激活时间</td>
                            <td style="padding: 8px 0;">${license.activated_at ? new Date(license.activated_at).toLocaleString('zh-CN') : '-'}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">过期时间</td>
                            <td style="padding: 8px 0;">${license.expiry_date ? new Date(license.expiry_date).toLocaleString('zh-CN') : '-'}</td></tr>
                    </table>
                `;
                
                document.getElementById('licenseDetailModal').style.display = 'flex';
            } catch (e) {
                alert('获取详情失败: ' + e.message);
            }
        }
        
        // 关闭激活码详情弹窗
        function closeLicenseDetailModal() {
            document.getElementById('licenseDetailModal').style.display = 'none';
        }
        
        // 撤销激活码
        async function revokeLicense(licenseKey) {
            if (!confirm(`确定要撤销激活码 ${licenseKey} 吗？此操作不可恢复！`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/license/revoke`, {
                    method: 'POST',
                    headers: getLicenseHeaders(),
                    body: JSON.stringify({
                        license_key: licenseKey,
                        reason: '管理员撤销'
                    })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    alert('撤销失败: ' + data.message);
                } else {
                    alert('撤销成功');
                    loadLicenses(licenseCurrentPage);
                    loadLicenseStats();
                }
            } catch (e) {
                alert('撤销失败: ' + e.message);
            }
        }
        
        // ===== 流量仪表盘功能 =====
        
        // 加载仪表盘数据
        async function loadDashboard() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/dashboard`);
                const data = await res.json();
                
                // 更新实时指标
                document.getElementById('dashTodayRequests').textContent = formatNumber(data.today_requests || 0);
                document.getElementById('dashSuccessRate').textContent = (data.success_rate || 0).toFixed(1) + '%';
                document.getElementById('dashActiveUsers').textContent = data.active_users || 0;
                document.getElementById('dashPeakRPM').textContent = data.peak_rpm || 0;
                
                // 更新24小时趋势图
                renderHourlyChart(data.hourly_data || []);
                
                // 更新排行榜
                renderTopUsers(data.top_users || []);
                renderTopIps(data.top_ips || []);
                
                // 更新时间
                document.getElementById('chartUpdateTime').textContent = '更新于 ' + new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
            } catch (e) {
                console.error('加载仪表盘失败', e);
            }
        }
        
        // 渲染24小时柱状图
        function renderHourlyChart(data) {
            const container = document.getElementById('hourlyChart');
            const labelsContainer = document.getElementById('chartLabels');
            
            // 确保有24个数据点
            const hourlyData = new Array(24).fill(0);
            data.forEach(item => {
                if (item.hour >= 0 && item.hour < 24) {
                    hourlyData[item.hour] = item.count || 0;
                }
            });
            
            const maxValue = Math.max(...hourlyData, 1);
            const currentHour = new Date().getHours();
            
            // 生成柱状图
            container.innerHTML = hourlyData.map((value, hour) => {
                const height = (value / maxValue) * 100;
                const isCurrent = hour === currentHour;
                return `<div class="chart-bar" style="height: ${Math.max(height, 3)}%; ${isCurrent ? 'background: linear-gradient(to top, #00ff88, #00d4ff);' : ''}" data-value="${value} 次" title="${hour}:00 - ${value}次"></div>`;
            }).join('');
            
            // 生成时间标签（每3小时显示一次）
            labelsContainer.innerHTML = hourlyData.map((_, hour) => {
                return `<div class="chart-label">${hour % 3 === 0 ? hour + ':00' : ''}</div>`;
            }).join('');
        }
        
        // 渲染Top用户
        function renderTopUsers(users) {
            const container = document.getElementById('topUsersList');
            if (!users || users.length === 0) {
                container.innerHTML = '<div class="ranking-empty">暂无数据</div>';
                return;
            }
            
            container.innerHTML = users.slice(0, 10).map((user, index) => `
                <div class="ranking-item">
                    <div class="ranking-rank">${index + 1}</div>
                    <div class="ranking-name">${user.username}</div>
                    <div class="ranking-value">${user.count} 次</div>
                </div>
            `).join('');
        }
        
        // 渲染Top IP
        function renderTopIps(ips) {
            const container = document.getElementById('topIpsList');
            if (!ips || ips.length === 0) {
                container.innerHTML = '<div class="ranking-empty">暂无数据</div>';
                return;
            }
            
            container.innerHTML = ips.slice(0, 10).map((ip, index) => `
                <div class="ranking-item">
                    <div class="ranking-rank">${index + 1}</div>
                    <div class="ranking-name">${ip.ip}</div>
                    <div class="ranking-value">${ip.count} 次</div>
                </div>
            `).join('');
        }
        
        // 添加活动记录
        function addActivityItem(type, icon, text, time) {
            const container = document.getElementById('activityStream');
            
            // 清除空状态
            const empty = container.querySelector('.activity-empty');
            if (empty) empty.remove();
            
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <div class="activity-icon ${type}">${icon}</div>
                <div class="activity-content">
                    <div class="activity-text">${text}</div>
                    <div class="activity-time">${time}</div>
                </div>
            `;
            
            // 插入到最前面
            container.insertBefore(item, container.firstChild);
            
            // 最多保留15条
            while (container.children.length > 15) {
                container.removeChild(container.lastChild);
            }
        }
        
        // 启动仪表盘
        function startDashboard() {
            loadDashboard();
            // 每30秒刷新一次
            if (dashboardTimer) clearInterval(dashboardTimer);
            dashboardTimer = setInterval(loadDashboard, 30000);
        }
        
        // 停止仪表盘
        function stopDashboard() {
            if (dashboardTimer) {
                clearInterval(dashboardTimer);
                dashboardTimer = null;
            }
        }
        
        // 验证Token有效性
        async function verifyToken() {
            const token = sessionStorage.getItem('admin_token');
            if (!token) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/verify_token`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.status === 401) {
                    let msg = '您的登录状态已过期，请重新登录';
                    try {
                        const data = await res.json();
                        if (data.message) msg = data.message;
                    } catch(e) {}
                    handleKickedOut(msg);
                }
            } catch (e) {
                // 网络错误不弹窗，避免离线时误报
                console.error('验证token失败', e);
            }
        }
        
        // 初始化应用（登录成功后调用）
        function initApp() {
            initWebSocket();
            refreshStats();
            // 启动仪表盘
            startDashboard();
            // 定时刷新统计
            setInterval(refreshStats, 10000);
            // 定期验证token（每30秒检查一次是否被踢出）
            setInterval(verifyToken, 30000);
        }
        
        // 如果已登录，直接初始化
        if (isLoggedIn) {
            initApp();
        }
    </script>
</body>
</html>
