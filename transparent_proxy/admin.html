<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKåå°ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #e4e4e4;
            --text-secondary: #8892b0;
            --accent: #00d4ff;
            --accent-green: #00ff88;
            --accent-red: #ff4757;
            --accent-yellow: #ffa502;
            --border: #2d2d44;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-green) 100%);
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #00b8d4 0%, #00e676 100%);
        }
        
        /* Firefox æ»šåŠ¨æ¡ */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-secondary);
        }
        
        /* å¤´éƒ¨ */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            background: linear-gradient(90deg, var(--accent), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-primary);
            border-radius: 20px;
            font-size: 14px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-red);
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: var(--accent-green);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes alertIn {
            from { transform: scale(0.85); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* å°ç¦è¡Œï¼šçº¢è‰²æµåŠ¨æ•ˆæœ */
        @keyframes banned-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        tr.banned-row {
            background: linear-gradient(90deg, 
                rgba(255,30,30,0.15) 0%, 
                rgba(180,0,0,0.25) 25%, 
                rgba(255,50,50,0.12) 50%, 
                rgba(200,0,0,0.22) 75%, 
                rgba(255,30,30,0.15) 100%) !important;
            background-size: 200% 100%;
            animation: banned-flow 4s ease-in-out infinite;
            position: relative;
            border-left: 3px solid #ff2222 !important;
        }
        tr.banned-row td {
            color: #ff6b6b !important;
            text-shadow: 0 0 8px rgba(255,50,50,0.3);
        }
        tr.banned-row td:first-child::before {
            content: 'â›“ï¸';
            margin-right: 4px;
            font-size: 13px;
            filter: drop-shadow(0 0 3px rgba(255,0,0,0.5));
        }
        tr.banned-row td:first-child strong {
            text-decoration: line-through;
            text-decoration-color: rgba(255,0,0,0.6);
            text-decoration-thickness: 2px;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px 30px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.1);
        }
        
        .stat-card .label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent);
        }
        
        .stat-card.green .value { color: var(--accent-green); }
        .stat-card.red .value { color: var(--accent-red); }
        .stat-card.yellow .value { color: var(--accent-yellow); }
        
        /* æµå…‰è¾¹æ¡†æ•ˆæœ */
        .glow-border {
            position: relative;
            background: var(--bg-card);
            border: none !important;
            overflow: hidden;
            isolation: isolate;
        }
        
        .glow-border::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg 60deg,
                var(--glow-color, var(--accent)) 60deg 120deg,
                transparent 120deg 180deg,
                var(--glow-color, var(--accent)) 180deg 240deg,
                transparent 240deg 300deg,
                var(--glow-color, var(--accent)) 300deg 360deg
            );
            animation: glow-spin 3s linear infinite;
            z-index: -2;
        }
        
        .glow-border::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: var(--bg-card);
            border-radius: 10px;
            z-index: -1;
        }
        
        @keyframes glow-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* ä¸åŒé¢œè‰²ä¸»é¢˜ */
        .glow-border.glow-cyan { --glow-color: #00d4ff; }
        .glow-border.glow-green { --glow-color: #00ff88; }
        .glow-border.glow-pink { --glow-color: #ff6b9d; }
        .glow-border.glow-yellow { --glow-color: #f7b731; }
        .glow-border.glow-purple { --glow-color: #a55eea; }
        
        .glow-border {
            box-shadow: 0 0 20px rgba(var(--glow-rgb, 0, 212, 255), 0.25);
        }
        
        .glow-border.glow-cyan { box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
        .glow-border.glow-green { box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
        .glow-border.glow-pink { box-shadow: 0 0 20px rgba(255, 107, 157, 0.3); }
        .glow-border.glow-yellow { box-shadow: 0 0 20px rgba(247, 183, 49, 0.3); }
        .glow-border.glow-purple { box-shadow: 0 0 20px rgba(165, 94, 234, 0.3); }
        
        .glow-border:hover::before {
            animation-duration: 1.5s;
        }
        
        .glow-border.glow-cyan:hover { box-shadow: 0 0 30px rgba(0, 212, 255, 0.5); }
        .glow-border.glow-green:hover { box-shadow: 0 0 30px rgba(0, 255, 136, 0.5); }
        .glow-border.glow-pink:hover { box-shadow: 0 0 30px rgba(255, 107, 157, 0.5); }
        .glow-border.glow-yellow:hover { box-shadow: 0 0 30px rgba(247, 183, 49, 0.5); }
        .glow-border.glow-purple:hover { box-shadow: 0 0 30px rgba(165, 94, 234, 0.5); }
        
        /* å¯æ’åºè¡¨å¤´ */
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            white-space: nowrap;
        }
        
        th.sortable:hover {
            background: rgba(0, 212, 255, 0.15);
        }
        
        th.sortable .sort-icon {
            display: inline-block;
            margin-left: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        
        th.sortable.asc .sort-icon,
        th.sortable.desc .sort-icon {
            color: var(--accent);
        }
        
        /* ===== æƒé™æ ‡è¯†æ ·å¼ ===== */
        .role-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        
        .role-badge.super-admin {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 50%, #ffd700 100%);
            background-size: 200% 200%;
            animation: shimmer 2s ease-in-out infinite;
            color: #1a1a2e;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 140, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .role-badge.sub-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 200%;
            animation: shimmer 3s ease-in-out infinite;
            color: white;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .role-badge::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 70%
            );
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .role-icon {
            font-size: 16px;
            z-index: 1;
        }
        
        .role-text {
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .role-badge.super-admin .role-icon {
            animation: crown-bounce 1s ease-in-out infinite;
        }
        
        @keyframes crown-bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-2px) rotate(-5deg); }
            75% { transform: translateY(-2px) rotate(5deg); }
        }
        
        /* ===== æµé‡ä»ªè¡¨ç›˜æ ·å¼ ===== */
        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .metric-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .metric-info {
            flex: 1;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* 24å°æ—¶è¶‹åŠ¿å›¾ */
        .dashboard-chart {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            margin-bottom: 25px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h4 {
            margin: 0;
            color: var(--accent);
        }
        
        .chart-update-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .chart-container {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 150px;
            padding: 0 10px;
        }
        
        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #00d4ff, #667eea);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.5s ease, background 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .chart-bar:hover {
            background: linear-gradient(to top, #00ff88, #00d4ff);
        }
        
        .chart-bar::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        
        .chart-bar:hover::after {
            opacity: 1;
        }
        
        .chart-labels {
            display: flex;
            gap: 4px;
            padding: 10px 10px 0;
        }
        
        .chart-label {
            flex: 1;
            text-align: center;
            font-size: 10px;
            color: var(--text-secondary);
        }
        
        /* æ’è¡Œæ¦œ */
        .dashboard-rankings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .ranking-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .ranking-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        
        .ranking-header h4 {
            margin: 0;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .ranking-list {
            padding: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            gap: 12px;
            transition: background 0.2s;
        }
        
        .ranking-item:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        
        .ranking-rank {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }
        
        .ranking-item:nth-child(1) .ranking-rank {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
        }
        
        .ranking-item:nth-child(2) .ranking-rank {
            background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
            color: #000;
        }
        
        .ranking-item:nth-child(3) .ranking-rank {
            background: linear-gradient(135deg, #cd7f32, #a0522d);
            color: #fff;
        }
        
        .ranking-name {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .ranking-value {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent);
        }
        
        .ranking-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* å®æ—¶æ´»åŠ¨æµ */
        .dashboard-activity {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .activity-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-header h4 {
            margin: 0;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .activity-status {
            font-size: 12px;
            color: var(--accent-green);
            animation: pulse 2s infinite;
        }
        
        .activity-stream {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            animation: slideInLeft 0.3s ease;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: var(--bg-secondary);
        }
        
        .activity-icon.success { background: rgba(0, 255, 136, 0.15); }
        .activity-icon.failed { background: rgba(255, 71, 87, 0.15); }
        .activity-icon.info { background: rgba(0, 212, 255, 0.15); }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .activity-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .activity-empty {
            padding: 40px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* ===== æ¿€æ´»ç ç®¡ç†æ ·å¼ ===== */
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background: rgba(0, 255, 136, 0.15);
            color: var(--accent-green);
        }
        
        .status-inactive {
            background: rgba(150, 150, 150, 0.15);
            color: var(--text-secondary);
        }
        
        .status-expired {
            background: rgba(255, 165, 0, 0.15);
            color: #ffa500;
        }
        
        .status-revoked {
            background: rgba(255, 71, 87, 0.15);
            color: var(--accent-red);
        }
        
        .btn-small {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            margin-right: 4px;
            transition: all 0.2s;
        }
        
        .btn-small:hover {
            background: var(--accent);
            transform: scale(1.05);
        }
        
        .btn-small.btn-danger:hover {
            background: var(--accent-red);
        }
        
        /* å“åº”å¼ */
        @media screen and (max-width: 1024px) {
            .dashboard-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-rankings {
                grid-template-columns: 1fr;
            }
            
            .metric-card {
                padding: 15px;
            }
            
            .metric-value {
                font-size: 22px;
            }
            
            .license-stats {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            padding: 0 30px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab:hover {
            color: var(--text-primary);
        }
        
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        
        /* å†…å®¹åŒº */
        .content {
            padding: 20px 30px;
        }
        
        .panel {
            display: none;
        }
        
        .panel.active {
            display: block;
        }
        
        /* è¡¨æ ¼ */
        .table-container {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
        }
        
        tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge.success {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }
        
        .badge.danger {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
        }
        
        .badge.warning {
            background: rgba(255, 165, 2, 0.2);
            color: var(--accent-yellow);
        }
        
        /* æŒ‰é’® */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .btn-danger {
            background: var(--accent-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff6b7a;
        }
        
        .btn-page {
            padding: 6px 14px;
            background: #ffffff;
            color: #1a1a2e;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-page:hover:not(:disabled) {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .btn-page:disabled {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }
        
        .btn-page.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .btn-success {
            background: var(--accent-green);
            color: #000;
        }
        
        .btn-success:hover {
            background: #33ff99;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #000;
        }
        
        .btn-primary:hover {
            background: #33ddff;
        }
        
        /* å®æ—¶æ—¥å¿— */
        .live-log {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-item {
            padding: 10px;
            border-left: 3px solid var(--accent);
            margin-bottom: 10px;
            background: var(--bg-secondary);
            border-radius: 0 8px 8px 0;
            animation: slideIn 0.3s ease;
        }
        
        .log-item.success {
            border-left-color: var(--accent-green);
        }
        
        .log-item.failed {
            border-left-color: var(--accent-red);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .log-item .time {
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        .log-item .info {
            margin-top: 5px;
        }
        
        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            min-width: 400px;
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                min-width: unset;
                width: 90%;
                max-width: 500px;
                padding: 20px;
                max-height: 85vh;
            }
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--accent);
        }
        
        .modal-content input {
            width: 100%;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .modal-content input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* åˆ·æ–°æŒ‰é’® */
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: scale(1.1);
        }
        
        .refresh-btn svg {
            width: 24px;
            height: 24px;
            fill: #000;
        }
        
        /* ç™»å½•é¡µé¢ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 380px;
            box-shadow: 0 20px 60px rgba(0, 212, 255, 0.1);
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
            background: linear-gradient(90deg, var(--accent), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .login-box .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .login-input {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent), #0099cc);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }
        
        .login-error {
            color: var(--accent-red);
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        
        .main-content {
            display: none;
        }
        
        .main-content.visible {
            display: block;
        }
        
        /* ===== æ¨ªå±æç¤º ===== */
        .rotate-hint {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 99999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
        }
        
        .rotate-hint .icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: rotate-phone 2s ease-in-out infinite;
        }
        
        @keyframes rotate-phone {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(90deg); }
        }
        
        .rotate-hint h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--accent);
        }
        
        .rotate-hint p {
            color: var(--text-secondary);
            font-size: 16px;
            line-height: 1.6;
        }
        
        /* ===== ç§»åŠ¨ç«¯é€‚é… ===== */
        @media screen and (max-width: 1024px) {
            .header {
                padding: 12px 15px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 10px 15px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-card .value {
                font-size: 20px;
            }
            
            /* ç§»åŠ¨ç«¯ï¼šbodyä¸æ»šåŠ¨ï¼Œmain-contentå†…éƒ¨æ»šåŠ¨ï¼ˆå¯æ ·å¼åŒ–ï¼‰ */
            html, body {
                overflow: hidden;
                height: 100%;
            }
            .main-content.visible {
                height: 100vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tabs {
                padding: 0 10px;
                gap: 5px;
                overflow-x: auto;
                flex-wrap: nowrap;
                position: sticky;
                top: 0;
                z-index: 100;
                scrollbar-width: none;  /* Firefox */
                -ms-overflow-style: none;  /* IE */
            }
            .tabs::-webkit-scrollbar {
                display: none;  /* Chrome/Safari */
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 12px;
                white-space: nowrap;
            }
            
            .content {
                padding: 10px;
            }
            
            .table-container {
                font-size: 12px;
            }
            
            table th, table td {
                padding: 8px 6px;
            }
            
            .btn {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .login-box {
                width: 90%;
                max-width: 350px;
                padding: 30px 25px;
            }
            
            /* åœ¨çº¿ç”¨æˆ·é¡µé¢é€‚é… */
            #online > div {
                grid-template-columns: 1fr !important;
                height: auto !important;
            }
            
            #online .table-container {
                max-height: 200px;
            }
            
            /* è´Ÿè½½å‡è¡¡ç§»åŠ¨ç«¯é€‚é… */
            #lbStatsRow {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            #lbExitCards {
                grid-template-columns: 1fr !important;
            }
            
            /* æ¿€æ´»ç è¡¨æ ¼ç§»åŠ¨ç«¯é€‚é… */
            .license-table-wrap {
                max-height: 50vh !important;
                min-height: 200px;
                -webkit-overflow-scrolling: touch;
            }
            
            .license-table-wrap table {
                min-width: 650px;
            }
            
            /* æ¿€æ´»ç ç®¡ç†é¡¶éƒ¨å·¥å…·æ  */
            #license > div:first-child {
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            /* èŠå¤©åŒºåŸŸé€‚é… */
            #chatMessages {
                height: 200px !important;
                flex: none !important;
            }
        }
        
        /* æ¨ªå±æ—¶éšè—æç¤º */
        @media screen and (orientation: landscape) {
            .rotate-hint {
                display: none !important;
            }
        }
        
        /* ç«–å±ä¸”æ˜¯ç§»åŠ¨è®¾å¤‡æ—¶æ˜¾ç¤ºæç¤º */
        @media screen and (orientation: portrait) and (max-width: 768px) {
            .rotate-hint {
                display: flex !important;
            }
        }
        /* Lucideå›¾æ ‡æ ·å¼ */
        .tab-icon {
            width: 16px;
            height: 16px;
            vertical-align: -2px;
            margin-right: 4px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }
        
        .tab.active .tab-icon {
            filter: drop-shadow(0 0 4px rgba(0, 212, 255, 0.5));
        }
    </style>
</head>
<body>
    <!-- æ¨ªå±æç¤º -->
    <div class="rotate-hint" id="rotateHint">
        <div class="icon"><svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="rgba(0,212,255,0.8)" stroke-width="1.5"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></div>
        <h2>è¯·æ—‹è½¬è®¾å¤‡</h2>
        <p>ä¸ºäº†è·å¾—æœ€ä½³ä½“éªŒï¼Œ<br>è¯·å°†æ‰‹æœºæ¨ªå±ä½¿ç”¨</p>
    </div>
    
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h2>AKåå°ç›‘æ§ç³»ç»Ÿ</h2>
            <p class="subtitle">ç®¡ç†å‘˜ç™»å½•</p>
            <input type="password" class="login-input" id="loginPassword" 
                   placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " onkeypress="if(event.keyCode===13)doLogin()">
            <button class="login-btn" onclick="doLogin()"> ç™» å½•</button>
            <p class="login-error" id="loginError">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹ -->
    <div class="main-content" id="mainContent">
    <header class="header">
        <h1>AKåå°ç›‘æ§ç³»ç»Ÿ</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <!-- æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢ -->
            <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary);">
                <span>æ˜¾ç¤ºæ¨¡å¼:</span>
                <div style="display: flex; background: var(--bg-primary); border-radius: 4px; border: 1px solid var(--border); overflow: hidden;">
                    <div id="modeFullBtn" onclick="setViewMode(false)" 
                         style="padding: 4px 10px; cursor: pointer; color: white; background: var(--accent); transition: all 0.2s;">å®Œå…¨</div>
                    <div id="modeCompactBtn" onclick="setViewMode(true)" 
                         style="padding: 4px 10px; cursor: pointer; color: var(--text-secondary); background: transparent; transition: all 0.2s;">ç²¾ç®€</div>
                </div>
            </div>
            <!-- æƒé™æ ‡è¯† -->
            <div class="role-badge" id="roleBadge">
                <span class="role-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7z" fill="rgba(255,215,0,0.3)"/><path d="M4 22h16"/></svg></span>
                <span class="role-text" id="roleText">åŠ è½½ä¸­...</span>
            </div>
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">è¿æ¥ä¸­...</span>
            </div>
            <button onclick="logout()" style="padding: 8px 16px; background: var(--accent-red); border: none; 
                    border-radius: 6px; color: white; cursor: pointer; font-size: 13px;">
                é€€å‡ºç™»å½•
            </button>
        </div>
    </header>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="label">æ€»ç”¨æˆ·æ•°</div>
            <div class="value" id="statUsers">-</div>
        </div>
        <div class="stat-card green">
            <div class="label">ä»Šæ—¥ç™»å½•</div>
            <div class="value" id="statToday">-</div>
        </div>
        <div class="stat-card yellow">
            <div class="label">æ€»ç™»å½•æ¬¡æ•°</div>
            <div class="value" id="statLogins">-</div>
        </div>
        <div class="stat-card">
            <div class="label">ç‹¬ç«‹IP</div>
            <div class="value" id="statIPs">-</div>
        </div>
        <div class="stat-card glow-border glow-cyan">
            <div class="label">æ€»AKæ•°é‡</div>
            <div class="value" id="statTotalAce">-</div>
        </div>
        <div class="stat-card glow-border glow-green">
            <div class="label">æ€»EP</div>
            <div class="value" id="statTotalEP" style="color: var(--accent-green);">-</div>
        </div>
        <div class="stat-card glow-border glow-pink">
            <div class="label">æ€»SP</div>
            <div class="value" id="statTotalSP" style="color: #ff6b9d;">-</div>
        </div>
        <div class="stat-card glow-border glow-yellow">
            <div class="label">æ€»RP</div>
            <div class="value" id="statTotalRP" style="color: #f7b731;">-</div>
        </div>
        <div class="stat-card glow-border glow-purple">
            <div class="label">æ€»TP</div>
            <div class="value" id="statTotalTP" style="color: #a55eea;">-</div>
        </div>
        <div class="stat-card red">
            <div class="label">å°ç¦æ•°é‡</div>
            <div class="value" id="statBanned">-</div>
        </div>
    </div>
    
    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
        <div class="tab active" data-panel="dashboard" id="tabDashboard"><svg class="tab-icon" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> æµé‡ä»ªè¡¨ç›˜</div>
        <div class="tab" data-panel="online"><svg class="tab-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" fill="rgba(0,255,136,0.3)"/><circle cx="12" cy="12" r="2" fill="#00ff88"/></svg> åœ¨çº¿ç”¨æˆ·</div>
        <div class="tab" data-panel="usage"><svg class="tab-icon" viewBox="0 0 24 24"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg> ä½¿ç”¨æƒ…å†µ</div>
        <div class="tab" data-panel="users"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> ç”¨æˆ·ç®¡ç†</div>
        <div class="tab" data-panel="ips"><svg class="tab-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg> IPç®¡ç†</div>
        <div class="tab" data-panel="banlist"><svg class="tab-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg> å°ç¦åˆ—è¡¨</div>
        <div class="tab" data-panel="whitelist"><svg class="tab-icon" viewBox="0 0 24 24"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg> ç™½åå•</div>
        <div class="tab" data-panel="credits"><svg class="tab-icon" viewBox="0 0 24 24"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></svg> ç§¯åˆ†</div>
        <div class="tab" data-panel="license"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z"/><circle cx="16.5" cy="7.5" r=".5" fill="currentColor"/></svg> æ¿€æ´»ç </div>
        <div class="tab" data-panel="database"><svg class="tab-icon" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14a9 3 0 0 0 18 0V5"/><path d="M3 12a9 3 0 0 0 18 0"/></svg> æ•°æ®åº“</div>
        <div class="tab" data-panel="settings"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg> è®¾ç½®</div>
    </div>
    
    <!-- å†…å®¹åŒº -->
    <div class="content">
        <!-- æµé‡ä»ªè¡¨ç›˜ -->
        <div class="panel active" id="dashboard">
            <!-- å®æ—¶æŒ‡æ ‡å¡ç‰‡ -->
            <div class="dashboard-metrics">
                <div class="metric-card">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #00d4ff, #0099cc);"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>
                    <div class="metric-info">
                        <div class="metric-value" id="dashTodayRequests">0</div>
                        <div class="metric-label">ä»Šæ—¥è¯·æ±‚</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #00ff88, #00cc6a);"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
                    <div class="metric-info">
                        <div class="metric-value" id="dashSuccessRate">0%</div>
                        <div class="metric-label">æˆåŠŸç‡</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
                    <div class="metric-info">
                        <div class="metric-value" id="dashActiveUsers">0</div>
                        <div class="metric-label">ä»Šæ—¥æ´»è·ƒ</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 12m-10 0a10 10 0 1 0 20 0 10 10 0 1 0-20 0"/><path d="M12 12 16 6"/><path d="M12 16v-4"/></svg></div>
                    <div class="metric-info">
                        <div class="metric-value" id="dashPeakRPM">0</div>
                        <div class="metric-label">å³°å€¼RPM</div>
                    </div>
                </div>
            </div>
            
            <!-- 24å°æ—¶è¶‹åŠ¿å›¾ -->
            <div class="dashboard-chart">
                <div class="chart-header">
                    <h4>24å°æ—¶è¯·æ±‚è¶‹åŠ¿</h4>
                    <span class="chart-update-time" id="chartUpdateTime">--:--</span>
                </div>
                <div class="chart-container" id="hourlyChart">
                    <!-- æŸ±çŠ¶å›¾å°†ç”±JSç”Ÿæˆ -->
                </div>
                <div class="chart-labels" id="chartLabels">
                    <!-- æ—¶é—´æ ‡ç­¾å°†ç”±JSç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- æ’è¡Œæ¦œåŒºåŸŸ -->
            <div class="dashboard-rankings">
                <!-- Topç”¨æˆ· -->
                <div class="ranking-card">
                    <div class="ranking-header">
                        <h4>ğŸ† ä»Šæ—¥æ´»è·ƒç”¨æˆ· Top10</h4>
                    </div>
                    <div class="ranking-list" id="topUsersList">
                        <div class="ranking-empty">æš‚æ— æ•°æ®</div>
                    </div>
                </div>
                
                <!-- Top IP -->
                <div class="ranking-card">
                    <div class="ranking-header">
                        <h4>ğŸŒ ä»Šæ—¥è®¿é—®IP Top10</h4>
                    </div>
                    <div class="ranking-list" id="topIpsList">
                        <div class="ranking-empty">æš‚æ— æ•°æ®</div>
                    </div>
                </div>
            </div>
            
            <!-- å®æ—¶æ´»åŠ¨æµ -->
            <div class="dashboard-activity">
                <div class="activity-header">
                    <h4>â± å®æ—¶æ´»åŠ¨</h4>
                    <span class="activity-status">â— å®æ—¶æ›´æ–°ä¸­</span>
                </div>
                <div class="activity-stream" id="activityStream">
                    <div class="activity-empty">ç­‰å¾…æ´»åŠ¨æ•°æ®...</div>
                </div>
            </div>
        </div>
        
        <!-- åœ¨çº¿ç”¨æˆ· -->
        <div class="panel" id="online">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: calc(100vh - 350px);">
                <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
                <div class="table-container" style="overflow: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·å</th>
                                <th>å½“å‰æ“ä½œ</th>
                                <th>ä¸Šçº¿æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="onlineTable">
                            <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">æš‚æ— åœ¨çº¿ç”¨æˆ·</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- èŠå¤©åŒºåŸŸ -->
                <div style="background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column;">
                    <div style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0; color: var(--accent);"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> ä¸ <span id="chatTarget">-</span> èŠå¤©</h4>
                        <span id="chatStatus" style="font-size: 12px; color: var(--text-secondary);">é€‰æ‹©ç”¨æˆ·å¼€å§‹èŠå¤©</span>
                    </div>
                    <div id="chatMessages" style="flex: 1; padding: 15px; overflow-y: auto; background: var(--bg-primary);">
                        <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            ç‚¹å‡»ç”¨æˆ·åˆ—è¡¨ä¸­çš„"èŠå¤©"æŒ‰é’®å¼€å§‹å¯¹è¯
                        </div>
                    </div>
                    <div style="padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 10px;">
                        <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled
                               style="flex: 1; padding: 10px 15px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 20px; color: var(--text-primary); outline: none;">
                        <button class="btn btn-primary" id="chatSendBtn" onclick="sendChatMessage()" disabled>å‘é€</button>
                    </div>
                    <div style="padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="broadcastInput" placeholder="ç¾¤å‘æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·..."
                               style="flex: 1; padding: 10px 15px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 20px; color: var(--text-primary); outline: none;">
                        <button class="btn" style="background: linear-gradient(135deg, #f39c12, #e74c3c);" onclick="broadcastMessage()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px"><path d="m3 11 18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg> ç¾¤å‘</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä½¿ç”¨æƒ…å†µï¼ˆç™»å½•å°è¯•è®°å½•ï¼‰ -->
        <div class="panel" id="usage">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="usageSearchInput" placeholder="æœç´¢ç”¨æˆ·å..." 
                       style="flex: 1; max-width: 300px; padding: 10px 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                       oninput="searchUsage()">
                <button class="btn btn-primary" onclick="searchUsage()" style="padding: 10px 20px;">æœç´¢</button>
                <button class="btn-page" onclick="clearUsageSearch()" style="padding: 10px 20px;">æ¸…é™¤</button>
                <span id="usageSearchCount" style="color: var(--text-secondary); font-size: 14px; margin-left: auto;"></span>
            </div>
            <div class="table-container" style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·å</th>
                            <th>å¯†ç </th>
                            <th>ç™»å½•æ¬¡æ•°</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="usageTable">
                        <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ç”¨æˆ·ç®¡ç†ï¼ˆç”¨æˆ·èµ„äº§ä¿¡æ¯ï¼‰ -->
        <div class="panel" id="users">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="usersSearchInput" placeholder="æœç´¢ç”¨æˆ·å..." 
                       style="flex: 1; max-width: 300px; padding: 10px 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                       oninput="searchUsers()" onkeypress="if(event.keyCode===13)searchUsers()">
                <button class="btn btn-primary" onclick="searchUsers()" style="padding: 10px 20px;">æœç´¢</button>
                <button class="btn-page" onclick="clearUsersSearch()" style="padding: 10px 20px;">æ¸…é™¤</button>
                <label style="display: flex; align-items: center; gap: 6px; color: var(--text-secondary); font-size: 14px; cursor: pointer; margin-left: 10px;">
                    <input type="checkbox" id="usersLoadAll" onchange="onUsersLoadAllChange()" style="cursor: pointer; width: 16px; height: 16px; accent-color: var(--accent);">
                    åŠ è½½å…¨éƒ¨
                </label>
                <span id="usersSearchCount" style="color: var(--text-secondary); font-size: 14px; margin-left: auto;"></span>
            </div>
            <div class="table-container" style="overflow-x: auto;">
                <table style="min-width: 1800px;">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·å</th>
                            <th class="sortable" onclick="sortUsersBy('login_count')" data-field="login_count">ç™»å½•æ¬¡æ•° <span class="sort-icon" id="sort-login_count">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('ace_count')" data-field="ace_count">ä¸»è´¦æˆ·AK <span class="sort-icon" id="sort-ace_count">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('total_ace')" data-field="total_ace">å­è´¦æˆ·AK <span class="sort-icon" id="sort-total_ace">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('ep')" data-field="ep">EP <span class="sort-icon" id="sort-ep">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('sp')" data-field="sp">SP <span class="sort-icon" id="sort-sp">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('rp')" data-field="rp">RP <span class="sort-icon" id="sort-rp">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('tp')" data-field="tp">TP <span class="sort-icon" id="sort-tp">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('weekly_money')" data-field="weekly_money">æœ¬å‘¨æ”¶ç›Š <span class="sort-icon" id="sort-weekly_money">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('left_area')" data-field="left_area">å·¦åŒº <span class="sort-icon" id="sort-left_area">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('right_area')" data-field="right_area">å³åŒº <span class="sort-icon" id="sort-right_area">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('direct_push')" data-field="direct_push">ç›´æ¨ <span class="sort-icon" id="sort-direct_push">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('sub_account')" data-field="sub_account">å­è´¦å· <span class="sort-icon" id="sort-sub_account">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('honor_name')" data-field="honor_name">ç­‰çº§ <span class="sort-icon" id="sort-honor_name">â‡…</span></th>
                            <th class="sortable" onclick="sortUsersBy('updated_at')" data-field="updated_at">æ›´æ–°æ—¶é—´ <span class="sort-icon" id="sort-updated_at">â‡…</span></th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <tr><td colspan="15" style="text-align: center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="usersPagination" style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 15px; padding: 10px 0;">
                <button class="btn-page" onclick="usersGoPage(0)" id="usersFirstBtn" disabled>é¦–é¡µ</button>
                <button class="btn-page" onclick="usersGoPage(usersCurrentPage - 1)" id="usersPrevBtn" disabled>ä¸Šä¸€é¡µ</button>
                <span id="usersPageInfo" style="color: var(--text-secondary); font-size: 14px; min-width: 120px; text-align: center;">ç¬¬ 1 é¡µ</span>
                <button class="btn-page" onclick="usersGoPage(usersCurrentPage + 1)" id="usersNextBtn" disabled>ä¸‹ä¸€é¡µ</button>
                <button class="btn-page" onclick="usersGoPage(usersTotalPages - 1)" id="usersLastBtn" disabled>æœ«é¡µ</button>
            </div>
        </div>
        
        <!-- IPç®¡ç† -->
        <div class="panel" id="ips">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>IPåœ°å€</th>
                            <th>è¯·æ±‚æ¬¡æ•°</th>
                            <th>é¦–æ¬¡è®¿é—®</th>
                            <th>æœ€åè®¿é—®</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="ipsTable">
                        <tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- å°ç¦åˆ—è¡¨ -->
        <div class="panel" id="banlist">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ç±»å‹</th>
                            <th>å€¼</th>
                            <th>å°ç¦æ—¶é—´</th>
                            <th>åŸå› </th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="banlistTable">
                        <tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æ¿€æ´»ç ç®¡ç† -->
        <div class="panel" id="license">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h3 style="margin: 0; color: var(--accent);"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px"><path d="M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z"/><circle cx="16.5" cy="7.5" r=".5" fill="currentColor"/></svg> æ¿€æ´»ç ç®¡ç†</h3>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="licenseSearch" placeholder="æœç´¢æ¿€æ´»ç ..." 
                           style="padding: 8px 15px; background: var(--bg-card); border: 1px solid var(--border); 
                                  border-radius: 8px; color: var(--text-primary); width: 180px;"
                           onkeypress="if(event.keyCode===13)searchLicenses()">
                    <select id="licBillingFilter" onchange="applyLicenseFilters()" 
                            style="padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 13px;">
                        <option value="">å…¨éƒ¨è®¡è´¹</option>
                        <option value="per_use">æŒ‰æ¬¡æ•°</option>
                        <option value="time_based">æŒ‰æ—¶é—´</option>
                        <option value="unlimited">æ— é™åˆ¶</option>
                    </select>
                    <select id="licStatusFilter" onchange="applyLicenseFilters()" 
                            style="padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); 
                                   border-radius: 8px; color: var(--text-primary); font-size: 13px;">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="active">å·²æ¿€æ´»</option>
                        <option value="inactive">æœªæ¿€æ´»</option>
                        <option value="expired">å·²è¿‡æœŸ</option>
                        <option value="revoked">å·²æ’¤é”€</option>
                    </select>
                    <button onclick="searchLicenses()" class="btn btn-primary" style="padding: 8px 15px;">æœç´¢</button>
                    <button onclick="clearLicenseFilters()" class="btn-page" style="padding: 8px 15px;">æ¸…é™¤</button>
                    <button onclick="showCreateLicenseModal()" class="btn btn-primary" style="padding: 8px 15px; background: linear-gradient(135deg, #00ff88, #00cc6a);">
                        â• åˆ›å»ºæ¿€æ´»ç 
                    </button>
                </div>
            </div>
            
            <!-- æ¿€æ´»ç ç»Ÿè®¡ -->
            <div class="license-stats overview-section" id="licenseStatsGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="stat-mini" style="background: var(--bg-card); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
                    <div style="color: var(--text-secondary); font-size: 12px;">æ€»æ¿€æ´»ç </div>
                    <div style="color: var(--accent); font-size: 24px; font-weight: bold;" id="licStatTotal">-</div>
                </div>
                <div class="stat-mini" style="background: var(--bg-card); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
                    <div style="color: var(--text-secondary); font-size: 12px;">å·²æ¿€æ´»</div>
                    <div style="color: var(--accent-green); font-size: 24px; font-weight: bold;" id="licStatActive">-</div>
                </div>
                <div class="stat-mini" style="background: var(--bg-card); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
                    <div style="color: var(--text-secondary); font-size: 12px;">æ´»è·ƒå®¢æˆ·ç«¯</div>
                    <div style="color: #667eea; font-size: 24px; font-weight: bold;" id="licStatClients">-</div>
                </div>
                <div class="stat-mini" style="background: var(--bg-card); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
                    <div style="color: var(--text-secondary); font-size: 12px;">é»‘åå•</div>
                    <div style="color: var(--accent-red); font-size: 24px; font-weight: bold;" id="licStatBlacklist">-</div>
                </div>
            </div>
            
            <!-- å­æ ‡ç­¾åˆ‡æ¢ -->
            <div style="display: flex; gap: 0; margin-bottom: 15px; border-bottom: 2px solid var(--border);">
                <button class="btn" id="licTabList" onclick="switchLicenseTab('list')" 
                        style="padding: 10px 20px; border-radius: 8px 8px 0 0; border: 2px solid var(--border); border-bottom: none; 
                               margin-bottom: -2px; background: var(--accent); color: #fff; font-weight: bold;">
                    æ¿€æ´»ç åˆ—è¡¨
                </button>
                <button class="btn" id="licTabCreate" onclick="switchLicenseTab('create')" 
                        style="padding: 10px 20px; border-radius: 8px 8px 0 0; border: 2px solid var(--border); border-bottom: none; 
                               margin-bottom: -2px; background: var(--bg-card); color: var(--text-secondary);">
                    åˆ›å»ºè®°å½•
                </button>
                <button class="btn" id="licTabUsage" onclick="switchLicenseTab('usage')" 
                        style="padding: 10px 20px; border-radius: 8px 8px 0 0; border: 2px solid var(--border); border-bottom: none; 
                               margin-bottom: -2px; background: var(--bg-card); color: var(--text-secondary);">
                    ä½¿ç”¨è®°å½•
                </button>
            </div>
            
            <!-- æ¿€æ´»ç åˆ—è¡¨ -->
            <div id="licPanelList">
                <div class="table-container license-table-wrap" style="overflow: auto; max-height: max(300px, calc(100vh - 500px));">
                    <table>
                        <thead>
                            <tr>
                                <th>æ¿€æ´»ç </th>
                                <th>äº§å“</th>
                                <th>è®¡è´¹æ¨¡å¼</th>
                                <th class="sortable" onclick="toggleLicenseSort()" style="cursor: pointer; user-select: none;">
                                    å‰©ä½™ <span id="licSortIcon" style="font-size: 12px;">â‡…</span>
                                </th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="licenseTable">
                            <tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="licensePagination" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;"></div>
            </div>
            
            <!-- åˆ›å»ºè®°å½• -->
            <div id="licPanelCreate" style="display: none;">
                <div class="table-container license-table-wrap" style="overflow: auto; max-height: max(300px, calc(100vh - 500px));">
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>æ¿€æ´»ç </th>
                                <th>äº§å“</th>
                                <th>è®¡è´¹æ¨¡å¼</th>
                                <th>è¯¦æƒ…</th>
                                <th>æ“ä½œäºº</th>
                            </tr>
                        </thead>
                        <tbody id="licCreateLogsTable">
                            <tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="licCreateLogsPagination" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;"></div>
            </div>
            
            <!-- ä½¿ç”¨è®°å½• -->
            <div id="licPanelUsage" style="display: none;">
                <div class="table-container license-table-wrap" style="overflow: auto; max-height: max(300px, calc(100vh - 500px));">
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>æ¿€æ´»ç </th>
                                <th>æ“ä½œ</th>
                                <th>è¯¦æƒ…</th>
                                <th>æ“ä½œäºº</th>
                            </tr>
                        </thead>
                        <tbody id="licUsageLogsTable">
                            <tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="licUsageLogsPagination" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;"></div>
            </div>
        </div>
        
        <!-- æ•°æ®åº“ç®¡ç† -->
        <div class="panel" id="database">
            <!-- äºŒçº§å¯†ç éªŒè¯æç¤º -->
            <div id="dbAuthOverlay" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px;">
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 40px; max-width: 400px; width: 100%; text-align: center;">
                    <h3 style="color: var(--accent); margin-bottom: 10px;">æ•°æ®åº“æ“ä½œéªŒè¯</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 25px; font-size: 14px;">
                        æ•°æ®åº“æ“ä½œéœ€è¦äºŒçº§å¯†ç éªŒè¯<br>éªŒè¯é€šè¿‡åæœ‰æ•ˆæœŸ30åˆ†é’Ÿ
                    </p>
                    <button onclick="showDbAuthModal()" class="btn btn-primary" 
                            style="padding: 12px 40px; font-size: 15px; font-weight: bold;">
                        éªŒè¯å¯†ç 
                    </button>
                </div>
            </div>
            
            <!-- æ•°æ®åº“æ“ä½œç•Œé¢ï¼ˆéªŒè¯åæ˜¾ç¤ºï¼‰ -->
            <div id="dbContent" style="display: none;">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                    <select id="dbTableSelect" onchange="loadTableData()" style="padding: 10px 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 200px;">
                        <option value="">é€‰æ‹©è¡¨...</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadTableData()" style="padding: 10px 20px;">åˆ·æ–°</button>
                    <button class="btn btn-primary" onclick="showAddRowModal()" style="padding: 10px 20px;">â• æ–°å¢</button>
                    <button class="btn btn-danger" onclick="showSqlModal()" style="padding: 10px 20px;">æ‰§è¡ŒSQL</button>
                    <button id="dbBatchDeleteBtn" class="btn btn-danger" onclick="batchDeleteDbRows()" style="padding: 10px 20px; display:none;">æ‰¹é‡åˆ é™¤ (<span id="dbSelectedCount">0</span>)</button>
                    <span id="dbRowCount" style="color: var(--text-secondary); font-size: 14px; margin-left: auto;"></span>
                    <button class="btn" onclick="lockDatabase()" style="padding: 10px 20px; background: var(--bg-secondary); color: #ff5252; border: 1px solid #ff5252;">ğŸ”’ é”å®š</button>
                </div>
                
                <div class="table-container" style="overflow: auto; max-height: max(300px, calc(100vh - 400px));">
                    <table id="dbTable" style="min-width: 100%;">
                        <thead id="dbTableHead">
                            <tr><th>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¡¨</th></tr>
                        </thead>
                        <tbody id="dbTableBody">
                            <tr><td style="text-align: center; color: var(--text-secondary); padding: 40px;">ä»ä¸Šæ–¹ä¸‹æ‹‰èœå•é€‰æ‹©è¦æŸ¥çœ‹çš„è¡¨</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µ -->
                <div id="dbPagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;"></div>
            </div>
        </div>
        
        <!-- ç™½åå•ç®¡ç† -->
        <div class="panel" id="whitelist">
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h3 style="color: var(--accent); margin: 0;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg> æˆæƒç™½åå•</h3>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="wlBalanceInfo" style="font-size: 13px; color: var(--accent-yellow);"></span>
                        <input type="text" id="wlSearch" placeholder="æœç´¢è´¦å·..." onkeyup="if(event.key==='Enter')loadWhitelist()"
                               style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px; width: 160px;">
                        <button class="btn" onclick="loadWhitelist()" style="padding: 6px 14px; font-size: 13px;">æœç´¢</button>
                        <button class="btn btn-success" onclick="showAddWhitelistModal()" style="padding: 6px 14px; font-size: 13px;">â• æˆæƒ</button>
                    </div>
                </div>
                <!-- å³å°†åˆ°æœŸæé†’ -->
                <div id="wlExpiringAlert" style="display:none; background: rgba(255,165,0,0.1); border: 1px solid rgba(255,165,0,0.3); border-radius: 8px; padding: 10px 15px; margin-bottom: 12px;">
                    <span style="color: #ffa500; font-weight: bold;">âš ï¸ å³å°†åˆ°æœŸ:</span>
                    <span id="wlExpiringList" style="color: var(--text-secondary); font-size: 13px;"></span>
                </div>
                <!-- ç™½åå•è¡¨æ ¼ -->
                <div style="overflow-x: auto;">
                    <table>
                        <thead><tr>
                            <th>è´¦å·</th><th>å§“å</th><th>è®¡è´¹æ–¹å¼</th><th>åˆ°æœŸæ—¶é—´</th><th>çŠ¶æ€</th><th>å¼ºåŒ–ç™»å½•</th><th>æ·»åŠ äºº</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th>
                        </tr></thead>
                        <tbody id="wlTableBody"><tr><td colspan="9" style="text-align:center; color:var(--text-secondary);">åŠ è½½ä¸­...</td></tr></tbody>
                    </table>
                </div>
                <div id="wlPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 12px;"></div>
            </div>
        </div>

        <!-- ç§¯åˆ†ç®¡ç† -->
        <div class="panel" id="credits">
            <div>
                <h3 style="margin-bottom: 15px; color: var(--accent);"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></svg> ç§¯åˆ†ç®¡ç†</h3>
                <!-- ç§¯åˆ†æ¦‚è§ˆï¼ˆæ€»ç®¡ç†å¯è§ï¼‰ -->
                <div id="creditsOverviewSection">
                    <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: var(--accent-yellow); margin-bottom: 12px;">å­ç®¡ç†å‘˜ç§¯åˆ†æ¦‚è§ˆ</h4>
                        <div id="creditsOverviewTable" style="overflow-x: auto;">
                            <table><thead><tr><th>åç§°</th><th>ä½™é¢</th><th>æ´»è·ƒè´¦å·</th><th>æ€»è´¦å·</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="creditsOverviewBody"><tr><td colspan="5" style="text-align:center; color:var(--text-secondary);">åŠ è½½ä¸­...</td></tr></tbody></table>
                        </div>
                    </div>
                    <!-- å……å€¼ -->
                    <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #00ff88; margin-bottom: 12px;">å……å€¼ç§¯åˆ†</h4>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end;">
                            <div><label style="display:block; font-size:11px; color:var(--text-secondary); margin-bottom:4px;">å­ç®¡ç†å‘˜</label>
                                <input id="topupAdminName" placeholder="åç§°" style="padding:8px 10px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:13px; width:120px;"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-secondary); margin-bottom:4px;">ç§¯åˆ†æ•°é‡</label>
                                <input id="topupAmount" type="number" min="1" placeholder="æ•°é‡" style="padding:8px 10px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:13px; width:100px;"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-secondary); margin-bottom:4px;">å¤‡æ³¨</label>
                                <input id="topupDesc" placeholder="å¯é€‰" style="padding:8px 10px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:13px; width:150px;"></div>
                            <button class="btn btn-success" onclick="doTopup()" style="padding:8px 16px; font-size:13px;">å……å€¼</button>
                        </div>
                        <div id="topupMsg" style="display:none; margin-top:8px; font-size:13px; padding:6px 10px; border-radius:6px;"></div>
                    </div>
                </div>
                <!-- ç§¯åˆ†å®šä»·é…ç½®ï¼ˆæ€»ç®¡ç†å¯è§ï¼‰ -->
                <div id="creditConfigSection">
                    <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="color: #45aaf2; margin-bottom: 12px;">ç§¯åˆ†å®šä»·é…ç½®</h4>
                        <div id="creditConfigList" style="margin-bottom: 12px;"></div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end;">
                            <div><label style="display:block; font-size:11px; color:var(--text-secondary); margin-bottom:4px;">ç±»å‹æ ‡è¯†</label>
                                <input id="cfgPlanType" placeholder="å¦‚ monthly" style="padding:6px 10px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:12px; width:100px;"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-secondary); margin-bottom:4px;">æ˜¾ç¤ºå</label>
                                <input id="cfgPlanName" placeholder="å¦‚ æœˆä»˜" style="padding:6px 10px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:12px; width:80px;"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-secondary); margin-bottom:4px;">ç§¯åˆ†</label>
                                <input id="cfgCredits" type="number" min="1" style="padding:6px 10px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:12px; width:70px;"></div>
                            <div><label style="display:block; font-size:11px; color:var(--text-secondary); margin-bottom:4px;">å¤©æ•°</label>
                                <input id="cfgDays" type="number" min="1" style="padding:6px 10px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:12px; width:70px;"></div>
                            <button class="btn" onclick="saveCreditConfig()" style="padding:6px 14px; font-size:12px;">ä¿å­˜</button>
                            <button class="btn" onclick="clearCreditConfigForm()" style="padding:6px 14px; font-size:12px; background:#ff5252; color:#fff;">æ¸…ç©º</button>
                        </div>
                    </div>
                </div>
                <!-- ç§¯åˆ†æµæ°´ -->
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #fc5c65; margin: 0;">ğŸ“œ ç§¯åˆ†æµæ°´</h4>
                        <select id="txFilterAdmin" onchange="loadCreditTransactions()" style="padding:5px 8px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:12px;">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div style="overflow-x: auto;">
                        <table><thead><tr><th>æ—¶é—´</th><th>ç®¡ç†å‘˜</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>ä½™é¢</th><th>è¯´æ˜</th><th>æ“ä½œäºº</th></tr></thead>
                        <tbody id="txTableBody"><tr><td colspan="7" style="text-align:center; color:var(--text-secondary);">åŠ è½½ä¸­...</td></tr></tbody></table>
                    </div>
                    <div id="txPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 12px;"></div>
                </div>
            </div>
        </div>

        <!-- è®¾ç½® -->
        <div class="panel" id="settings">
            <div>
                <h3 style="margin-bottom: 15px; color: var(--accent);"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg> ç³»ç»Ÿè®¾ç½®</h3>
                
                <!-- å­ç®¡ç†å‘˜ç®¡ç†ï¼ˆä»…ç³»ç»Ÿæ€»ç®¡ç†å¯è§ï¼‰ -->
                <div id="subAdminSection" style="display: none;">
                    <div style="background: linear-gradient(135deg, var(--bg-card), #1e2a4a); border-radius: 12px; padding: 15px; border: 1px solid #667eea;">
                        <h4 style="margin-bottom: 20px; color: #667eea; display: flex; align-items: center; gap: 10px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> å­ç®¡ç†å‘˜ç®¡ç†
                            <span id="subAdminCount" style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">ï¼ˆä»…ç³»ç»Ÿæ€»ç®¡ç†å¯æ“ä½œï¼‰</span>
                        </h4>
                        
                        <!-- å­ç®¡ç†å‘˜åˆ—è¡¨ -->
                        <div id="subAdminList" style="margin-bottom: 15px; max-height: 320px; overflow-y: auto;">
                            <span style="color: var(--text-secondary);">åŠ è½½ä¸­...</span>
                        </div>
                        
                        <!-- æ·»åŠ /æ›´æ–°å­ç®¡ç†å‘˜ -->
                        <div style="background: var(--bg-primary); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px; color: var(--accent); font-size: 14px; font-weight: bold;">â• æ·»åŠ /æ›´æ–°å­ç®¡ç†å‘˜</div>
                            
                            <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 120px;">
                                    <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 11px;">åç§°</label>
                                    <input type="text" id="newSubAdminName" placeholder="å¦‚ï¼šè¿è¥1å·" 
                                           style="width: 100%; padding: 8px 10px; background: var(--bg-secondary); border: 1px solid var(--border); 
                                                  border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                </div>
                                <div style="flex: 1; min-width: 100px;">
                                    <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 11px;">ç™»å½•å¯†ç </label>
                                    <input type="password" id="newSubAdminPassword" placeholder="è‡³å°‘6ä½" 
                                           style="width: 100%; padding: 8px 10px; background: var(--bg-secondary); border: 1px solid var(--border); 
                                                  border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                </div>
                                <div style="flex: 1; min-width: 100px;">
                                    <label style="display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 11px;">æ€»ç®¡ç†å¯†ç </label>
                                    <input type="password" id="subAdminSuperPassword" placeholder="éªŒè¯èº«ä»½" 
                                           style="width: 100%; padding: 8px 10px; background: var(--bg-secondary); border: 1px solid var(--border); 
                                                  border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                </div>
                                <div style="flex: 1; min-width: 100px;">
                                    <label style="display: block; margin-bottom: 4px; color: var(--accent-yellow); font-size: 11px;">ğŸ”‘ äºŒçº§å¯†ç </label>
                                    <input type="password" id="subAdminSecondaryPassword" placeholder="ç¡®è®¤æ“ä½œ" 
                                           style="width: 100%; padding: 8px 10px; background: var(--bg-secondary); border: 1px solid var(--accent-yellow); 
                                                  border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                </div>
                            </div>
                            
                            <!-- æƒé™é…ç½® -->
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="color: var(--accent); font-size: 12px; font-weight: bold;">ğŸ›¡ï¸ æƒé™</span>
                                    <button type="button" onclick="toggleAllPerms(true)" style="padding: 1px 8px; font-size: 10px; background: transparent; color: var(--accent); border: 1px solid var(--accent); border-radius: 3px; cursor: pointer;">å…¨é€‰</button>
                                    <button type="button" onclick="toggleAllPerms(false)" style="padding: 1px 8px; font-size: 10px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border); border-radius: 3px; cursor: pointer;">æ¸…ç©º</button>
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px 12px; background: var(--bg-secondary); border-radius: 6px; padding: 8px 10px;">
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-primary); white-space: nowrap;">
                                        <input type="checkbox" id="perm_dashboard" value="dashboard"> ğŸ“ˆä»ªè¡¨ç›˜
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-primary); white-space: nowrap;">
                                        <input type="checkbox" id="perm_online" value="online"> ğŸŸ¢åœ¨çº¿
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-primary); white-space: nowrap;">
                                        <input type="checkbox" id="perm_usage" value="usage"> ğŸ“Šä½¿ç”¨
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-primary); white-space: nowrap;">
                                        <input type="checkbox" id="perm_users" value="users"> ğŸ‘¥ç”¨æˆ·
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-primary); white-space: nowrap;">
                                        <input type="checkbox" id="perm_ips" value="ips"> ğŸŒIP
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-primary); white-space: nowrap;">
                                        <input type="checkbox" id="perm_banlist" value="banlist"> ğŸš«å°ç¦
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-primary); white-space: nowrap;">
                                        <input type="checkbox" id="perm_license" value="license"> ğŸ”‘æ¿€æ´»ç 
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; color: var(--text-primary); white-space: nowrap;">
                                        <input type="checkbox" id="perm_database" value="database"> ğŸ—„ï¸æ•°æ®åº“
                                    </label>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                                <button onclick="setSubAdmin()" class="btn btn-primary" style="flex: 1; padding: 8px; font-size: 13px;">
                                    âœ… æ·»åŠ /æ›´æ–°å­ç®¡ç†å‘˜
                                </button>
                                <button id="updatePermBtn" onclick="updateSubAdminPermissions()" style="display: none; padding: 8px 14px; background: var(--bg-secondary); color: var(--accent); border: 1px solid var(--accent); border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    ğŸ›¡ï¸ æ›´æ–°æƒé™
                                </button>
                                <button onclick="kickAllSubAdmins()" style="padding: 8px 14px; background: var(--bg-secondary); color: var(--accent-yellow); border: 1px solid rgba(255,165,2,0.3); border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    è¸¢å‡ºå…¨éƒ¨
                                </button>
                            </div>
                        </div>
                        
                        <div id="subAdminMsg" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                    </div>
                </div>
                
                <!-- ä»£ç†æ± çŠ¶æ€ï¼ˆå·²éšè—ï¼Œè¢«è´Ÿè½½å‡è¡¡æ›¿ä»£ï¼‰ -->
                <div id="proxyPoolSection" style="display: none !important; margin-top: 15px;">
                </div>

                <!-- å‡ºå£è´Ÿè½½å‡è¡¡ (ä»…ç³»ç»Ÿæ€»ç®¡ç†å¯è§) -->
                <div id="loadBalanceSection" style="display: none; margin-top: 15px;">
                    <div style="background: linear-gradient(135deg, var(--bg-card), #1a2332); border-radius: 12px; padding: 15px; border: 1px solid rgba(102,126,234,0.4);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                            <h4 style="margin: 0; color: #667eea; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 22px;">âš¡</span> å‡ºå£è´Ÿè½½å‡è¡¡
                            </h4>
                            <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                                <span id="lbSummary" style="font-size: 12px; color: var(--text-secondary);"></span>
                                <button class="btn" onclick="lbReloadSingbox()" id="lbReloadBtn" style="padding: 4px 10px; font-size: 12px; background: var(--bg-secondary); color: var(--accent-yellow); border: 1px solid rgba(255,165,2,0.3);">ğŸ”„ çƒ­é‡è½½</button>
                                <button class="btn" onclick="lbDetectIPs()" style="padding: 4px 10px; font-size: 12px; background: rgba(102,126,234,0.15); color: #667eea; border: 1px solid rgba(102,126,234,0.3);">åˆ·æ–°IP</button>
                                <button class="btn" onclick="showLbAddModal()" style="padding: 4px 10px; font-size: 12px; background: rgba(0,255,136,0.1); color: #00ff88; border: 1px solid rgba(0,255,136,0.3);">â• æ·»åŠ </button>
                                <button class="btn" onclick="showLbSubModal()" style="padding: 4px 10px; font-size: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none;">ğŸ“¡ å¯¼å…¥è®¢é˜…</button>
                            </div>
                        </div>

                        <!-- æ¦‚è§ˆç»Ÿè®¡ -->
                        <div id="lbStatsRow" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px;">
                            <div style="background: var(--bg-primary); border-radius: 8px; padding: 10px; border: 1px solid var(--border);">
                                <div style="color: var(--text-secondary); font-size: 11px;">æ€»å‡ºå£</div>
                                <div style="color: var(--accent); font-size: 20px; font-weight: bold;" id="lbTotalExits">-</div>
                            </div>
                            <div style="background: var(--bg-primary); border-radius: 8px; padding: 10px; border: 1px solid var(--border);">
                                <div style="color: var(--text-secondary); font-size: 11px;">å¥åº·å‡ºå£</div>
                                <div style="color: var(--accent-green); font-size: 20px; font-weight: bold;" id="lbHealthyExits">-</div>
                            </div>
                            <div style="background: var(--bg-primary); border-radius: 8px; padding: 10px; border: 1px solid var(--border);">
                                <div style="color: var(--text-secondary); font-size: 11px;">æ€»æ´»è·ƒè¿æ¥</div>
                                <div style="color: #667eea; font-size: 20px; font-weight: bold;" id="lbTotalActive">-</div>
                            </div>
                            <div style="background: var(--bg-primary); border-radius: 8px; padding: 10px; border: 1px solid var(--border); cursor:pointer;" onclick="lbShowLoginLimitModal()" title="ç‚¹å‡»è°ƒæ•´ç™»å½•é™é¢">
                                <div style="color: var(--text-secondary); font-size: 11px;">ç™»å½•é™é¢/åˆ† âœï¸</div>
                                <div style="color: var(--accent-yellow); font-size: 20px; font-weight: bold;" id="lbLoginLimit">-</div>
                            </div>
                        </div>

                        <!-- sing-box æœåŠ¡çŠ¶æ€ -->
                        <div id="lbSingboxBar" style="background: var(--bg-primary); border-radius: 6px; padding: 8px 12px; border: 1px solid var(--border); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; font-size: 12px;">
                            <span style="font-weight: bold; color: var(--text-secondary);">sing-box:</span>
                            <span id="lbSbState" style="color: var(--text-secondary);">æ£€æµ‹ä¸­...</span>
                            <span id="lbSbNodes" style="color: var(--text-secondary);"></span>
                            <span id="lbSbConfig" style="color: var(--text-secondary); font-size: 10px;"></span>
                        </div>

                        <!-- å‡ºå£æœåŠ¡å™¨å¡ç‰‡åˆ—è¡¨ -->
                        <div id="lbExitCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px;">
                            <div style="text-align: center; color: var(--text-secondary); padding: 30px;">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- ä»£ç†æ± çŠ¶æ€åŸå§‹å†…å®¹(ä¿ç•™ä½†æ°¸è¿œéšè—) -->
                <div id="proxyPoolSectionOld" style="display: none !important; margin-top: 15px;">
                    <div style="background: linear-gradient(135deg, var(--bg-card), #1a2e3a); border-radius: 12px; padding: 15px; border: 1px solid #00c8ff;">
                        <h4 style="margin-bottom: 12px; color: #00c8ff; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">ğŸŒ</span> ä»£ç†æ± çŠ¶æ€
                            <span id="proxyPoolStatus" style="font-size: 12px; font-weight: normal; padding: 2px 8px; border-radius: 10px; background: rgba(255,71,87,0.2); color: var(--accent-red);">æœªå¯ç”¨</span>
                            <span id="ppLastRoute" style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--text-secondary);"></span>
                            <span style="font-size: 11px; color: var(--text-secondary); margin-left: auto;">ç®¡ç†æ“ä½œè¯·ä½¿ç”¨ monitor_manager</span>
                        </h4>

                        <!-- è¿è¡ŒçŠ¶æ€ -->
                        <div id="ppRunningInfo" style="display: none;">
                            <div style="background: var(--bg-primary); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 13px;">
                                    <span>æ€»è¯·æ±‚: <strong id="ppTotalReq" style="color: var(--accent);">0</strong></span>
                                    <span>æˆåŠŸ: <strong id="ppTotalSuccess" style="color: var(--accent-green);">0</strong></span>
                                    <span>å¤±è´¥: <strong id="ppTotalFail" style="color: var(--accent-red);">0</strong></span>
                                    <span>æˆåŠŸç‡: <strong id="ppSuccessRate" style="color: var(--accent-yellow);">N/A</strong></span>
                                    <span>é€Ÿç‡: <strong id="ppRateLimitCur" style="color: var(--accent);">-</strong>/min</span>
                                    <span>èŠ‚ç‚¹: <strong id="ppTotalNodes" style="color: var(--text-secondary);">0</strong></span>
                                </div>
                                <div id="ppTierInfo" style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 12px; margin-top: 6px; color: var(--text-secondary);">
                                    <span>èŠ‚ç‚¹åˆ†çº§: <strong id="ppTierT1" style="color: var(--accent-green);">0</strong> T1(ä¼˜)</span>
                                    <span><strong id="ppTierT2" style="color: var(--accent-yellow);">0</strong> T2(ä¸­)</span>
                                    <span><strong id="ppTierT3" style="color: var(--accent-red);">0</strong> T3(å·®)</span>
                                    <span>çƒ­å¤‡æ± : <strong id="ppReadyPool" style="color: #00c8ff;">0</strong></span>
                                </div>
                                <div id="ppDirectInfo" style="display: none; margin-top: 6px; font-size: 12px;"></div>
                            </div>
                            <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
                            <div style="display: flex; gap: 6px; margin-bottom: 8px;">
                                <button id="ppViewSlots" onclick="switchPPView('slots')" style="padding: 4px 12px; font-size: 12px; border-radius: 6px; border: 1px solid #00c8ff; background: rgba(0,200,255,0.2); color: #00c8ff; cursor: pointer;">æ§½ä½</button>
                                <button id="ppViewNodes" onclick="switchPPView('nodes')" style="padding: 4px 12px; font-size: 12px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-secondary); cursor: pointer;">æ‰€æœ‰èŠ‚ç‚¹</button>
                            </div>
                            <!-- æ§½ä½åˆ—è¡¨ -->
                            <div id="ppSlotList" style="max-height: 300px; overflow-y: auto;"></div>
                            <!-- èŠ‚ç‚¹åˆ—è¡¨ -->
                            <div id="ppNodeList" style="max-height: 400px; overflow-y: auto; display: none;"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    </div><!-- ä¸»å†…å®¹ç»“æŸ -->
    
    <!-- å°ç¦å¼¹çª— -->
    <div class="modal" id="banModal">
        <div class="modal-content" style="max-width: 400px; border: 1px solid rgba(255,50,50,0.3);">
            <h3 style="color: var(--accent-red); border-bottom: 1px solid rgba(255,50,50,0.2); padding-bottom: 12px;">â›“ï¸ å°ç¦ç¡®è®¤</h3>
            <p style="margin: 15px 0; color: var(--text-secondary); font-size: 15px;">
                ç¡®å®šè¦å°ç¦ <strong id="banTarget" style="color: #ff5252; font-size: 16px;"></strong> å—ï¼Ÿ
            </p>
            <input type="text" id="banReason" placeholder="å°ç¦åŸå› ï¼ˆå¯é€‰ï¼‰" style="margin-bottom: 15px;">
            <div class="modal-buttons" style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn" onclick="closeBanModal()" style="flex: 1; max-width: 160px; padding: 12px 0; background: var(--accent-red); color: white; border: none; border-radius: 8px; font-size: 15px;">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmBan()" style="flex: 1; max-width: 160px; padding: 12px 0; border-radius: 8px; font-size: 15px;">ç¡®è®¤å°ç¦</button>
            </div>
        </div>
    </div>
    
    <!-- è§£å°å¼¹çª— -->
    <div class="modal" id="unbanModal">
        <div class="modal-content" style="max-width: 400px; border: 1px solid rgba(38,222,129,0.3);">
            <h3 style="color: var(--accent-green); border-bottom: 1px solid rgba(38,222,129,0.2); padding-bottom: 12px;">ğŸ”“ è§£å°ç¡®è®¤</h3>
            <p style="margin: 15px 0 20px; color: var(--text-secondary); font-size: 15px;">
                ç¡®å®šè¦è§£å° <strong id="unbanTarget" style="color: #26de81; font-size: 16px;"></strong> å—ï¼Ÿ
            </p>
            <div class="modal-buttons" style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn" onclick="closeUnbanModal()" style="flex: 1; max-width: 160px; padding: 12px 0; background: var(--accent-red); color: white; border: none; border-radius: 8px; font-size: 15px;">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="confirmUnban()" style="flex: 1; max-width: 160px; padding: 12px 0; border-radius: 8px; font-size: 15px;">ç¡®è®¤è§£å°</button>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»ºæ¿€æ´»ç å¼¹çª— -->
    <div class="modal" id="createLicenseModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="flex-shrink: 0;">â• åˆ›å»ºæ¿€æ´»ç </h3>
            
            <div style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">äº§å“ç±»å‹</label>
                    <select id="licProductId" onchange="onProductTypeChange()" style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                            border-radius: 8px; color: var(--text-primary);">
                        <option value="ak_admin_panel">ç®¡ç†é¢æ¿ (ak_admin_panel)</option>
                        <option value="auto_sell_system">è‡ªåŠ¨é”€å”®ç³»ç»Ÿ (auto_sell_system)</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">è®¡è´¹æ¨¡å¼</label>
                    <select id="licBillingMode" onchange="onBillingModeChange()" style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                            border-radius: 8px; color: var(--text-primary);">
                        <option value="unlimited">æ— é™åˆ¶ (unlimited)</option>
                        <option value="per_use">æŒ‰æ¬¡æ•° (per_use)</option>
                        <option value="time_based">æŒ‰æ—¶é—´ (time_based)</option>
                    </select>
                </div>
                
                <div id="licMaxUsesRow" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">æœ€å¤§ä½¿ç”¨æ¬¡æ•°</label>
                    <input type="number" id="licMaxUses" value="100" min="1"
                           style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                                  border-radius: 8px; color: var(--text-primary);">
                </div>
                
                <div id="licUsageTimeRow" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">ä½¿ç”¨æ—¶é•¿ï¼ˆå¤©ï¼‰</label>
                    <input type="number" id="licUsageTime" value="30" min="1" step="0.5"
                           style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                                  border-radius: 8px; color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</label>
                    <input type="number" id="licExpiryDays" value="365" min="1" 
                           style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                                  border-radius: 8px; color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">åˆ›å»ºæ•°é‡</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="licBatchCount" value="1" min="1" max="100" 
                               style="flex: 1; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); 
                                      border-radius: 8px; color: var(--text-primary);">
                        <span style="color: var(--text-secondary); font-size: 12px; white-space: nowrap;">æœ€å¤š100ä¸ª</span>
                    </div>
                </div>
                
                <div id="createLicenseMsg" style="margin-bottom: 15px; padding: 10px; border-radius: 6px; display: none; max-height: 150px; overflow-y: auto;"></div>
                
                <!-- åˆ›å»ºè¿›åº¦ -->
                <div id="createLicenseProgress" style="display: none; margin-bottom: 15px;">
                    <div style="background: var(--bg-primary); border-radius: 6px; height: 6px; overflow: hidden;">
                        <div id="createProgressBar" style="height: 100%; background: var(--accent); width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="createProgressText" style="text-align: center; color: var(--text-secondary); font-size: 12px; margin-top: 5px;">0/0</div>
                </div>
            </div>
            
            <div class="modal-buttons" style="flex-shrink: 0;">
                <button class="btn-page" onclick="closeCreateLicenseModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="createLicenseBtn" onclick="doCreateLicense()">åˆ›å»º</button>
            </div>
        </div>
    </div>
    
    <!-- æ¿€æ´»ç è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="licenseDetailModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>ğŸ“‹ æ¿€æ´»ç è¯¦æƒ…</h3>
            <div id="licenseDetailContent" style="max-height: 400px; overflow-y: auto;">
                <!-- å†…å®¹ç”±JSå¡«å…… -->
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="btn" onclick="closeLicenseDetailModal()" style="background: var(--bg-secondary);">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- æ•°æ®åº“äºŒçº§å¯†ç éªŒè¯å¼¹çª— -->
    <div class="modal" id="dbAuthModal">
        <div class="modal-content" style="max-width: 420px; text-align: center;">
            <h3 style="margin-bottom: 10px;">æ•°æ®åº“æ“ä½œéªŒè¯</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                è¯·è¾“å…¥äºŒçº§å¯†ç ä»¥è®¿é—®æ•°æ®åº“æ“ä½œ<br>éªŒè¯é€šè¿‡åæœ‰æ•ˆæœŸ30åˆ†é’Ÿ
            </p>
            <input type="password" id="dbSecondaryPassword" placeholder="è¯·è¾“å…¥äºŒçº§å¯†ç " 
                   onkeypress="if(event.keyCode===13)verifyDbPassword()"
                   style="width: 100%; padding: 14px 18px; background: var(--bg-primary); border: 1px solid var(--border); 
                          border-radius: 10px; color: var(--text-primary); font-size: 15px; margin-bottom: 10px; text-align: center;">
            <p id="dbAuthError" style="color: var(--accent-red); margin-bottom: 10px; font-size: 14px; display: none;"></p>
            <div class="modal-buttons">
                <button class="btn" onclick="closeDbAuthModal()" style="background: var(--bg-secondary);">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="verifyDbPassword()">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <!-- ä¼šè¯å¤±æ•ˆæç¤ºå¼¹çª— -->
    <div class="modal" id="sessionExpiredModal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="font-size: 40px; margin-bottom: 15px; line-height: 1;">âš ï¸</div>
            <h3 style="margin-bottom: 10px; color: var(--text-primary);">ä¼šè¯å·²å¤±æ•ˆ</h3>
            <p id="sessionExpiredMsg" style="color: var(--text-secondary); margin-bottom: 25px; font-size: 14px; line-height: 1.6;">
                æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•
            </p>
            <div class="modal-buttons" style="justify-content: center;">
                <button class="btn btn-primary" onclick="confirmSessionExpired()" style="min-width: 120px;">é‡æ–°ç™»å½•</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        let ws = null;
        let banType = '';
        let banValue = '';
        let isLoggedIn = false;
        let currentUserRole = null;  // å½“å‰ç”¨æˆ·æƒé™
        let dashboardTimer = null;
        let activityItems = [];
        
        // æƒé™å¸¸é‡
        const ROLE_SUPER_ADMIN = 'super_admin';
        const ROLE_SUB_ADMIN = 'sub_admin';
        
        // æ›´æ–°æƒé™æ ‡è¯†
        function updateRoleBadge(role, roleName) {
            const badge = document.getElementById('roleBadge');
            const icon = badge.querySelector('.role-icon');
            const text = document.getElementById('roleText');
            
            badge.classList.remove('super-admin', 'sub-admin');
            
            if (role === ROLE_SUPER_ADMIN) {
                badge.classList.add('super-admin');
                icon.textContent = 'ğŸ‘‘';
                text.textContent = roleName || 'ç³»ç»Ÿæ€»ç®¡ç†';
            } else if (role === ROLE_SUB_ADMIN) {
                badge.classList.add('sub-admin');
                icon.textContent = 'â­';
                text.textContent = roleName || 'å­ç®¡ç†å‘˜';
            } else {
                icon.textContent = 'â“';
                text.textContent = 'æœªçŸ¥æƒé™';
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç³»ç»Ÿæ€»ç®¡ç†å‘˜
        function isSuperAdmin() {
            return currentUserRole === ROLE_SUPER_ADMIN;
        }
        
        // æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢
        let isCompactMode = false;
        function setViewMode(compact) {
            if (isCompactMode === compact) return;
            isCompactMode = compact;
            const fullBtn = document.getElementById('modeFullBtn');
            const compactBtn = document.getElementById('modeCompactBtn');
            const statsGrid = document.getElementById('statsGrid');
            const tabDashboard = document.getElementById('tabDashboard');
            const licenseStats = document.getElementById('licenseStatsGrid');
            const displayVal = isCompactMode ? 'none' : '';
            
            statsGrid.style.display = displayVal;
            tabDashboard.style.display = displayVal;
            if (licenseStats) licenseStats.style.display = displayVal;
            
            if (isCompactMode) {
                fullBtn.style.background = 'transparent';
                fullBtn.style.color = 'var(--text-secondary)';
                compactBtn.style.background = 'var(--accent)';
                compactBtn.style.color = 'white';
                if (tabDashboard.classList.contains('active')) {
                    document.querySelector('.tab[data-panel="online"]').click();
                }
            } else {
                fullBtn.style.background = 'var(--accent)';
                fullBtn.style.color = 'white';
                compactBtn.style.background = 'transparent';
                compactBtn.style.color = 'var(--text-secondary)';
            }
        }
        
        // ===== ç§»åŠ¨ç«¯æ–¹å‘æ£€æµ‹ =====
        function checkOrientation() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isPortrait = window.innerHeight > window.innerWidth;
            const rotateHint = document.getElementById('rotateHint');
            
            if (isMobile && isPortrait && window.innerWidth < 768) {
                rotateHint.style.display = 'flex';
            } else {
                rotateHint.style.display = 'none';
            }
        }
        
        // ç›‘å¬æ–¹å‘å˜åŒ–
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', () => {
            setTimeout(checkOrientation, 100);
        });
        
        // åˆå§‹æ£€æµ‹
        checkOrientation();
        
        // ===== ç™»å½•éªŒè¯ =====
        function checkLogin() {
            const token = sessionStorage.getItem('admin_token');
            if (token) {
                isLoggedIn = true;
                currentUserRole = sessionStorage.getItem('admin_role');
                const roleName = sessionStorage.getItem('admin_role_name');
                showMainContent();
                updateRoleBadge(currentUserRole, roleName);
            }
        }
        
        async function doLogin() {
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            if (!password) {
                errorEl.textContent = 'è¯·è¾“å…¥å¯†ç ';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    sessionStorage.setItem('admin_token', data.token);
                    sessionStorage.setItem('admin_role', data.role);
                    sessionStorage.setItem('admin_role_name', data.role_name);
                    sessionStorage.setItem('admin_permissions', JSON.stringify(data.permissions || {}));
                    isLoggedIn = true;
                    currentUserRole = data.role;
                    showMainContent();
                    updateRoleBadge(data.role, data.role_name);
                } else {
                    errorEl.textContent = data.message || 'å¯†ç é”™è¯¯';
                    errorEl.style.display = 'block';
                    document.getElementById('loginPassword').value = '';
                }
            } catch (e) {
                errorEl.textContent = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥';
                errorEl.style.display = 'block';
            }
        }
        
        function showMainContent() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContent').classList.add('visible');
            // æ ¹æ®æƒé™åŠ¨æ€æ˜¾ç¤º/éšè—æ ‡ç­¾é¡µ
            applyPermissions();
            // åˆå§‹åŒ–åº”ç”¨
            initApp();
        }
        
        function applyPermissions() {
            if (isSuperAdmin()) {
                // è¶…ç®¡æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
                document.querySelectorAll('.tab').forEach(t => t.style.display = '');
                return;
            }
            
            // å­ç®¡ç†å‘˜ï¼šæ ¹æ®æƒé™æ˜¾ç¤º/éšè—
            const perms = JSON.parse(sessionStorage.getItem('admin_permissions') || '{}');
            const allTabs = ['dashboard', 'online', 'usage', 'users', 'ips', 'banlist', 'whitelist', 'credits', 'license', 'database', 'settings'];
            
            allTabs.forEach(tabName => {
                const tab = document.querySelector(`.tab[data-panel="${tabName}"]`);
                if (!tab) return;
                
                if (tabName === 'settings') {
                    tab.style.display = 'none';
                } else if (tabName === 'whitelist' || tabName === 'credits') {
                    // ç™½åå•å’Œç§¯åˆ†å¯¹æ‰€æœ‰ç®¡ç†å‘˜å¯è§
                    tab.style.display = '';
                } else {
                    tab.style.display = perms[tabName] ? '' : 'none';
                }
            });
            
            // å¦‚æœå½“å‰æ´»åŠ¨æ ‡ç­¾è¢«éšè—äº†ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªå¯è§æ ‡ç­¾
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && activeTab.style.display === 'none') {
                const firstVisible = document.querySelector('.tab:not([style*="display: none"])');
                if (firstVisible) firstVisible.click();
            }
        }
        
        function logout() {
            sessionStorage.removeItem('admin_token');
            sessionStorage.removeItem('admin_role');
            sessionStorage.removeItem('admin_role_name');
            sessionStorage.removeItem('admin_permissions');
            isLoggedIn = false;
            currentUserRole = null;
            location.reload();
        }
        
        // ä¼šè¯å¤±æ•ˆæç¤ºï¼ˆä¸»é¢˜é£æ ¼å¼¹çª—ï¼‰
        let sessionExpiredShown = false;
        function handleKickedOut(message) {
            if (sessionExpiredShown) return; // é˜²æ­¢é‡å¤å¼¹çª—
            sessionExpiredShown = true;
            document.getElementById('sessionExpiredMsg').textContent = message || 'æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
            document.getElementById('sessionExpiredModal').style.display = 'flex';
        }
        
        function confirmSessionExpired() {
            document.getElementById('sessionExpiredModal').style.display = 'none';
            sessionExpiredShown = false;
            logout();
        }
        
        // æ£€æŸ¥APIå“åº”æ˜¯å¦ä¸ºtokenå¤±æ•ˆ
        function checkTokenValid(response) {
            if (response.status === 401) {
                handleKickedOut('æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                return false;
            }
            return true;
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        checkLogin();
        
        // åˆå§‹åŒ–WebSocket
        function initWebSocket() {
            // å…ˆå…³é—­å·²å­˜åœ¨çš„è¿æ¥ï¼Œé¿å…é‡å¤è¿æ¥
            if (ws && ws.readyState !== WebSocket.CLOSED) {
                console.log('[Admin] å…³é—­æ—§WebSocketè¿æ¥');
                ws.close();
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/admin/ws`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'å·²è¿æ¥';
                // å‘é€èº«ä»½è®¤è¯
                const token = sessionStorage.getItem('admin_token');
                if (token) {
                    ws.send(JSON.stringify({ type: 'auth', token: token }));
                }
                // å¯åŠ¨å¿ƒè·³ï¼ˆæ¯10ç§’ï¼‰
                if (window._adminHeartbeat) clearInterval(window._adminHeartbeat);
                window._adminHeartbeat = setInterval(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'heartbeat' }));
                    }
                }, 10000);
            };
            
            ws.onclose = () => {
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'å·²æ–­å¼€';
                if (window._adminHeartbeat) { clearInterval(window._adminHeartbeat); window._adminHeartbeat = null; }
                // é‡è¿
                setTimeout(initWebSocket, 3000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }
        
        // å½“å‰èŠå¤©ç”¨æˆ·
        let currentChatUser = null;
        let chatRefreshTimer = null;
        
        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            const time = data.data?.time || new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            
            if (data.type === 'new_login') {
                addLogItem(data.data);
                refreshStats();
                // æ·»åŠ åˆ°æ´»åŠ¨æµ
                if (data.data.status === 'success') {
                    addActivityItem('success', 'âœ…', `<strong>${data.data.username}</strong> ç™»å½•æˆåŠŸ`, time);
                } else {
                    addActivityItem('failed', 'âŒ', `<strong>${data.data.username}</strong> ç™»å½•å¤±è´¥`, time);
                }
                // å¦‚æœæœ‰èµ„äº§æ•°æ®ï¼Œä¹Ÿåˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                if (data.data.assets) {
                    loadUsers();
                }
            } else if (data.type === 'asset_update') {
                addAssetLogItem(data.data);
                loadUsers();
                refreshStats();
                addActivityItem('info', 'ğŸ’°', `<strong>${data.data.username}</strong> èµ„äº§å·²æ›´æ–°`, time);
            } else if (data.type === 'user_banned' || data.type === 'user_unbanned') {
                loadBanlist().then(() => loadUsers());
                refreshStats();
                const action = data.type === 'user_banned' ? 'å·²å°ç¦' : 'å·²è§£å°';
                addActivityItem(data.type === 'user_banned' ? 'failed' : 'success', 
                    data.type === 'user_banned' ? 'ğŸš«' : 'âœ…', 
                    `ç”¨æˆ· <strong>${data.data?.value || ''}</strong> ${action}`, time);
            } else if (data.type === 'ip_banned' || data.type === 'ip_unbanned') {
                loadIPs();
                loadBanlist();
                refreshStats();
            } else if (data.type === 'user_online') {
                loadOnlineUsers();
                addActivityItem('success', 'ğŸŸ¢', `<strong>${data.data?.username || ''}</strong> ä¸Šçº¿`, time);
            } else if (data.type === 'user_offline') {
                loadOnlineUsers();
                addActivityItem('info', 'âšª', `<strong>${data.data?.username || ''}</strong> ç¦»çº¿`, time);
            } else if (data.type === 'chat_message') {
                if (data.data.username === currentChatUser) {
                    if (!data.data.is_admin) {
                        addChatMessage(data.data.content, false, data.data.time);
                    }
                }
                if (!data.data.is_admin) {
                    addChatLogItem(data.data);
                    addActivityItem('info', 'ğŸ’¬', `<strong>${data.data.username}</strong> å‘é€æ¶ˆæ¯`, time);
                }
            }
        }
        
        // æ·»åŠ èŠå¤©æ—¥å¿—ï¼ˆå·²ç§»é™¤å®æ—¶æ—¥å¿—é¢æ¿ï¼Œæ­¤å‡½æ•°ä»…ä½œå ä½ï¼‰
        function addChatLogItem(data) {
            // liveLog é¢æ¿å·²ç§»é™¤ï¼Œä¸å†æ˜¾ç¤ºå®æ—¶æ—¥å¿—
            console.log('[Chat]', data.username, ':', data.content);
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æ·»åŠ èµ„äº§æ›´æ–°æ—¥å¿—ï¼ˆå·²ç§»é™¤å®æ—¶æ—¥å¿—é¢æ¿ï¼Œæ­¤å‡½æ•°ä»…ä½œå ä½ï¼‰
        function addAssetLogItem(data) {
            // liveLog é¢æ¿å·²ç§»é™¤ï¼Œä¸å†æ˜¾ç¤ºå®æ—¶æ—¥å¿—
            console.log('[Asset Update]', data.username, 'AK:', data.ace_count, 'EP:', data.ep);
        }
        
        // æ·»åŠ æ—¥å¿—é¡¹ï¼ˆå·²ç§»é™¤å®æ—¶æ—¥å¿—é¢æ¿ï¼Œæ­¤å‡½æ•°ä»…ä½œå ä½ï¼‰
        function addLogItem(data) {
            // liveLog é¢æ¿å·²ç§»é™¤ï¼Œä¸å†æ˜¾ç¤ºå®æ—¶æ—¥å¿—
            console.log('[Login]', data.username, data.status);
        }
        
        // åŠ è½½ç»Ÿè®¡
        async function refreshStats() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/stats`);
                const data = await res.json();
                document.getElementById('statUsers').textContent = data.total_users;
                document.getElementById('statToday').textContent = data.today_logins;
                document.getElementById('statLogins').textContent = data.total_logins;
                document.getElementById('statIPs').textContent = data.total_ips;
                document.getElementById('statBanned').textContent = data.banned_count;
                document.getElementById('statTotalAce').textContent = formatNumber(data.total_ace);
                document.getElementById('statTotalEP').textContent = formatNumber(data.total_ep);
                document.getElementById('statTotalSP').textContent = formatNumber(data.total_sp);
                document.getElementById('statTotalRP').textContent = formatNumber(data.total_rp);
                document.getElementById('statTotalTP').textContent = formatNumber(data.total_tp);
            } catch (e) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥', e);
            }
        }
        
        // å­˜å‚¨åŸå§‹æ•°æ®ç”¨äºæœç´¢
        let usageDataCache = [];
        let usersDataCache = [];
        
        // åŠ è½½ä½¿ç”¨æƒ…å†µï¼ˆuser_statsè¡¨ - æ‰€æœ‰ç™»å½•å°è¯•ï¼‰
        async function loadUsage() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/usage?limit=500`);
                const data = await res.json();
                usageDataCache = data || [];
                renderUsageTable(usageDataCache);
            } catch (e) {
                console.error('åŠ è½½ä½¿ç”¨æƒ…å†µå¤±è´¥', e);
            }
        }
        
        // æ¸²æŸ“ä½¿ç”¨æƒ…å†µè¡¨æ ¼
        function renderUsageTable(users) {
            const tbody = document.getElementById('usageTable');
            document.getElementById('usageSearchCount').textContent = `å…± ${users.length} æ¡è®°å½•`;
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td style="color: var(--accent-yellow); font-family: monospace; font-size: 12px;">${user.password || '-'}</td>
                    <td>${user.login_count || 0}</td>
                    <td>
                        <span class="badge ${user.auth_status === 'banned' ? 'danger' : user.auth_status === 'authorized' ? 'success' : 'warning'}">
                            ${user.auth_status === 'banned' ? 'å·²å°ç¦' : user.auth_status === 'authorized' ? 'å·²æˆæƒ' : 'æœªæˆæƒ'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
        
        // æœç´¢ä½¿ç”¨æƒ…å†µ
        function searchUsage() {
            const keyword = document.getElementById('usageSearchInput').value.trim().toLowerCase();
            if (!keyword) {
                renderUsageTable(usageDataCache);
                return;
            }
            const filtered = usageDataCache.filter(user => 
                user.username && user.username.toLowerCase().includes(keyword)
            );
            renderUsageTable(filtered);
        }
        
        // æ¸…é™¤ä½¿ç”¨æƒ…å†µæœç´¢
        function clearUsageSearch() {
            document.getElementById('usageSearchInput').value = '';
            renderUsageTable(usageDataCache);
        }
        
        // ç”¨æˆ·ç®¡ç†åˆ†é¡µç›¸å…³
        let usersCurrentPage = 0;
        const usersPageSize = 100;
        let usersTotalCount = 0;
        let usersTotalPages = 0;
        let usersIsLoadAll = false;
        let usersSearchKeyword = '';
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆuser_assetsè¡¨ - åªæ˜¾ç¤ºèµ„äº§ä¿¡æ¯ï¼‰
        async function loadUsers(page = 0) {
            usersCurrentPage = page;
            const offset = page * usersPageSize;
            
            try {
                let url;
                if (usersIsLoadAll) {
                    url = `${API_BASE}/admin/api/assets?limit=99999&offset=0`;
                } else {
                    url = `${API_BASE}/admin/api/assets?limit=${usersPageSize}&offset=${offset}`;
                }
                if (usersSearchKeyword) {
                    url += `&search=${encodeURIComponent(usersSearchKeyword)}`;
                }
                
                // å¹¶è¡Œè·å–ç”¨æˆ·æ•°æ®å’Œå°ç¦åˆ—è¡¨
                const [res, banRes] = await Promise.all([
                    fetch(url),
                    fetch(`${API_BASE}/admin/api/banlist`)
                ]);
                const data = await res.json();
                const banData = await banRes.json();
                bannedUsersSet.clear();
                banData.forEach(item => {
                    if (item.ban_type === 'user' || item.ban_type === 'username') bannedUsersSet.add(item.ban_value.toLowerCase());
                });
                
                const rows = data.rows || [];
                usersTotalCount = data.total || 0;
                usersDataCache = rows;
                
                if (usersIsLoadAll) {
                    usersTotalPages = 1;
                    usersCurrentPage = 0;
                } else {
                    usersTotalPages = Math.ceil(usersTotalCount / usersPageSize) || 1;
                }
                
                renderUsersTable(usersDataCache);
                updateUsersPagination();
            } catch (e) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥', e);
            }
        }
        
        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderUsersTable(users, keepSortInfo = false) {
            const tbody = document.getElementById('usersTable');
            const sortInfo = usersSortField ? ` (æŒ‰${getSortFieldName(usersSortField)}${usersSortAsc ? 'â†‘' : 'â†“'})` : '';
            const countText = usersIsLoadAll 
                ? `å…± ${usersTotalCount} æ¡è®°å½•ï¼ˆå·²å…¨éƒ¨åŠ è½½ï¼‰` 
                : `å…± ${usersTotalCount} æ¡è®°å½•ï¼Œå½“å‰æ˜¾ç¤º ${users.length} æ¡`;
            document.getElementById('usersSearchCount').textContent = countText + (keepSortInfo ? sortInfo : '');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="16" style="text-align: center; color: var(--text-secondary);">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const banned = bannedUsersSet.has((user.username || '').toLowerCase());
                const banBtn = banned
                    ? `<button class="btn btn-success" onclick="unban('user', '${user.username}')" style="padding: 4px 12px; font-size: 12px;">è§£å°</button>`
                    : `<button class="btn btn-danger" onclick="showBanModal('user', '${user.username}')" style="padding: 4px 12px; font-size: 12px;">å°ç¦</button>`;
                return `<tr class="${banned ? 'banned-row' : ''}">
                    <td><strong>${user.username}</strong></td>
                    <td style="color: #78e8c6;">${formatNumber(user.login_count || 0)}</td>
                    <td style="color: var(--accent);">${formatNumber(user.ace_count)}</td>
                    <td>${formatNumber(user.total_ace)}</td>
                    <td style="color: var(--accent-green);">${formatNumber(user.ep)}</td>
                    <td style="color: #ff6b9d;">${formatNumber(user.sp)}</td>
                    <td style="color: #f7b731;">${formatNumber(user.rp)}</td>
                    <td style="color: #a55eea;">${formatNumber(user.tp)}</td>
                    <td style="color: var(--accent-yellow);">${formatNumber(user.weekly_money)}</td>
                    <td style="color: #26de81;">${user.left_area || 0}</td>
                    <td style="color: #45aaf2;">${user.right_area || 0}</td>
                    <td style="color: #fc5c65;">${user.direct_push || 0}</td>
                    <td style="color: #fed330;">${user.sub_account || 0}</td>
                    <td><span class="badge warning">${user.honor_name || '-'}</span></td>
                    <td style="color: var(--text-secondary); font-size: 11px;">${fmtTime(user.updated_at)}</td>
                    <td>${banBtn}</td>
                </tr>`;
            }).join('');
        }
        
        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updateUsersPagination() {
            const pagination = document.getElementById('usersPagination');
            if (usersIsLoadAll) {
                pagination.style.display = 'none';
                return;
            }
            pagination.style.display = 'flex';
            
            document.getElementById('usersFirstBtn').disabled = usersCurrentPage <= 0;
            document.getElementById('usersPrevBtn').disabled = usersCurrentPage <= 0;
            document.getElementById('usersNextBtn').disabled = usersCurrentPage >= usersTotalPages - 1;
            document.getElementById('usersLastBtn').disabled = usersCurrentPage >= usersTotalPages - 1;
            document.getElementById('usersPageInfo').textContent = `ç¬¬ ${usersCurrentPage + 1} / ${usersTotalPages} é¡µ`;
        }
        
        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function usersGoPage(page) {
            if (page < 0 || page >= usersTotalPages) return;
            loadUsers(page);
        }
        
        // æœç´¢ç”¨æˆ·ï¼ˆä»æ•°æ®åº“æŸ¥è¯¢ï¼Œå¸¦é˜²æŠ–ï¼‰
        let usersSearchTimer = null;
        function searchUsers() {
            clearTimeout(usersSearchTimer);
            usersSearchTimer = setTimeout(() => {
                usersSearchKeyword = document.getElementById('usersSearchInput').value.trim();
                usersCurrentPage = 0;
                loadUsers(0);
            }, 300);
        }
        
        // æ¸…é™¤ç”¨æˆ·æœç´¢
        function clearUsersSearch() {
            document.getElementById('usersSearchInput').value = '';
            usersSearchKeyword = '';
            usersCurrentPage = 0;
            loadUsers(0);
        }
        
        // åŠ è½½å…¨éƒ¨æ•°æ®åˆ‡æ¢
        function onUsersLoadAllChange() {
            usersIsLoadAll = document.getElementById('usersLoadAll').checked;
            usersCurrentPage = 0;
            loadUsers(0);
        }
        
        // ç”¨æˆ·è¡¨æ ¼æ’åºç›¸å…³
        let usersSortField = null;
        let usersSortAsc = true;
        
        // æ’åºç”¨æˆ·è¡¨æ ¼ï¼ˆå‰ç«¯æ’åºå½“å‰é¡µæ•°æ®ï¼‰
        function sortUsersBy(field) {
            // åˆ‡æ¢æ’åºæ–¹å‘
            if (usersSortField === field) {
                usersSortAsc = !usersSortAsc;
            } else {
                usersSortField = field;
                usersSortAsc = false;  // é»˜è®¤é™åºï¼ˆæ•°å€¼å¤§çš„åœ¨å‰ï¼‰
            }
            
            // æ›´æ–°æ’åºå›¾æ ‡
            updateSortIcons(field, usersSortAsc);
            
            let dataToSort = [...usersDataCache];
            
            // æ’åº
            dataToSort.sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                
                // å¤„ç† null/undefined
                if (valA == null) valA = field === 'updated_at' || field === 'honor_name' ? '' : 0;
                if (valB == null) valB = field === 'updated_at' || field === 'honor_name' ? '' : 0;

                // æ—¥æœŸå­—æ®µ
                if (field === 'updated_at') {
                    valA = valA ? new Date(valA).getTime() : 0;
                    valB = valB ? new Date(valB).getTime() : 0;
                } else if (typeof valA === 'number' || !isNaN(parseFloat(valA))) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                }
                
                // æ¯”è¾ƒ
                if (valA < valB) return usersSortAsc ? -1 : 1;
                if (valA > valB) return usersSortAsc ? 1 : -1;
                return 0;
            });
            
            renderUsersTable(dataToSort, true);
        }
        
        // æ›´æ–°æ’åºå›¾æ ‡
        function updateSortIcons(activeField, isAsc) {
            const fields = ['ace_count', 'total_ace', 'ep', 'sp', 'rp', 'tp', 'weekly_money', 'left_area', 'right_area', 'direct_push', 'sub_account', 'honor_name', 'updated_at'];
            fields.forEach(f => {
                const icon = document.getElementById('sort-' + f);
                const th = icon?.parentElement;
                if (icon && th) {
                    th.classList.remove('asc', 'desc');
                    if (f === activeField) {
                        icon.textContent = isAsc ? 'â†‘' : 'â†“';
                        th.classList.add(isAsc ? 'asc' : 'desc');
                    } else {
                        icon.textContent = 'â‡…';
                    }
                }
            });
        }
        
        // è·å–æ’åºå­—æ®µä¸­æ–‡å
        function getSortFieldName(field) {
            const names = {
                'ace_count': 'ä¸»è´¦æˆ·AK',
                'total_ace': 'å­è´¦æˆ·AK',
                'ep': 'EP',
                'sp': 'SP',
                'rp': 'RP',
                'tp': 'TP',
                'weekly_money': 'æœ¬å‘¨æ”¶ç›Š',
                'left_area': 'å·¦åŒº',
                'right_area': 'å³åŒº',
                'direct_push': 'ç›´æ¨',
                'sub_account': 'å­è´¦å·',
                'honor_name': 'ç­‰çº§',
                'updated_at': 'æ›´æ–°æ—¶é—´'
            };
            return names[field] || field;
        }
        
        // åŠ è½½IPåˆ—è¡¨
        async function loadIPs() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/ips`);
                const data = await res.json();
                const tbody = document.getElementById('ipsTable');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(ip => `
                    <tr>
                        <td><strong>${ip.ip_address}</strong></td>
                        <td>${ip.request_count}</td>
                        <td>${fmtTime(ip.first_seen)}</td>
                        <td>${fmtTime(ip.last_seen)}</td>
                        <td>
                            <span class="badge ${ip.is_banned ? 'danger' : 'success'}">
                                ${ip.is_banned ? 'å·²å°ç¦' : 'æ­£å¸¸'}
                            </span>
                        </td>
                        <td>
                            ${ip.is_banned 
                                ? `<button class="btn btn-success" onclick="unban('ip', '${ip.ip_address}')">è§£å°</button>`
                                : `<button class="btn btn-danger" onclick="showBanModal('ip', '${ip.ip_address}')">å°ç¦</button>`
                            }
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½IPå¤±è´¥', e);
            }
        }
        
        // å…¨å±€å°ç¦ç”¨æˆ·é›†åˆï¼ˆå‰ç«¯ç»´æŠ¤ï¼‰
        const bannedUsersSet = new Set();

        // åŠ è½½å°ç¦åˆ—è¡¨
        async function loadBanlist() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/banlist`);
                const data = await res.json();
                const tbody = document.getElementById('banlistTable');
                
                // æ›´æ–°å°ç¦ç”¨æˆ·é›†åˆ
                bannedUsersSet.clear();
                data.forEach(item => {
                    if (item.ban_type === 'user' || item.ban_type === 'username') bannedUsersSet.add(item.ban_value.toLowerCase());
                });

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">æš‚æ— å°ç¦</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(item => `
                    <tr>
                        <td><span class="badge ${item.ban_type === 'ip' ? 'warning' : 'danger'}">${item.ban_type === 'ip' ? 'IP' : 'ç”¨æˆ·'}</span></td>
                        <td><strong>${item.ban_value}</strong></td>
                        <td>${fmtTime(item.banned_at)}</td>
                        <td>${item.banned_reason || '-'}</td>
                        <td>
                            <button class="btn btn-success" onclick="unban('${item.ban_type}', '${item.ban_value}')">è§£å°</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½å°ç¦åˆ—è¡¨å¤±è´¥', e);
            }
        }
        
        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return Number(num).toLocaleString('zh-CN', {maximumFractionDigits: 2});
        }

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆå»æ‰Tï¼Œç²¾ç¡®åˆ°åˆ†é’Ÿï¼‰
        function fmtTime(t) {
            if (!t) return '-';
            return String(t).replace('T', ' ').slice(0, 16);
        }
        
        // åŠ è½½åœ¨çº¿ç”¨æˆ·
        // é¡µé¢è·¯å¾„ â†’ ä¸­æ–‡æè¿°æ˜ å°„
        const PAGE_NAME_MAP = {
            '/pages/home.html': 'ä½äºé¦–é¡µ',
            '/pages/ace.list.html': 'æŸ¥çœ‹AKäº¤æ˜“é¡µé¢',
            '/pages/ep.list.html': 'æŸ¥çœ‹EPäº¤æ˜“ç•Œé¢',
            '/pages/center.html': 'ä½äºä¸ªäººä¸»é¡µ',
            '/pages/center/sell.ace.html': 'ä½äºAKå‡ºå”®ç•Œé¢',
            '/pages/center/sell.ep.html': 'ä½äºEPå‡ºå”®ç•Œé¢',
            '/pages/center/ep.out.html': 'ä½äºEPè½¬å‡ºç•Œé¢',
            '/pages/center/ep.to.rp.html': 'ä½äºEPè½¬RPç•Œé¢',
            '/pages/center/ep.to.sp.html': 'ä½äºEPè½¬SPç•Œé¢',
            '/pages/center/rp.to.sp.html': 'ä½äºRPè½¬SPç•Œé¢',
            '/pages/center/rp.out.html': 'ä½äºRPè½¬å‡ºç•Œé¢',
            '/pages/center/rptp.out.html': 'ä½äºTP+RPè½¬å‡ºç•Œé¢',
            '/pages/center/sub.account.html': 'æŸ¥çœ‹å­è´¦æˆ·',
            '/pages/center/my.friend.html': 'æŸ¥çœ‹é™„è¿‘ç©å®¶',
            '/pages/center/my.fans.list.html': 'æŸ¥çœ‹å…¨çƒç©å®¶è¡¨',
            '/pages/center/my.fans.tree.html': 'æŸ¥çœ‹å…¨çƒç©å®¶å›¾',
            '/pages/center/records/rp.record.html': 'æŸ¥çœ‹RPè®°å½•',
            '/pages/center/records/sp.record.html': 'æŸ¥çœ‹SPè®°å½•',
            '/pages/center/records/ep.record.html': 'æŸ¥çœ‹EPè®°å½•',
            '/pages/center/records/tp.record.html': 'æŸ¥çœ‹TPè®°å½•',
            '/pages/center/profit.html': 'æŸ¥çœ‹æ”¶ç›Šæ˜ç»†',
            '/pages/center/records/ep.out.record.html': 'æŸ¥çœ‹EPè½¬å‡ºè®°å½•',
            '/pages/center/records/ep.in.record.html': 'æŸ¥çœ‹EPè½¬å…¥è®°å½•',
            '/pages/center/business.center.html': 'æŸ¥çœ‹EPäº¤æ˜“ä¿¡æ¯',
            '/pages/center/split.record.html': 'æŸ¥çœ‹æ‹†åˆ†è®°å½•',
            '/pages/center/Summary_Record.html': 'æŸ¥çœ‹ä¸€é”®å½’é›†æ˜ç»†',
            '/pages/center/Donate_Record.html': 'æŸ¥çœ‹æèµ é”€æ¯è®°å½•',
            '/pages/center/Donate.html': 'è‡ªæ„¿æèµ ç•Œé¢',
            '/pages/center/google/activation.code.html': 'æŸ¥çœ‹è°·æ­Œæ¿€æ´»ç ',
            '/pages/center/security/change.password.html': 'ä¿®æ”¹ç™»å½•å¯†ç ',
            '/pages/center/security/change.pin.html': 'ä¿®æ”¹äº¤æ˜“å¯†ç ',
            '/pages/center/security/reset.mnemonic.html': 'é‡ç½®åŠ©è®°è¯',
            '/pages/center/child/upgrade_record.html': 'æŸ¥çœ‹è£è€€å†ç¨‹',
            '/pages/center/security.html': 'è´¦æˆ·å®‰å…¨ç•Œé¢',
            '/pages/center/financial_management.html': 'æŸ¥çœ‹è´¢åŠ¡ç®¡ç†',
            '/pages/center/security-settings.html': 'æŸ¥çœ‹å®‰å…¨è®¾ç½®',
            '/pages/account/login.html': 'ä½äºç™»å½•ç•Œé¢',
            '/pages/subpages/notice.html': 'æŸ¥çœ‹å…¬å‘Š',
            '/pages/subpages/notice.list.html': 'æŸ¥çœ‹å…¬å‘Š',
            '/pages/subpages/last.notice.detail.html': 'æŸ¥çœ‹å…¬å‘Š',
            '/pages/subpages/about.html': 'æŸ¥çœ‹å…³äº',
            '/pages/subpages/help.html': 'æŸ¥çœ‹å¸®åŠ©',
            '/pages/subpages/contact.html': 'æŸ¥çœ‹è”ç³»æ–¹å¼'
        };
        
        function getPageName(path) {
            if (!path || path === '/') return 'é¦–é¡µ';
            // å…ˆç›´æ¥åŒ¹é…å®Œæ•´è·¯å¾„ï¼ˆå«hashï¼‰
            if (PAGE_NAME_MAP[path]) return PAGE_NAME_MAP[path];
            // å°è¯•åŒ¹é… pathname éƒ¨åˆ†
            let pathname = path.split('#')[0].split('?')[0];
            if (PAGE_NAME_MAP[pathname]) return PAGE_NAME_MAP[pathname];
            // /pages/subpages/ ä¸‹æ‰€æœ‰å­é¡µé¢ç»Ÿä¸€æ˜¾ç¤ºâ€œæŸ¥çœ‹å…¬å‘Šâ€
            if (pathname.startsWith('/pages/subpages/')) return 'æŸ¥çœ‹å…¬å‘Š';
            // å°è¯•åŒ¹é… hash ä¸­çš„è·¯å¾„ï¼ˆSPA hashè·¯ç”±ï¼‰
            let hash = path.includes('#') ? path.split('#')[1] : '';
            if (hash) {
                // hashå¯èƒ½æ˜¯ #/pages/subpages/notice.html æˆ– #pages/subpages/notice.html
                let hashPath = hash.startsWith('/') ? hash : '/' + hash;
                if (PAGE_NAME_MAP[hashPath]) return PAGE_NAME_MAP[hashPath];
                if (hashPath.startsWith('/pages/subpages/')) return 'æŸ¥çœ‹å…¬å‘Š';
            }
            return path;
        }
        
        async function loadOnlineUsers() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/online`);
                const data = await res.json();
                const tbody = document.getElementById('onlineTable');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">æš‚æ— åœ¨çº¿ç”¨æˆ·</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(user => `
                    <tr>
                        <td>
                            <span style="display: inline-block; width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%; margin-right: 8px;"></span>
                            <strong>${user.username}</strong>
                        </td>
                        <td style="color: var(--text-secondary); font-size: 12px;">${getPageName(user.page)}</td>
                        <td style="color: var(--text-secondary); font-size: 12px;">${user.online_time}</td>
                        <td>
                            <button class="btn btn-primary" onclick="startChat('${user.username}')" style="padding: 4px 12px; font-size: 12px;">èŠå¤©</button>
                            <button class="btn btn-danger" onclick="showBanModal('user', '${user.username}')" style="padding: 4px 12px; font-size: 12px;">å°ç¦</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½åœ¨çº¿ç”¨æˆ·å¤±è´¥', e);
            }
        }
        
        // åˆ·æ–°èŠå¤©è®°å½•
        async function refreshChatHistory() {
            if (!currentChatUser) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/chat/history/${currentChatUser}`);
                const messages = await res.json();
                
                // é‡æ–°æ¸²æŸ“èŠå¤©è®°å½•
                const container = document.getElementById('chatMessages');
                const scrollAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
                
                container.innerHTML = '';
                messages.forEach(msg => {
                    addChatMessage(msg.content, msg.is_admin, msg.time);
                });
                
                // å¦‚æœä¹‹å‰åœ¨åº•éƒ¨ï¼Œä¿æŒåœ¨åº•éƒ¨
                if (scrollAtBottom) {
                    container.scrollTop = container.scrollHeight;
                }
            } catch (e) {
                console.error('åˆ·æ–°èŠå¤©è®°å½•å¤±è´¥', e);
            }
        }
        
        // å¼€å§‹èŠå¤©
        async function startChat(username) {
            // æ¸…é™¤æ—§çš„å®šæ—¶å™¨
            if (chatRefreshTimer) {
                clearInterval(chatRefreshTimer);
            }
            
            currentChatUser = username;
            document.getElementById('chatTarget').textContent = username;
            document.getElementById('chatStatus').textContent = 'åœ¨çº¿';
            document.getElementById('chatStatus').style.color = 'var(--accent-green)';
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
            
            // åŠ è½½èŠå¤©å†å²
            await refreshChatHistory();
            
            // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡èŠå¤©è®°å½•ï¼ˆä½œä¸ºWebSocketçš„å¤‡ä»½ï¼‰
            chatRefreshTimer = setInterval(refreshChatHistory, 3000);
            
            document.getElementById('chatInput').focus();
        }
        
        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addChatMessage(content, isAdmin, time) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.style.cssText = `
                margin-bottom: 12px;
                display: flex;
                flex-direction: column;
                ${isAdmin ? 'align-items: flex-end;' : 'align-items: flex-start;'}
            `;
            msg.innerHTML = `
                <div style="
                    padding: 10px 14px;
                    border-radius: 12px;
                    font-size: 14px;
                    max-width: 80%;
                    word-break: break-word;
                    display: inline-block;
                    ${isAdmin 
                        ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px;' 
                        : 'background: var(--bg-secondary); color: var(--text-primary); border-bottom-left-radius: 4px;'}
                ">${escapeHtml(content)}</div>
                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${time}</div>
            `;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }
        
        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content || !currentChatUser) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/chat/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentChatUser, content: content })
                });
                
                if (res.ok) {
                    // ç«‹å³æ·»åŠ ç®¡ç†å‘˜æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
                    const now = new Date();
                    const timeStr = now.toTimeString().split(' ')[0].substring(0, 5);
                    addChatMessage(content, true, timeStr);
                    input.value = '';
                } else {
                    showAlert('å‘é€å¤±è´¥ï¼Œç”¨æˆ·å¯èƒ½å·²ç¦»çº¿', 'error');
                }
            } catch (e) {
                showAlert('å‘é€å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // èŠå¤©è¾“å…¥æ¡†å›è½¦å‘é€
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            document.getElementById('broadcastInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') broadcastMessage();
            });
        });
        
        // ç¾¤å‘æ¶ˆæ¯
        async function broadcastMessage() {
            const input = document.getElementById('broadcastInput');
            const content = input.value.trim();
            if (!content) return;
            
            try {
                const response = await fetch('/admin/api/chat/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    input.value = '';
                    showAlert(`æ¶ˆæ¯å·²å‘é€ç»™ ${result.sent_count} ä¸ªåœ¨çº¿ç”¨æˆ·`, 'success');
                } else {
                    showAlert('å‘é€å¤±è´¥', 'error');
                }
            } catch (e) {
                showAlert('å‘é€å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºå°ç¦å¼¹çª—
        function showBanModal(type, value) {
            banType = type;
            banValue = value;
            document.getElementById('banTarget').textContent = `${type === 'ip' ? 'IP: ' : 'ç”¨æˆ·: '}${value}`;
            document.getElementById('banReason').value = '';
            document.getElementById('banModal').classList.add('active');
        }
        
        function closeBanModal() {
            document.getElementById('banModal').classList.remove('active');
        }
        
        // ç¡®è®¤å°ç¦
        async function confirmBan() {
            const reason = document.getElementById('banReason').value;
            try {
                const res = await fetch(`${API_BASE}/admin/api/ban/${banType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: banValue, reason: reason })
                });
                if (res.ok) {
                    closeBanModal();
                    await loadBanlist();
                    if (banType === 'ip') { loadIPs(); }
                    else { loadUsers(); loadUsage(); }
                    refreshStats();
                    showToast(`${banType === 'ip' ? 'IP' : 'ç”¨æˆ·'} ${banValue} å·²å°ç¦`);
                } else {
                    const data = await res.json();
                    showAlert('å°ç¦å¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                showAlert('å°ç¦å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // è§£å°ç›¸å…³å˜é‡
        let unbanType = '';
        let unbanValue = '';
        
        // æ˜¾ç¤ºè§£å°å¼¹çª—
        function showUnbanModal(type, value) {
            unbanType = type;
            unbanValue = value;
            document.getElementById('unbanTarget').textContent = `${type === 'ip' ? 'IP: ' : 'ç”¨æˆ·: '}${value}`;
            document.getElementById('unbanModal').classList.add('active');
        }
        
        function closeUnbanModal() {
            document.getElementById('unbanModal').classList.remove('active');
        }
        
        // ç¡®è®¤è§£å°
        async function confirmUnban() {
            try {
                // API type æ˜ å°„ï¼šusername -> user
                const apiType = unbanType === 'username' ? 'user' : unbanType;
                const res = await fetch(`${API_BASE}/admin/api/unban/${apiType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: unbanValue })
                });
                if (res.ok) {
                    closeUnbanModal();
                    // åˆ·æ–°ç›¸å…³åˆ—è¡¨
                    await loadBanlist();
                    if (unbanType === 'ip') {
                        loadIPs();
                    } else {
                        loadUsers();
                        loadUsage();
                    }
                    refreshStats();
                } else {
                    const data = await res.json();
                    showAlert('è§£å°å¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                showAlert('è§£å°å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // å…¼å®¹æ—§çš„ unban è°ƒç”¨
        function unban(type, value) {
            showUnbanModal(type, value);
        }
        
        // ===== å­ç®¡ç†å‘˜ç®¡ç† =====
        
        let subAdminStatusTimer = null;
        
        // å¯åŠ¨å­ç®¡ç†å‘˜çŠ¶æ€å®šæ—¶åˆ·æ–°
        function startSubAdminStatusRefresh() {
            if (!isSuperAdmin()) return;
            stopSubAdminStatusRefresh();
            subAdminStatusTimer = setInterval(loadSubAdminStatus, 10000);
        }
        
        // åœæ­¢å­ç®¡ç†å‘˜çŠ¶æ€å®šæ—¶åˆ·æ–°
        function stopSubAdminStatusRefresh() {
            if (subAdminStatusTimer) {
                clearInterval(subAdminStatusTimer);
                subAdminStatusTimer = null;
            }
        }
        
        // æƒé™å…¨é€‰/å…¨ä¸é€‰
        function toggleAllPerms(checked) {
            const permKeys = ['dashboard', 'online', 'usage', 'users', 'ips', 'banlist', 'license', 'database'];
            permKeys.forEach(key => {
                const cb = document.getElementById('perm_' + key);
                if (cb) cb.checked = checked;
            });
        }
        
        // æƒé™åç§°æ˜ å°„
        const PERM_LABELS = {
            dashboard: 'ğŸ“ˆä»ªè¡¨ç›˜', online: 'ğŸŸ¢åœ¨çº¿', usage: 'ğŸ“Šä½¿ç”¨', users: 'ğŸ‘¥ç”¨æˆ·',
            ips: 'ğŸŒIP', banlist: 'ğŸš«å°ç¦', license: 'ğŸ”‘æ¿€æ´»ç ', database: 'ğŸ—„ï¸æ•°æ®åº“'
        };
        
        // å½“å‰é€‰ä¸­çš„å­ç®¡ç†å‘˜
        let selectedSubAdmin = null;
        
        // ç‚¹å‡»å­ç®¡ç†å‘˜å¡ç‰‡ â†’ åŠ è½½æƒé™åˆ°å¤é€‰æ¡†
        function selectSubAdmin(name, permissions) {
            selectedSubAdmin = name;
            document.getElementById('newSubAdminName').value = name;
            // åŠ è½½æƒé™åˆ°å¤é€‰æ¡†
            const permKeys = ['dashboard', 'online', 'usage', 'users', 'ips', 'banlist', 'license', 'database'];
            permKeys.forEach(key => {
                const cb = document.getElementById('perm_' + key);
                if (cb) cb.checked = !!permissions[key];
            });
            // é«˜äº®é€‰ä¸­çš„å¡ç‰‡ï¼Œé‡ç½®å…¶ä»–å¡ç‰‡
            document.querySelectorAll('#subAdminList [data-subname]').forEach(card => {
                if (card.dataset.subname === name) {
                    card.style.borderColor = 'var(--accent)';
                    card.style.boxShadow = '0 0 8px rgba(0,200,255,0.3)';
                } else {
                    card.style.borderColor = 'var(--border)';
                    card.style.boxShadow = 'none';
                }
            });
            // æ˜¾ç¤ºæ›´æ–°æƒé™æŒ‰é’®
            document.getElementById('updatePermBtn').style.display = '';
            showSubAdminMsg(`å·²é€‰ä¸­ [${name}]ï¼Œå¯ä¿®æ”¹æƒé™åç‚¹å‡»"æ›´æ–°æƒé™"`, 'select');
        }
        
        // ä»…æ›´æ–°æƒé™ï¼ˆä¸éœ€è¦æ”¹å¯†ç ï¼‰
        async function updateSubAdminPermissions() {
            const subName = selectedSubAdmin || document.getElementById('newSubAdminName').value.trim();
            const superPassword = document.getElementById('subAdminSuperPassword').value;
            
            if (!subName) {
                showSubAdminMsg('è¯·å…ˆç‚¹å‡»é€‰æ‹©ä¸€ä¸ªå­ç®¡ç†å‘˜', 'error');
                return;
            }
            if (!superPassword) {
                showSubAdminMsg('è¯·å¡«å†™ç³»ç»Ÿæ€»ç®¡ç†å‘˜å¯†ç ', 'error');
                return;
            }
            
            // æ”¶é›†æƒé™
            const permissions = {};
            const permKeys = ['dashboard', 'online', 'usage', 'users', 'ips', 'banlist', 'license', 'database'];
            permKeys.forEach(key => {
                const cb = document.getElementById('perm_' + key);
                if (cb) permissions[key] = cb.checked;
            });
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin/update_permissions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_password: superPassword,
                        sub_name: subName,
                        permissions: permissions
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    showSubAdminMsg('âœ… ' + data.message, 'success');
                    selectedSubAdmin = null;
                    document.getElementById('updatePermBtn').style.display = 'none';
                    loadSubAdminStatus();
                } else {
                    showSubAdminMsg('âŒ ' + (data.message || 'æ›´æ–°å¤±è´¥'), 'error');
                }
            } catch (e) {
                showSubAdminMsg('âŒ ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºå­ç®¡ç†å‘˜æ¶ˆæ¯
        function showSubAdminMsg(msg, type) {
            const msgDiv = document.getElementById('subAdminMsg');
            msgDiv.style.display = 'block';
            msgDiv.textContent = msg;
            if (type === 'select') {
                msgDiv.style.background = 'rgba(0,200,255,0.1)';
                msgDiv.style.color = 'var(--accent)';
                msgDiv.style.border = '1px solid var(--accent)';
            } else if (type === 'success') {
                msgDiv.style.background = 'rgba(0, 255, 136, 0.1)';
                msgDiv.style.color = 'var(--accent-green)';
                msgDiv.style.border = '1px solid var(--accent-green)';
                setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
            } else {
                msgDiv.style.background = 'rgba(255, 71, 87, 0.1)';
                msgDiv.style.color = 'var(--accent-red)';
                msgDiv.style.border = '1px solid var(--accent-red)';
            }
        }
        
        // åŠ è½½å­ç®¡ç†å‘˜çŠ¶æ€
        async function loadSubAdminStatus() {
            if (!isSuperAdmin()) {
                document.getElementById('subAdminSection').style.display = 'none';
                document.getElementById('proxyPoolSection').style.display = 'none';
                return;
            }
            
            document.getElementById('subAdminSection').style.display = 'block';
            document.getElementById('loadBalanceSection').style.display = 'block';
            loadLbStatus();
            startLbRefresh();
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin`);
                const data = await res.json();
                
                const listDiv = document.getElementById('subAdminList');
                const countSpan = document.getElementById('subAdminCount');
                const subAdmins = data.sub_admins || [];
                
                countSpan.textContent = `ï¼ˆå…± ${subAdmins.length} ä¸ªå­ç®¡ç†å‘˜ï¼‰`;
                
                if (subAdmins.length === 0) {
                    listDiv.innerHTML = `
                        <div style="padding: 20px; text-align: center; background: var(--bg-primary); border-radius: 8px; border: 1px dashed var(--border);">
                            <span style="color: var(--text-secondary); font-size: 14px;">æš‚æ— å­ç®¡ç†å‘˜ï¼Œè¯·åœ¨ä¸‹æ–¹æ·»åŠ </span>
                        </div>
                    `;
                    return;
                }
                
                listDiv.innerHTML = subAdmins.map(sub => {
                    const onlineDot = sub.is_online 
                        ? `<span style="width: 10px; height: 10px; background: var(--accent-green); border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite;"></span>`
                        : `<span style="width: 10px; height: 10px; background: #555; border-radius: 50%; display: inline-block;"></span>`;
                    const loginInfo = sub.login_time ? ` Â· æœ€è¿‘ç™»å½•: ${fmtTime(sub.login_time)}` : '';
                    const statusText = sub.is_online 
                        ? `<span style="color: var(--accent-green); font-size: 12px;">åœ¨çº¿${loginInfo}</span>`
                        : `<span style="color: var(--text-secondary); font-size: 12px;">ç¦»çº¿${loginInfo}</span>`;
                    
                    // æ„å»ºæƒé™æ ‡ç­¾
                    const perms = sub.permissions || {};
                    const permTags = Object.entries(PERM_LABELS)
                        .filter(([key]) => perms[key])
                        .map(([key, label]) => `<span style="display: inline-block; padding: 1px 6px; font-size: 10px; background: rgba(0,255,136,0.1); color: var(--accent-green); border: 1px solid rgba(0,255,136,0.2); border-radius: 3px;">${label}</span>`)
                        .join('');
                    const noPerms = Object.values(perms).filter(v => v).length === 0;
                    const permLine = noPerms 
                        ? '<span style="font-size: 10px; color: var(--accent-red);">âš ï¸ æ— æƒé™</span>' 
                        : permTags;
                    
                    const permJson = JSON.stringify(perms).replace(/'/g, "\\'");
                    const defaultBorder = sub.is_online ? 'rgba(0,255,136,0.3)' : 'var(--border)';
                    return `
                        <div data-subname="${sub.name}" style="padding: 12px 15px; background: var(--bg-primary); 
                                    border-radius: 8px; border: 1px solid ${defaultBorder}; margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s;"
                             onclick="selectSubAdmin('${sub.name}', ${permJson.replace(/"/g, '&quot;')})"
                             onmouseover="if(selectedSubAdmin!=='${sub.name}'){this.style.borderColor='var(--accent)'}"
                             onmouseout="if(selectedSubAdmin!=='${sub.name}'){this.style.borderColor='${defaultBorder}';this.style.boxShadow='none'}"
                        >
                            <div style="display: flex; align-items: center; gap: 12px;">
                                ${onlineDot}
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: bold; color: var(--text-primary); font-size: 14px;">â­ ${sub.name}</div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                        ${statusText}
                                        <span style="color: var(--text-secondary); font-size: 11px;">å¯†ç : ${sub.password_hint}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                    <button onclick="event.stopPropagation(); kickOneSubAdmin('${sub.name}')" style="padding: 4px 10px; font-size: 12px; background: var(--bg-secondary); color: var(--accent-yellow); border: 1px solid rgba(255,165,2,0.3); border-radius: 4px; cursor: pointer;">è¸¢å‡º</button>
                                    <button onclick="event.stopPropagation(); deleteOneSubAdmin('${sub.name}')" style="padding: 4px 10px; font-size: 12px; background: var(--bg-secondary); color: var(--accent-red); border: 1px solid rgba(255,71,87,0.3); border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
                                </div>
                            </div>
                            <div style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 4px; padding-left: 22px;">
                                ${permLine}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('åŠ è½½å­ç®¡ç†å‘˜çŠ¶æ€å¤±è´¥', e);
            }
        }
        
        // æ·»åŠ /æ›´æ–°å­ç®¡ç†å‘˜
        async function setSubAdmin() {
            const subName = document.getElementById('newSubAdminName').value.trim();
            const newSubPassword = document.getElementById('newSubAdminPassword').value;
            const superPassword = document.getElementById('subAdminSuperPassword').value;
            const secondaryPassword = document.getElementById('subAdminSecondaryPassword').value;
            
            if (!subName || !newSubPassword || !superPassword || !secondaryPassword) {
                showSubAdminMsg('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }
            
            if (newSubPassword.length < 6) {
                showSubAdminMsg('å­ç®¡ç†å‘˜å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
                return;
            }
            
            // æ”¶é›†æƒé™é…ç½®
            const permissions = {};
            const permKeys = ['dashboard', 'online', 'usage', 'users', 'ips', 'banlist', 'license', 'database'];
            permKeys.forEach(key => {
                const cb = document.getElementById('perm_' + key);
                if (cb) permissions[key] = cb.checked;
            });
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin/set`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_password: superPassword,
                        secondary_password: secondaryPassword,
                        sub_name: subName,
                        new_sub_password: newSubPassword,
                        permissions: permissions
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showSubAdminMsg('âœ… ' + data.message, 'success');
                    document.getElementById('newSubAdminName').value = '';
                    document.getElementById('newSubAdminPassword').value = '';
                    toggleAllPerms(false);
                    loadSubAdminStatus();
                } else {
                    showSubAdminMsg('âŒ ' + (data.message || 'è®¾ç½®å¤±è´¥'), 'error');
                }
            } catch (e) {
                showSubAdminMsg('âŒ ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
            }
        }
        
        // è¸¢å‡ºæŒ‡å®šå­ç®¡ç†å‘˜
        async function kickOneSubAdmin(name) {
            const superPassword = document.getElementById('subAdminSuperPassword').value;
            if (!superPassword) {
                showSubAdminMsg('è¯·å…ˆåœ¨ä¸‹æ–¹å¡«å†™ç³»ç»Ÿæ€»ç®¡ç†å‘˜å¯†ç ', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦è¸¢å‡ºå­ç®¡ç†å‘˜ [${name}] å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin/kick`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_password: superPassword, sub_name: name })
                });
                const data = await res.json();
                if (data.success) {
                    showSubAdminMsg('âœ… ' + data.message, 'success');
                    loadSubAdminStatus();
                } else {
                    showSubAdminMsg('âŒ ' + (data.message || 'æ“ä½œå¤±è´¥'), 'error');
                }
            } catch (e) {
                showSubAdminMsg('âŒ ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
            }
        }
        
        // è¸¢å‡ºå…¨éƒ¨å­ç®¡ç†å‘˜
        async function kickAllSubAdmins() {
            const superPassword = document.getElementById('subAdminSuperPassword').value;
            if (!superPassword) {
                showSubAdminMsg('è¯·å¡«å†™ç³»ç»Ÿæ€»ç®¡ç†å‘˜å¯†ç ', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦è¸¢å‡ºæ‰€æœ‰åœ¨çº¿çš„å­ç®¡ç†å‘˜å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin/kick`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_password: superPassword, sub_name: '' })
                });
                const data = await res.json();
                if (data.success) {
                    showSubAdminMsg('âœ… ' + data.message, 'success');
                    loadSubAdminStatus();
                } else {
                    showSubAdminMsg('âŒ ' + (data.message || 'æ“ä½œå¤±è´¥'), 'error');
                }
            } catch (e) {
                showSubAdminMsg('âŒ ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
            }
        }
        
        // åˆ é™¤æŒ‡å®šå­ç®¡ç†å‘˜
        async function deleteOneSubAdmin(name) {
            const superPassword = document.getElementById('subAdminSuperPassword').value;
            const secondaryPassword = document.getElementById('subAdminSecondaryPassword').value;
            
            if (!superPassword || !secondaryPassword) {
                showSubAdminMsg('è¯·å…ˆåœ¨ä¸‹æ–¹å¡«å†™ç³»ç»Ÿæ€»ç®¡ç†å‘˜å¯†ç å’ŒäºŒçº§å¯†ç ', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å­ç®¡ç†å‘˜ [${name}] å—ï¼Ÿåˆ é™¤åè¯¥ç®¡ç†å‘˜å°†æ— æ³•ç™»å½•ã€‚`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/sub_admin/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_password: superPassword,
                        secondary_password: secondaryPassword,
                        sub_name: name
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showSubAdminMsg('âœ… ' + data.message, 'success');
                    loadSubAdminStatus();
                } else {
                    showSubAdminMsg('âŒ ' + (data.message || 'åˆ é™¤å¤±è´¥'), 'error');
                }
            } catch (e) {
                showSubAdminMsg('âŒ ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
            }
        }
        
        // ===== ä»£ç†æ± ç®¡ç† =====
        let ppRefreshTimer = null;
        let ppCurrentView = 'slots';
        let ppCachedNodes = [];

        async function loadProxyPoolStatus() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/proxy_pool/status`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('admin_token')}` }
                });
                const data = await res.json();
                if (data.available === false) {
                    document.getElementById('proxyPoolStatus').textContent = 'æ¨¡å—æœªåŠ è½½';
                    document.getElementById('proxyPoolStatus').style.background = 'rgba(255,165,2,0.2)';
                    document.getElementById('proxyPoolStatus').style.color = 'var(--accent-yellow)';
                    document.getElementById('ppRunningInfo').style.display = 'none';
                    return;
                }
                const pool = data.pool;

                // æ›´æ–°å½“å‰è·¯ç”±
                const routeEl = document.getElementById('ppLastRoute');
                const lastRoute = data.last_route || '';
                if (lastRoute) {
                    const isProxy = lastRoute.includes('ä»£ç†');
                    routeEl.textContent = `å½“å‰: ${lastRoute}`;
                    routeEl.style.background = isProxy ? 'rgba(0,200,255,0.15)' : 'rgba(0,255,136,0.15)';
                    routeEl.style.color = isProxy ? '#00c8ff' : 'var(--accent-green)';
                } else {
                    routeEl.textContent = '';
                }

                if (pool && pool.running) {
                    document.getElementById('proxyPoolStatus').textContent = `è¿è¡Œä¸­ (${pool.alive_slots}/${pool.total_slots})`;
                    document.getElementById('proxyPoolStatus').style.background = 'rgba(0,255,136,0.2)';
                    document.getElementById('proxyPoolStatus').style.color = 'var(--accent-green)';
                    document.getElementById('ppRunningInfo').style.display = 'block';

                    document.getElementById('ppTotalReq').textContent = pool.total_requests;
                    document.getElementById('ppTotalSuccess').textContent = pool.total_success;
                    document.getElementById('ppTotalFail').textContent = pool.total_fail;
                    document.getElementById('ppSuccessRate').textContent = pool.success_rate;
                    document.getElementById('ppRateLimitCur').textContent = pool.current_rate_limit;
                    document.getElementById('ppTotalNodes').textContent = pool.total_nodes;

                    // èŠ‚ç‚¹åˆ†çº§ç»Ÿè®¡
                    const tiers = pool.node_tiers || {};
                    document.getElementById('ppTierT1').textContent = tiers.good || 0;
                    document.getElementById('ppTierT2').textContent = tiers.ok || 0;
                    document.getElementById('ppTierT3').textContent = tiers.bad || 0;
                    document.getElementById('ppReadyPool').textContent = tiers.ready_pool || 0;
                    document.getElementById('ppTierInfo').style.display = 'flex';

                    // ç›´è¿çŠ¶æ€
                    const direct = data.direct || {};
                    const ppDirectEl = document.getElementById('ppDirectInfo');
                    if (direct.prefer_direct) {
                        ppDirectEl.style.display = 'block';
                        const reqMin = direct.direct_req_1min || 0;
                        const rateLim = direct.direct_rate_limit || 4;
                        const rateInfo = `(${reqMin}/${rateLim}/min)`;
                        if (direct.is_cooling) {
                            ppDirectEl.innerHTML = `<span style="color:var(--accent-yellow);">ğŸŸ¡ ç›´è¿å†·å´ä¸­ (${Math.round(direct.cooldown_remaining)}s)ï¼Œèµ°ä»£ç† ${rateInfo}</span>`;
                        } else if (reqMin >= rateLim) {
                            ppDirectEl.innerHTML = `<span style="color:var(--accent-yellow);">ğŸŸ¡ ç›´è¿é™é€Ÿä¸­ï¼Œèµ°ä»£ç† ${rateInfo}</span>`;
                        } else {
                            ppDirectEl.innerHTML = `<span style="color:var(--accent-green);">ğŸŸ¢ ä¼˜å…ˆç›´è¿ä¸­ ${rateInfo}</span>`;
                        }
                    } else {
                        ppDirectEl.style.display = 'none';
                    }

                    renderPPSlots(pool.slots || []);
                    ppCachedNodes = pool.nodes || [];
                    if (ppCurrentView === 'nodes') renderPPNodes(ppCachedNodes);

                    if (!ppRefreshTimer) {
                        ppRefreshTimer = setInterval(loadProxyPoolStatus, 5000);
                    }
                } else {
                    document.getElementById('proxyPoolStatus').textContent = 'å·²åŠ è½½Â·æœªå¯ç”¨';
                    document.getElementById('proxyPoolStatus').style.background = 'rgba(255,71,87,0.2)';
                    document.getElementById('proxyPoolStatus').style.color = 'var(--accent-red)';
                    document.getElementById('ppRunningInfo').style.display = 'none';
                    if (ppRefreshTimer) { clearInterval(ppRefreshTimer); ppRefreshTimer = null; }
                }
            } catch (e) {
                console.error('åŠ è½½ä»£ç†æ± çŠ¶æ€å¤±è´¥:', e);
            }
        }

        function renderPPSlots(slots) {
            const container = document.getElementById('ppSlotList');
            if (!slots.length) { container.innerHTML = '<span style="color:var(--text-secondary);font-size:12px;">æ— æ§½ä½</span>'; return; }
            container.innerHTML = slots.map(s => {
                const statusColor = s.alive ? (s.status === 'blocked' ? 'var(--accent-yellow)' : 'var(--accent-green)') : 'var(--accent-red)';
                const statusText = s.alive ? (s.status === 'blocked' ? 'å†·å´ä¸­' : 'åœ¨çº¿') : 'ç¦»çº¿';
                const statusDot = `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${statusColor};margin-right:6px;"></span>`;
                const tierColor = s.node_tier === 'T1' ? 'var(--accent-green)' : s.node_tier === 'T3' ? 'var(--accent-red)' : 'var(--accent-yellow)';
                const tierBadge = `<span style="color:${tierColor};font-size:10px;font-weight:bold;padding:1px 4px;border:1px solid ${tierColor};border-radius:3px;margin-left:4px;">${s.node_tier || '?'}</span>`;
                const cooldownInfo = s.cooldown_left > 0 ? `<span style="color:var(--accent-yellow);margin-left:8px;">â³ ${s.cooldown_left}s</span>` : '';
                const errorInfo = s.last_error ? `<div style="color:var(--accent-red);font-size:11px;margin-top:3px;opacity:0.8;">æœ€è¿‘é”™è¯¯: ${s.last_error}</div>` : '';
                const blockedInfo = s.blocked_count > 0 ? `<span style="color:var(--accent-yellow);">ğŸš«${s.blocked_count}</span>` : '';
                const failStreak = s.consecutive_fails > 0 ? `<span style="color:var(--accent-red);">è¿è´¥${s.consecutive_fails}</span>` : '';
                return `<div style="padding:8px 12px;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border);margin-bottom:4px;font-size:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px;">
                        <span>${statusDot}<strong>Slot ${s.slot_id}</strong> <span style="color:${statusColor};font-size:11px;">[${statusText}]</span>${tierBadge} â†’ ${s.node || '-'} <span style="color:var(--text-secondary);font-size:11px;">:${s.port}</span>${cooldownInfo}</span>
                        <span style="color:var(--text-secondary);">${s.requests_1min}/min | ${s.success}âœ“ ${s.fail}âœ— | ${s.success_rate} ${blockedInfo} ${failStreak}</span>
                    </div>
                    ${errorInfo}
                </div>`;
            }).join('');
        }

        function switchPPView(view) {
            ppCurrentView = view;
            const slotsBtn = document.getElementById('ppViewSlots');
            const nodesBtn = document.getElementById('ppViewNodes');
            const slotList = document.getElementById('ppSlotList');
            const nodeList = document.getElementById('ppNodeList');
            if (view === 'slots') {
                slotsBtn.style.background = 'rgba(0,200,255,0.2)';
                slotsBtn.style.borderColor = '#00c8ff';
                slotsBtn.style.color = '#00c8ff';
                nodesBtn.style.background = 'transparent';
                nodesBtn.style.borderColor = 'var(--border)';
                nodesBtn.style.color = 'var(--text-secondary)';
                slotList.style.display = '';
                nodeList.style.display = 'none';
            } else {
                nodesBtn.style.background = 'rgba(0,200,255,0.2)';
                nodesBtn.style.borderColor = '#00c8ff';
                nodesBtn.style.color = '#00c8ff';
                slotsBtn.style.background = 'transparent';
                slotsBtn.style.borderColor = 'var(--border)';
                slotsBtn.style.color = 'var(--text-secondary)';
                slotList.style.display = 'none';
                nodeList.style.display = '';
                renderPPNodes(ppCachedNodes);
            }
        }

        function renderPPNodes(nodes) {
            const container = document.getElementById('ppNodeList');
            if (!nodes.length) { container.innerHTML = '<span style="color:var(--text-secondary);font-size:12px;">æ— èŠ‚ç‚¹æ•°æ®</span>'; return; }
            container.innerHTML = nodes.map((n, i) => {
                const tierColor = n.tier === 'T1' ? 'var(--accent-green)' : n.tier === 'T3' ? 'var(--accent-red)' : 'var(--accent-yellow)';
                const tierBadge = `<span style="color:${tierColor};font-size:10px;font-weight:bold;padding:1px 4px;border:1px solid ${tierColor};border-radius:3px;">${n.tier}</span>`;
                const inUseBadge = n.in_use ? '<span style="color:#00c8ff;font-size:10px;padding:1px 4px;border:1px solid #00c8ff;border-radius:3px;margin-left:4px;">ä½¿ç”¨ä¸­</span>' : '';
                const verifiedIcon = n.verified ? 'âœ…' : (n.fail_count > 0 ? 'âŒ' : 'â³');
                const latencyText = n.latency > 0 ? `<span style="color:${n.latency < 500 ? 'var(--accent-green)' : n.latency < 1500 ? 'var(--accent-yellow)' : 'var(--accent-red)'};">${Math.round(n.latency)}ms</span>` : '<span style="color:var(--text-secondary);">-</span>';
                const failInfo = n.fail_count > 0 ? `<span style="color:var(--accent-red);margin-left:6px;">å¤±è´¥${n.fail_count}æ¬¡</span>` : '';
                const bgColor = n.in_use ? 'rgba(0,200,255,0.05)' : 'var(--bg-primary)';
                const borderColor = n.in_use ? 'rgba(0,200,255,0.3)' : 'var(--border)';
                return `<div style="padding:6px 12px;background:${bgColor};border-radius:6px;border:1px solid ${borderColor};margin-bottom:3px;font-size:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px;">
                        <span>${verifiedIcon} ${tierBadge}${inUseBadge} <strong style="margin-left:4px;">${n.name}</strong> <span style="color:var(--text-secondary);font-size:11px;">${n.type} | ${n.host}:${n.port}</span></span>
                        <span style="color:var(--text-secondary);">å»¶è¿Ÿ: ${latencyText}${failInfo}</span>
                    </div>
                </div>`;
            }).join('');
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel).classList.add('active');
                
                // åŠ è½½å¯¹åº”æ•°æ®
                if (tab.dataset.panel === 'dashboard') {
                    startDashboard();
                } else {
                    stopDashboard();
                }
                if (tab.dataset.panel === 'online') loadOnlineUsers();
                if (tab.dataset.panel === 'usage') loadUsage();
                if (tab.dataset.panel === 'users') loadBanlist().then(() => loadUsers());
                if (tab.dataset.panel === 'ips') loadIPs();
                if (tab.dataset.panel === 'banlist') loadBanlist();
                if (tab.dataset.panel === 'whitelist') loadWhitelist();
                if (tab.dataset.panel === 'credits') loadCreditsPage();
                if (tab.dataset.panel === 'license') {
                    loadLicenseStats();
                    loadLicenses(0);
                }
                if (tab.dataset.panel === 'database') {
                    // æ£€æŸ¥æ•°æ®åº“æˆæƒçŠ¶æ€
                    checkDbAuth().then(authed => {
                        if (authed) loadDbTables();
                    });
                }
                if (tab.dataset.panel === 'settings') {
                    // åŠ è½½å­ç®¡ç†å‘˜çŠ¶æ€ï¼ˆä»…ç³»ç»Ÿæ€»ç®¡ç†å¯è§ï¼‰
                    loadSubAdminStatus();
                    // å¯åŠ¨å®šæ—¶åˆ·æ–°ï¼ˆæ¯10ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
                    startSubAdminStatusRefresh();
                } else {
                    // ç¦»å¼€è®¾ç½®é¡µé¢æ—¶åœæ­¢åˆ·æ–°
                    stopSubAdminStatusRefresh();
                    stopLbRefresh();
                }
            });
        });
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAll() {
            refreshStats();
            await loadBanlist();
            loadUsers();
            loadIPs();
        }
        
        // ===== æ•°æ®åº“ç®¡ç†åŠŸèƒ½ =====
        let dbCurrentTable = '';
        let dbCurrentPage = 0;
        let dbPageSize = 50;
        let dbSchema = [];
        let dbPkColumn = 'id';
        let dbAuthToken = null;  // æ•°æ®åº“æ“ä½œToken
        
        // è·å–æ•°æ®åº“è¯·æ±‚å¤´ï¼ˆåŒ…å«Tokenï¼‰
        function getDbHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-DB-Token': dbAuthToken || ''
            };
        }
        
        // æ˜¾ç¤ºæ•°æ®åº“éªŒè¯å¼¹çª—
        function showDbAuthModal() {
            document.getElementById('dbAuthModal').style.display = 'flex';
            document.getElementById('dbSecondaryPassword').value = '';
            document.getElementById('dbAuthError').style.display = 'none';
            setTimeout(() => document.getElementById('dbSecondaryPassword').focus(), 100);
        }
        
        // å…³é—­æ•°æ®åº“éªŒè¯å¼¹çª—
        function closeDbAuthModal() {
            document.getElementById('dbAuthModal').style.display = 'none';
            document.getElementById('dbSecondaryPassword').value = '';
            document.getElementById('dbAuthError').style.display = 'none';
        }
        
        // éªŒè¯äºŒçº§å¯†ç 
        async function verifyDbPassword() {
            const password = document.getElementById('dbSecondaryPassword').value;
            const errorEl = document.getElementById('dbAuthError');
            
            if (!password) {
                errorEl.textContent = 'è¯·è¾“å…¥äºŒçº§å¯†ç ';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/db/auth`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: password })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    dbAuthToken = data.token;
                    // ä¿å­˜åˆ° sessionStorage
                    sessionStorage.setItem('db_auth_token', dbAuthToken);
                    // å…³é—­å¼¹çª—
                    closeDbAuthModal();
                    // æ˜¾ç¤ºæ•°æ®åº“æ“ä½œç•Œé¢
                    showDbContent();
                    // åŠ è½½è¡¨åˆ—è¡¨
                    loadDbTables();
                } else {
                    errorEl.textContent = 'äºŒçº§å¯†ç é”™è¯¯';
                    errorEl.style.display = 'block';
                    document.getElementById('dbSecondaryPassword').value = '';
                }
            } catch (e) {
                errorEl.textContent = 'éªŒè¯å¤±è´¥: ' + e.message;
                errorEl.style.display = 'block';
            }
        }
        
        // æ˜¾ç¤ºæ•°æ®åº“æ“ä½œç•Œé¢
        function showDbContent() {
            document.getElementById('dbAuthOverlay').style.display = 'none';
            document.getElementById('dbContent').style.display = 'block';
        }
        
        // é”å®šæ•°æ®åº“ï¼ˆæ¸…é™¤Tokenï¼‰
        function lockDatabase() {
            dbAuthToken = null;
            sessionStorage.removeItem('db_auth_token');
            document.getElementById('dbAuthOverlay').style.display = 'flex';
            document.getElementById('dbContent').style.display = 'none';
            closeDbAuthModal();
        }
        
        // æ£€æŸ¥å¹¶æ¢å¤Token
        async function checkDbAuth() {
            const savedToken = sessionStorage.getItem('db_auth_token');
            if (savedToken) {
                try {
                    const res = await fetch(`${API_BASE}/admin/api/db/verify`, {
                        headers: {'X-DB-Token': savedToken}
                    });
                    const data = await res.json();
                    if (data.valid) {
                        dbAuthToken = savedToken;
                        showDbContent();
                        return true;
                    }
                } catch (e) {
                    console.log('TokenéªŒè¯å¤±è´¥');
                }
            }
            // Tokenæ— æ•ˆï¼Œæ˜¾ç¤ºéªŒè¯ç•Œé¢
            lockDatabase();
            return false;
        }
        
        // å¤„ç†æ•°æ®åº“APIé”™è¯¯ï¼ˆTokenè¿‡æœŸæ—¶è‡ªåŠ¨é”å®šï¼‰
        function handleDbError(res) {
            if (res.status === 403) {
                lockDatabase();
                showAlert('æ•°æ®åº“æ“ä½œæˆæƒå·²è¿‡æœŸï¼Œè¯·é‡æ–°éªŒè¯äºŒçº§å¯†ç ', 'warning');
                return true;
            }
            return false;
        }
        
        // åŠ è½½è¡¨åˆ—è¡¨
        async function loadDbTables() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/db/tables`, {
                    headers: getDbHeaders()
                });
                if (handleDbError(res)) return;
                const tables = await res.json();
                const select = document.getElementById('dbTableSelect');
                select.innerHTML = '<option value="">é€‰æ‹©è¡¨...</option>' + 
                    tables.map(t => `<option value="${t}">${t}</option>`).join('');
            } catch (e) {
                console.error('åŠ è½½è¡¨åˆ—è¡¨å¤±è´¥', e);
            }
        }
        
        // åŠ è½½è¡¨æ•°æ®
        async function loadTableData() {
            const table = document.getElementById('dbTableSelect').value;
            if (!table) return;
            
            dbCurrentTable = table;
            
            try {
                // è·å–è¡¨ç»“æ„
                const schemaRes = await fetch(`${API_BASE}/admin/api/db/schema/${table}`, {
                    headers: getDbHeaders()
                });
                if (handleDbError(schemaRes)) return;
                dbSchema = await schemaRes.json();
                
                // æ‰¾åˆ°ä¸»é”®åˆ—
                const pkCol = dbSchema.find(c => c.pk === 1);
                dbPkColumn = pkCol ? pkCol.name : dbSchema[0]?.name || 'id';
                
                // è·å–æ•°æ®
                const dataRes = await fetch(`${API_BASE}/admin/api/db/query/${table}?limit=${dbPageSize}&offset=${dbCurrentPage * dbPageSize}`, {
                    headers: getDbHeaders()
                });
                if (handleDbError(dataRes)) return;
                const data = await dataRes.json();
                
                // æ¸²æŸ“è¡¨å¤´
                const thead = document.getElementById('dbTableHead');
                thead.innerHTML = '<tr><th style="width:40px;"><input type="checkbox" onchange="dbToggleAll(this.checked)" id="dbCheckAll"></th>' + 
                    dbSchema.map(c => `<th style="white-space: nowrap;">${c.name}<br><span style="font-size: 10px; color: var(--text-secondary);">${c.type}</span></th>`).join('') +
                    '<th>æ“ä½œ</th></tr>';
                
                // æ¸²æŸ“æ•°æ®
                const tbody = document.getElementById('dbTableBody');
                if (data.rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="' + (dbSchema.length + 2) + '" style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— æ•°æ®</td></tr>';
                } else {
                    tbody.innerHTML = data.rows.map(row => {
                        const pkValue = row[dbPkColumn];
                        return `<tr><td><input type="checkbox" class="db-row-check" value="${pkValue}" onchange="dbUpdateSelected()"></td>` + 
                            dbSchema.map(c => {
                                let val = row[c.name];
                                if (val === null) val = '<span style="color: #666;">NULL</span>';
                                else if (c.type && c.type.toLowerCase().includes('timestamp') && val) val = fmtTime(val);
                                else if (typeof val === 'string' && val.length > 50) val = val.substring(0, 50) + '...';
                                return `<td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${String(row[c.name] || '')}">${val}</td>`;
                            }).join('') +
                            `<td style="white-space: nowrap;">
                                <button class="btn" onclick="showEditRowModal('${pkValue}')" style="padding: 4px 10px; font-size: 12px; background: #45aaf2; color: #fff;">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteDbRow('${pkValue}')" style="padding: 4px 10px; font-size: 12px;">åˆ é™¤</button>
                            </td></tr>`;
                    }).join('');
                }
                
                // æ˜¾ç¤ºè¡Œæ•°
                document.getElementById('dbRowCount').textContent = `å…± ${data.total} æ¡è®°å½•`;
                
                // æ¸²æŸ“åˆ†é¡µ
                const totalPages = Math.ceil(data.total / dbPageSize);
                const pagination = document.getElementById('dbPagination');
                if (totalPages > 1) {
                    let html = '';
                    html += `<button class="btn-page" onclick="dbGoPage(${dbCurrentPage - 1})" ${dbCurrentPage <= 0 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
                    html += `<span style="color: var(--text-secondary); line-height: 32px;">ç¬¬ ${dbCurrentPage + 1} / ${totalPages} é¡µ</span>`;
                    html += `<button class="btn-page" onclick="dbGoPage(${dbCurrentPage + 1})" ${dbCurrentPage >= totalPages - 1 ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
                    pagination.innerHTML = html;
                } else {
                    pagination.innerHTML = '';
                }
            } catch (e) {
                console.error('åŠ è½½è¡¨æ•°æ®å¤±è´¥', e);
            }
        }
        
        function dbGoPage(page) {
            dbCurrentPage = page;
            loadTableData();
        }
        
        // æ˜¾ç¤ºæ–°å¢è¡Œå¼¹çª—
        function showAddRowModal() {
            if (!dbCurrentTable || dbSchema.length === 0) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¡¨', 'warning');
                return;
            }
            
            const fields = dbSchema.filter(c => !c.pk || c.dflt_value !== null).map(c => `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 14px;">${c.name} (${c.type})${c.notnull ? ' *' : ''}</label>
                    <input type="text" id="dbAdd_${c.name}" placeholder="${c.dflt_value || ''}" 
                           style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                </div>
            `).join('');
            
            showModal('æ–°å¢è®°å½•', fields, async () => {
                const data = {};
                dbSchema.forEach(c => {
                    if (c.pk && c.dflt_value === null) return; // è·³è¿‡è‡ªå¢ä¸»é”®
                    const val = document.getElementById(`dbAdd_${c.name}`)?.value;
                    if (val !== undefined && val !== '') data[c.name] = val;
                });
                
                try {
                    const res = await fetch(`${API_BASE}/admin/api/db/insert/${dbCurrentTable}`, {
                        method: 'POST',
                        headers: getDbHeaders(),
                        body: JSON.stringify(data)
                    });
                    if (handleDbError(res)) return;
                    const result = await res.json();
                    if (result.success) {
                        closeModal();
                        loadTableData();
                    } else {
                        showAlert('æ–°å¢å¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                } catch (e) {
                    showAlert('æ–°å¢å¤±è´¥: ' + e.message, 'error');
                }
            });
        }
        
        // æ˜¾ç¤ºç¼–è¾‘è¡Œå¼¹çª—
        async function showEditRowModal(pkValue) {
            if (!dbCurrentTable) return;
            
            // è·å–å½“å‰è¡Œæ•°æ®
            const res = await fetch(`${API_BASE}/admin/api/db/query/${dbCurrentTable}?limit=1&offset=0`, {
                headers: getDbHeaders()
            });
            if (handleDbError(res)) return;
            const data = await res.json();
            let row = data.rows.find(r => String(r[dbPkColumn]) === String(pkValue));
            
            if (!row) {
                // é‡æ–°æŸ¥è¯¢
                const allRes = await fetch(`${API_BASE}/admin/api/db/sql`, {
                    method: 'POST',
                    headers: getDbHeaders(),
                    body: JSON.stringify({sql: `SELECT * FROM ${dbCurrentTable} WHERE ${dbPkColumn} = '${pkValue}'`})
                });
                if (handleDbError(allRes)) return;
                const allData = await allRes.json();
                if (allData.success && allData.result.length > 0) {
                    row = allData.result[0];
                }
            }
            
            const fields = dbSchema.map(c => `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 14px;">${c.name} (${c.type})${c.pk ? ' [ä¸»é”®]' : ''}</label>
                    <input type="text" id="dbEdit_${c.name}" value="${row?.[c.name] ?? ''}" ${c.pk ? 'readonly style="background: #333;"' : ''}
                           style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                </div>
            `).join('');
            
            showModal('ç¼–è¾‘è®°å½•', fields, async () => {
                const data = {_pk_column: dbPkColumn, _pk_value: pkValue};
                dbSchema.forEach(c => {
                    if (c.pk) return; // è·³è¿‡ä¸»é”®
                    const raw = document.getElementById(`dbEdit_${c.name}`)?.value;
                    if (raw === undefined) return;
                    // æ ¹æ®åˆ—ç±»å‹è½¬æ¢å€¼
                    const t = c.type.toLowerCase();
                    if (raw === '') { data[c.name] = null; }
                    else if (t.includes('int') || t === 'bigserial' || t === 'serial') { data[c.name] = parseInt(raw, 10); }
                    else if (t.includes('double') || t.includes('float') || t === 'real' || t === 'numeric' || t === 'decimal') { data[c.name] = parseFloat(raw); }
                    else if (t === 'boolean' || t === 'bool') { data[c.name] = raw.toLowerCase() === 'true' || raw === '1'; }
                    else { data[c.name] = raw; }
                });
                
                try {
                    const res = await fetch(`${API_BASE}/admin/api/db/update/${dbCurrentTable}`, {
                        method: 'PUT',
                        headers: getDbHeaders(),
                        body: JSON.stringify(data)
                    });
                    if (handleDbError(res)) return;
                    const result = await res.json();
                    if (result.success) {
                        closeModal();
                        loadTableData();
                    } else {
                        showAlert('æ›´æ–°å¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                } catch (e) {
                    showAlert('æ›´æ–°å¤±è´¥: ' + e.message, 'error');
                }
            });
        }
        
        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function dbToggleAll(checked) {
            document.querySelectorAll('.db-row-check').forEach(cb => cb.checked = checked);
            dbUpdateSelected();
        }

        // æ›´æ–°å·²é€‰è®¡æ•°å’Œæ‰¹é‡åˆ é™¤æŒ‰é’®
        function dbUpdateSelected() {
            const checked = document.querySelectorAll('.db-row-check:checked');
            const btn = document.getElementById('dbBatchDeleteBtn');
            const count = document.getElementById('dbSelectedCount');
            count.textContent = checked.length;
            btn.style.display = checked.length > 0 ? 'inline-block' : 'none';
        }

        // æ‰¹é‡åˆ é™¤
        async function batchDeleteDbRows() {
            const checked = document.querySelectorAll('.db-row-check:checked');
            if (checked.length === 0) return;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checked.length} æ¡è®°å½•å—ï¼Ÿ`)) return;
            let ok = 0, fail = 0;
            for (const cb of checked) {
                try {
                    const res = await fetch(`${API_BASE}/admin/api/db/delete/${dbCurrentTable}?pk_column=${dbPkColumn}&pk_value=${cb.value}`, {
                        method: 'DELETE', headers: getDbHeaders()
                    });
                    const r = await res.json();
                    if (r.success) ok++; else fail++;
                } catch(e) { fail++; }
            }
            showToast(`åˆ é™¤å®Œæˆ: æˆåŠŸ${ok}æ¡${fail > 0 ? ', å¤±è´¥' + fail + 'æ¡' : ''}`);
            loadTableData();
        }

        // åˆ é™¤è¡Œ
        async function deleteDbRow(pkValue) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${dbPkColumn}=${pkValue} çš„è®°å½•å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/db/delete/${dbCurrentTable}?pk_column=${dbPkColumn}&pk_value=${pkValue}`, {
                    method: 'DELETE',
                    headers: getDbHeaders()
                });
                if (handleDbError(res)) return;
                const result = await res.json();
                if (result.success) {
                    loadTableData();
                } else {
                    showAlert('åˆ é™¤å¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                showAlert('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºSQLæ‰§è¡Œå¼¹çª—
        function showSqlModal() {
            const content = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">è¾“å…¥SQLè¯­å¥</label>
                    <textarea id="sqlInput" rows="5" placeholder="SELECT * FROM user_stats LIMIT 10" 
                              style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: monospace;"></textarea>
                </div>
                <div id="sqlResult" style="max-height: 300px; overflow: auto; background: var(--bg-primary); border-radius: 6px; padding: 10px; display: none;"></div>
            `;
            
            showModal('æ‰§è¡ŒSQL', content, async () => {
                const sql = document.getElementById('sqlInput').value.trim();
                if (!sql) return;
                
                try {
                    const res = await fetch(`${API_BASE}/admin/api/db/sql`, {
                        method: 'POST',
                        headers: getDbHeaders(),
                        body: JSON.stringify({sql})
                    });
                    if (handleDbError(res)) { closeModal(); return; }
                    const result = await res.json();
                    const resultDiv = document.getElementById('sqlResult');
                    resultDiv.style.display = 'block';
                    
                    if (result.success) {
                        if (Array.isArray(result.result)) {
                            if (result.result.length === 0) {
                                resultDiv.innerHTML = '<span style="color: var(--text-secondary);">æŸ¥è¯¢ç»“æœä¸ºç©º</span>';
                            } else {
                                const cols = Object.keys(result.result[0]);
                                resultDiv.innerHTML = `<table style="width: 100%; font-size: 12px;"><thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody>${result.result.map(r => `<tr>${cols.map(c => `<td>${r[c]}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
                            }
                        } else {
                            resultDiv.innerHTML = `<span style="color: var(--accent-green);">æ‰§è¡ŒæˆåŠŸï¼Œå½±å“ ${result.result.affected_rows} è¡Œ</span>`;
                            loadTableData();
                        }
                    } else {
                        resultDiv.innerHTML = `<span style="color: var(--accent-red);">é”™è¯¯: ${result.detail}</span>`;
                    }
                } catch (e) {
                    document.getElementById('sqlResult').innerHTML = `<span style="color: var(--accent-red);">é”™è¯¯: ${e.message}</span>`;
                    document.getElementById('sqlResult').style.display = 'block';
                }
            }, 'æ‰§è¡Œ');
        }
        
        // Toast é€šçŸ¥
        function showToast(msg, type = 'success') {
            const colors = {success: 'linear-gradient(135deg,#00c9b7,#7ed56f)', error: 'linear-gradient(135deg,#ff5252,#ff7b7b)', info: 'linear-gradient(135deg,#4facfe,#00f2fe)'};
            const t = document.createElement('div');
            t.style.cssText = `position:fixed;top:30px;left:50%;transform:translateX(-50%);padding:14px 28px;border-radius:10px;color:#fff;font-size:15px;font-weight:bold;z-index:99999;background:${colors[type]||colors.info};box-shadow:0 4px 20px rgba(0,0,0,0.3);opacity:0;transition:opacity 0.3s;`;
            t.textContent = msg;
            document.body.appendChild(t);
            requestAnimationFrame(() => t.style.opacity = '1');
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2500);
        }

        // ä¸»é¢˜é£æ ¼æç¤ºå¼¹çª—ï¼ˆæ›¿ä»£åŸç”Ÿalertï¼‰
        function showAlert(msg, type = 'info') {
            const oldAlert = document.getElementById('themeAlert');
            if (oldAlert) oldAlert.remove();
            const icons = {success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸', warning: 'âš ï¸'};
            const colors = {success: 'var(--accent-green, #00ff88)', error: 'var(--accent-red, #ff4757)', info: 'var(--accent, #00e5ff)', warning: '#ffd740'};
            const borderColor = colors[type] || colors.info;
            const icon = icons[type] || icons.info;
            const overlay = document.createElement('div');
            overlay.id = 'themeAlert';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:99999;';
            overlay.innerHTML = `
                <div style="background:var(--bg-card,#1a1f2e);border-radius:14px;max-width:400px;width:90%;border:1px solid ${borderColor}44;box-shadow:0 8px 32px rgba(0,0,0,0.5),0 0 20px ${borderColor}22;animation:alertIn 0.2s ease-out;">
                    <div style="padding:24px 28px 16px;text-align:center;">
                        <div style="font-size:36px;margin-bottom:12px;">${icon}</div>
                        <div style="color:var(--text-primary,#e8e8e8);font-size:14px;line-height:1.7;word-break:break-word;white-space:pre-wrap;">${msg.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                    </div>
                    <div style="padding:12px 28px 20px;text-align:center;">
                        <button id="themeAlertBtn" style="padding:10px 48px;border:1px solid ${borderColor};border-radius:8px;background:${borderColor}22;color:${borderColor};font-size:14px;cursor:pointer;font-weight:bold;transition:all 0.2s;" onmouseover="this.style.background='${borderColor}44'" onmouseout="this.style.background='${borderColor}22'">ç¡® å®š</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            const btn = document.getElementById('themeAlertBtn');
            btn.onclick = () => overlay.remove();
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            btn.focus();
        }

        // é€šç”¨å¼¹çª—å‡½æ•°
        function showModal(title, content, onConfirm, confirmText = 'ç¡®å®š') {
            // ç§»é™¤æ—§å¼¹çª—
            const oldModal = document.getElementById('dbModal');
            if (oldModal) oldModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'dbModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 12px; max-width: 420px; width: 90%; max-height: 80vh; border: 1px solid var(--border); display: flex; flex-direction: column;">
                    <h3 style="padding: 20px 25px 15px; margin: 0; color: var(--accent); border-bottom: 1px solid var(--border); flex-shrink: 0;">${title}</h3>
                    <div style="padding: 15px 25px; overflow-y: auto; flex: 1;">${content}</div>
                    <div style="display: flex; gap: 10px; padding: 15px 25px 20px; border-top: 1px solid var(--border); flex-shrink: 0;">
                        <button class="btn" onclick="closeModal()" style="flex:1; padding: 12px 0; background: var(--accent-red); color: white; font-size: 15px; border-radius: 8px;">å–æ¶ˆ</button>
                        <button class="btn btn-primary" id="modalConfirmBtn" style="flex:1; padding: 12px 0; font-size: 15px; border-radius: 8px;">${confirmText}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modalConfirmBtn').onclick = onConfirm;
        }
        
        function closeModal() {
            const modal = document.getElementById('dbModal');
            if (modal) modal.remove();
        }
        
        // ===== æ¿€æ´»ç ç®¡ç†åŠŸèƒ½ =====
        let licenseCurrentPage = 0;
        let licensePageSize = 50;
        let licenseSearchTerm = '';
        let licenseAllData = []; // å½“å‰é¡µåŸå§‹æ•°æ®ç¼“å­˜
        let licenseTotalCount = 0;
        let licenseSortDir = 0; // 0=ä¸æ’åº, 1=å‡åº, -1=é™åº
        let licenseBillingFilter = '';
        let licenseStatusFilter = '';
        
        // è·å–å¸¦Tokençš„è¯·æ±‚å¤´
        function getLicenseHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('admin_token') || ''}`
            };
        }
        
        // åŠ è½½æ¿€æ´»ç ç»Ÿè®¡
        async function loadLicenseStats() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/license/statistics`, {
                    headers: getLicenseHeaders()
                });
                if (!checkTokenValid(res)) return;
                const data = await res.json();
                
                if (!data.error && data.data) {
                    document.getElementById('licStatTotal').textContent = data.data.total_licenses || 0;
                    document.getElementById('licStatActive').textContent = data.data.active_licenses || 0;
                    document.getElementById('licStatClients').textContent = data.data.active_clients || 0;
                    document.getElementById('licStatBlacklist').textContent = data.data.blacklist_count || 0;
                }
            } catch (e) {
                console.error('åŠ è½½æ¿€æ´»ç ç»Ÿè®¡å¤±è´¥', e);
            }
        }
        
        // è·å–å‰©ä½™å€¼çš„æ•°å€¼ï¼ˆç”¨äºæ’åºï¼‰
        function getLicenseRemainingValue(license) {
            if (license.billing_mode === 'unlimited') return Infinity;
            if (license.billing_mode === 'per_use') return license.remaining_uses || 0;
            if (license.billing_mode === 'time_based') return license.remaining_time || 0;
            return 0;
        }
        
        // åŠ è½½æ¿€æ´»ç åˆ—è¡¨
        async function loadLicenses(page = 0) {
            licenseCurrentPage = page;
            const offset = page * licensePageSize;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/license/list?limit=${licensePageSize}&offset=${offset}`, {
                    headers: getLicenseHeaders()
                });
                if (!checkTokenValid(res)) return;
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('licenseTable').innerHTML = 
                        `<tr><td colspan="7" style="text-align: center; color: var(--accent-red);">åŠ è½½å¤±è´¥: ${data.message}</td></tr>`;
                    return;
                }
                
                licenseAllData = data.data?.items || [];
                licenseTotalCount = data.data?.total || 0;
                
                renderLicenseTable();
                
            } catch (e) {
                console.error('åŠ è½½æ¿€æ´»ç åˆ—è¡¨å¤±è´¥', e);
                document.getElementById('licenseTable').innerHTML = 
                    `<tr><td colspan="7" style="text-align: center; color: var(--accent-red);">ç½‘ç»œé”™è¯¯: ${e.message}</td></tr>`;
            }
        }
        
        // æ¸²æŸ“æ¿€æ´»ç è¡¨æ ¼ï¼ˆåº”ç”¨ç­›é€‰+æœç´¢+æ’åºï¼‰
        function renderLicenseTable() {
            let filtered = [...licenseAllData];
            
            // æœç´¢è¿‡æ»¤
            if (licenseSearchTerm) {
                const term = licenseSearchTerm.toLowerCase();
                filtered = filtered.filter(l => 
                    l.license_key?.toLowerCase().includes(term) ||
                    l.product_id?.toLowerCase().includes(term) ||
                    l.machine_id?.toLowerCase().includes(term)
                );
            }
            
            // è®¡è´¹æ¨¡å¼ç­›é€‰
            if (licenseBillingFilter) {
                filtered = filtered.filter(l => l.billing_mode === licenseBillingFilter);
            }
            
            // çŠ¶æ€ç­›é€‰
            if (licenseStatusFilter) {
                filtered = filtered.filter(l => l.status === licenseStatusFilter);
            }
            
            // æŒ‰å‰©ä½™æ’åº
            if (licenseSortDir !== 0) {
                filtered.sort((a, b) => {
                    const va = getLicenseRemainingValue(a);
                    const vb = getLicenseRemainingValue(b);
                    return licenseSortDir === 1 ? va - vb : vb - va;
                });
            }
            
            if (filtered.length === 0) {
                document.getElementById('licenseTable').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">æ— åŒ¹é…çš„æ¿€æ´»ç </td></tr>';
                renderLicensePagination(licenseTotalCount);
                return;
            }
            
            document.getElementById('licenseTable').innerHTML = filtered.map(license => {
                const statusClass = {
                    'active': 'status-active',
                    'inactive': 'status-inactive',
                    'expired': 'status-expired',
                    'revoked': 'status-revoked'
                }[license.status] || '';
                
                const statusText = {
                    'active': 'å·²æ¿€æ´»',
                    'inactive': 'æœªæ¿€æ´»',
                    'expired': 'å·²è¿‡æœŸ',
                    'revoked': 'å·²æ’¤é”€',
                    'suspended': 'å·²æš‚åœ'
                }[license.status] || license.status;
                
                const billingText = {
                    'per_use': 'æŒ‰æ¬¡æ•°',
                    'time_based': 'æŒ‰æ—¶é—´',
                    'unlimited': 'æ— é™åˆ¶'
                }[license.billing_mode] || license.billing_mode;
                
                // å‰©ä½™æ˜¾ç¤º
                let remainingText = '-';
                if (license.billing_mode === 'per_use') {
                    remainingText = `${license.remaining_uses || 0} æ¬¡`;
                } else if (license.billing_mode === 'time_based') {
                    const minutes = license.remaining_time || 0;
                    const days = (minutes / 1440).toFixed(1);
                    remainingText = `${days} å¤©`;
                } else if (license.billing_mode === 'unlimited') {
                    remainingText = 'âˆ';
                }
                
                return `
                    <tr>
                        <td style="font-family: monospace; font-size: 12px;">
                            <span style="cursor: pointer;" onclick="copyToClipboard('${license.license_key}')" title="ç‚¹å‡»å¤åˆ¶">${license.license_key}</span>
                        </td>
                        <td>${license.product_id || '-'}</td>
                        <td>${billingText}</td>
                        <td>${remainingText}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>${fmtTime(license.created_at)}</td>
                        <td>
                            <button class="btn-small" onclick="showLicenseDetail('${license.license_key}')" style="padding: 4px 10px; font-size: 12px; background: var(--bg-secondary); color: var(--accent); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">è¯¦æƒ…</button>
                            ${license.status === 'active' ? `<button class="btn-small" onclick="revokeLicense('${license.license_key}')" style="padding: 4px 10px; font-size: 12px; background: var(--bg-secondary); color: var(--accent-red); border: 1px solid rgba(255,71,87,0.3); border-radius: 4px; cursor: pointer;">æ’¤é”€</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // æ¸²æŸ“åˆ†é¡µ
            renderLicensePagination(licenseTotalCount);
        }
        
        // æ¸²æŸ“åˆ†é¡µ
        function renderLicensePagination(total) {
            const totalPages = Math.ceil(total / licensePageSize);
            const container = document.getElementById('licensePagination');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // ä¸Šä¸€é¡µ
            html += `<button class="btn-page" onclick="loadLicenses(${licenseCurrentPage - 1})" ${licenseCurrentPage <= 0 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            
            // é¡µç 
            for (let i = 0; i < totalPages && i < 10; i++) {
                const activeClass = i === licenseCurrentPage ? ' active' : '';
                html += `<button class="btn-page${activeClass}" onclick="loadLicenses(${i})">${i + 1}</button>`;
            }
            
            // ä¸‹ä¸€é¡µ
            html += `<button class="btn-page" onclick="loadLicenses(${licenseCurrentPage + 1})" ${licenseCurrentPage >= totalPages - 1 ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            
            container.innerHTML = html;
        }
        
        // æœç´¢æ¿€æ´»ç 
        function searchLicenses() {
            licenseSearchTerm = document.getElementById('licenseSearch').value.trim();
            licenseBillingFilter = document.getElementById('licBillingFilter').value;
            licenseStatusFilter = document.getElementById('licStatusFilter').value;
            renderLicenseTable();
        }
        
        // åº”ç”¨ç­›é€‰ï¼ˆä¸‹æ‹‰æ¡†å˜åŒ–æ—¶è§¦å‘ï¼‰
        function applyLicenseFilters() {
            licenseBillingFilter = document.getElementById('licBillingFilter').value;
            licenseStatusFilter = document.getElementById('licStatusFilter').value;
            renderLicenseTable();
        }
        
        // æ¸…é™¤æ‰€æœ‰ç­›é€‰
        function clearLicenseFilters() {
            document.getElementById('licenseSearch').value = '';
            document.getElementById('licBillingFilter').value = '';
            document.getElementById('licStatusFilter').value = '';
            licenseSearchTerm = '';
            licenseBillingFilter = '';
            licenseStatusFilter = '';
            licenseSortDir = 0;
            document.getElementById('licSortIcon').textContent = 'â‡…';
            renderLicenseTable();
        }
        
        // åˆ‡æ¢å‰©ä½™æ’åºæ–¹å‘
        function toggleLicenseSort() {
            // 0 -> 1(å‡åº) -> -1(é™åº) -> 0(ä¸æ’åº)
            if (licenseSortDir === 0) licenseSortDir = 1;
            else if (licenseSortDir === 1) licenseSortDir = -1;
            else licenseSortDir = 0;
            
            const iconEl = document.getElementById('licSortIcon');
            if (licenseSortDir === 1) iconEl.textContent = 'â†‘';
            else if (licenseSortDir === -1) iconEl.textContent = 'â†“';
            else iconEl.textContent = 'â‡…';
            
            renderLicenseTable();
        }
        
        // ===== æ¿€æ´»ç å­æ ‡ç­¾åˆ‡æ¢ =====
        let licCurrentTab = 'list';
        let licCreateLogsPage = 0;
        let licUsageLogsPage = 0;
        const licLogsPageSize = 50;
        
        function switchLicenseTab(tab) {
            licCurrentTab = tab;
            // åˆ‡æ¢é¢æ¿
            document.getElementById('licPanelList').style.display = tab === 'list' ? 'block' : 'none';
            document.getElementById('licPanelCreate').style.display = tab === 'create' ? 'block' : 'none';
            document.getElementById('licPanelUsage').style.display = tab === 'usage' ? 'block' : 'none';
            
            // åˆ‡æ¢tabæŒ‰é’®æ ·å¼
            ['licTabList', 'licTabCreate', 'licTabUsage'].forEach(id => {
                const btn = document.getElementById(id);
                const isActive = (id === 'licTab' + tab.charAt(0).toUpperCase() + tab.slice(1)) ||
                                 (tab === 'list' && id === 'licTabList') ||
                                 (tab === 'create' && id === 'licTabCreate') ||
                                 (tab === 'usage' && id === 'licTabUsage');
                btn.style.background = isActive ? 'var(--accent)' : 'var(--bg-card)';
                btn.style.color = isActive ? '#fff' : 'var(--text-secondary)';
                btn.style.fontWeight = isActive ? 'bold' : 'normal';
            });
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tab === 'create') loadLicenseCreateLogs(0);
            else if (tab === 'usage') loadLicenseUsageLogs(0);
        }
        
        // åŠ è½½åˆ›å»ºè®°å½•
        async function loadLicenseCreateLogs(page = 0) {
            licCreateLogsPage = page;
            const tbody = document.getElementById('licCreateLogsTable');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/license/local-logs?action=create&limit=${licLogsPageSize}&offset=${page * licLogsPageSize}`, {
                    headers: getLicenseHeaders()
                });
                if (!checkTokenValid(res)) return;
                const data = await res.json();
                
                const rows = data.rows || [];
                const total = data.total || 0;
                
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">æš‚æ— åˆ›å»ºè®°å½•</td></tr>';
                } else {
                    const billingTextMap = {'per_use': 'æŒ‰æ¬¡æ•°', 'time_based': 'æŒ‰æ—¶é—´', 'unlimited': 'æ— é™åˆ¶'};
                    tbody.innerHTML = rows.map(row => `
                        <tr>
                            <td style="white-space: nowrap;">${fmtTime(row.created_at)}</td>
                            <td style="font-family: monospace; font-size: 12px;">
                                <span style="cursor: pointer;" onclick="copyToClipboard('${row.license_key || ''}')" title="ç‚¹å‡»å¤åˆ¶">${row.license_key || '-'}</span>
                            </td>
                            <td>${row.product_id || '-'}</td>
                            <td>${billingTextMap[row.billing_mode] || row.billing_mode || '-'}</td>
                            <td>${row.detail || '-'}</td>
                            <td>${row.operator || '-'}</td>
                        </tr>
                    `).join('');
                }
                
                // åˆ†é¡µ
                renderLogsPagination('licCreateLogsPagination', total, licLogsPageSize, page, 'loadLicenseCreateLogs');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--accent-red);">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
            }
        }
        
        // åŠ è½½ä½¿ç”¨è®°å½•ï¼ˆä»è¿œç¨‹æœåŠ¡å™¨ + æœ¬åœ°æ’¤é”€è®°å½•ï¼‰
        async function loadLicenseUsageLogs(page = 0) {
            licUsageLogsPage = page;
            const tbody = document.getElementById('licUsageLogsTable');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">åŠ è½½ä¸­...</td></tr>';
            
            try {
                // åŒæ—¶è¯·æ±‚è¿œç¨‹ä½¿ç”¨æ—¥å¿—å’Œæœ¬åœ°æ“ä½œæ—¥å¿—
                const [remoteRes, localRes] = await Promise.all([
                    fetch(`${API_BASE}/admin/api/license/logs?limit=${licLogsPageSize}&offset=${page * licLogsPageSize}`, {
                        headers: getLicenseHeaders()
                    }).catch(() => null),
                    fetch(`${API_BASE}/admin/api/license/local-logs?limit=${licLogsPageSize}&offset=${page * licLogsPageSize}`, {
                        headers: getLicenseHeaders()
                    }).catch(() => null)
                ]);
                
                let allRows = [];
                let total = 0;
                
                // è¿œç¨‹æ—¥å¿—
                if (remoteRes && remoteRes.ok) {
                    const remoteData = await remoteRes.json();
                    if (!remoteData.error && remoteData.data) {
                        const items = remoteData.data.items || remoteData.data || [];
                        if (Array.isArray(items)) {
                            allRows = items.map(r => ({
                                time: r.timestamp || r.created_at || '',
                                license_key: r.license_key || '',
                                action: r.action || r.event || '',
                                detail: r.details || r.message || r.machine_id || '',
                                operator: r.client_ip || r.ip || '-'
                            }));
                            total = remoteData.data.total || items.length;
                        }
                    }
                }
                
                // å¦‚æœè¿œç¨‹æ²¡æ•°æ®ï¼Œç”¨æœ¬åœ°écreateçš„æ—¥å¿—
                if (allRows.length === 0 && localRes && localRes.ok) {
                    const localData = await localRes.json();
                    const rows = localData.rows || [];
                    total = localData.total || 0;
                    const actionMap = {'create': 'åˆ›å»º', 'revoke': 'æ’¤é”€', 'activate': 'æ¿€æ´»', 'use': 'ä½¿ç”¨'};
                    allRows = rows.map(r => ({
                        time: r.created_at || '',
                        license_key: r.license_key || '',
                        action: actionMap[r.action] || r.action || '',
                        detail: r.detail || '-',
                        operator: r.operator || '-'
                    }));
                }
                
                if (allRows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">æš‚æ— ä½¿ç”¨è®°å½•</td></tr>';
                } else {
                    tbody.innerHTML = allRows.map(row => {
                        const actionClass = {
                            'activate': 'status-active', 'use': 'status-active', 'æ¿€æ´»': 'status-active', 'ä½¿ç”¨': 'status-active',
                            'revoke': 'status-revoked', 'æ’¤é”€': 'status-revoked',
                            'create': 'status-inactive', 'åˆ›å»º': 'status-inactive'
                        }[row.action] || '';
                        return `
                            <tr>
                                <td style="white-space: nowrap;">${fmtTime(row.time)}</td>
                                <td style="font-family: monospace; font-size: 12px;">${row.license_key || '-'}</td>
                                <td><span class="status ${actionClass}">${row.action || '-'}</span></td>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${row.detail || '-'}</td>
                                <td>${row.operator || '-'}</td>
                            </tr>
                        `;
                    }).join('');
                }
                
                renderLogsPagination('licUsageLogsPagination', total, licLogsPageSize, page, 'loadLicenseUsageLogs');
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--accent-red);">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
            }
        }
        
        // æ¸²æŸ“æ—¥å¿—åˆ†é¡µ
        function renderLogsPagination(containerId, total, pageSize, currentPage, loadFnName) {
            const totalPages = Math.ceil(total / pageSize);
            const container = document.getElementById(containerId);
            if (totalPages <= 1) { container.innerHTML = ''; return; }
            
            let html = '';
            html += `<button class="btn-page" onclick="${loadFnName}(${currentPage - 1})" ${currentPage <= 0 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            html += `<span style="color: var(--text-secondary); line-height: 32px; font-size: 13px;">ç¬¬ ${currentPage + 1} / ${totalPages} é¡µ</span>`;
            html += `<button class="btn-page" onclick="${loadFnName}(${currentPage + 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            container.innerHTML = html;
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(e => {
                console.error('å¤åˆ¶å¤±è´¥', e);
            });
        }
        
        // æ˜¾ç¤ºåˆ›å»ºæ¿€æ´»ç å¼¹çª—
        function showCreateLicenseModal() {
            document.getElementById('createLicenseModal').style.display = 'flex';
            document.getElementById('licBatchCount').value = 1;
            document.getElementById('createLicenseMsg').style.display = 'none';
            document.getElementById('createLicenseProgress').style.display = 'none';
            document.getElementById('createLicenseBtn').disabled = false;
            document.getElementById('createLicenseBtn').textContent = 'åˆ›å»º';
            // åˆå§‹åŒ–äº§å“ç±»å‹å’Œè®¡è´¹æ¨¡å¼
            onProductTypeChange();
        }
        
        // å…³é—­åˆ›å»ºæ¿€æ´»ç å¼¹çª—
        function closeCreateLicenseModal() {
            document.getElementById('createLicenseModal').style.display = 'none';
            document.getElementById('createLicenseMsg').style.display = 'none';
            document.getElementById('createLicenseProgress').style.display = 'none';
        }
        
        // äº§å“ç±»å‹å˜åŒ–
        function onProductTypeChange() {
            const productId = document.getElementById('licProductId').value;
            const billingModeSelect = document.getElementById('licBillingMode');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            billingModeSelect.innerHTML = '';
            
            // æ ¹æ®äº§å“ç±»å‹æ·»åŠ å¯¹åº”çš„è®¡è´¹æ¨¡å¼
            if (productId === 'ak_admin_panel') {
                // ç®¡ç†é¢æ¿ï¼šåªæ”¯æŒæ— é™åˆ¶å’ŒæŒ‰æ—¶é—´
                billingModeSelect.innerHTML = `
                    <option value="unlimited">æ— é™åˆ¶ (unlimited)</option>
                    <option value="time_based">æŒ‰æ—¶é—´ (time_based)</option>
                `;
            } else {
                // å…¶ä»–äº§å“ï¼šæ”¯æŒæ‰€æœ‰è®¡è´¹æ¨¡å¼
                billingModeSelect.innerHTML = `
                    <option value="unlimited">æ— é™åˆ¶ (unlimited)</option>
                    <option value="per_use">æŒ‰æ¬¡æ•° (per_use)</option>
                    <option value="time_based">æŒ‰æ—¶é—´ (time_based)</option>
                `;
            }
            
            // æ›´æ–°è®¡è´¹æ¨¡å¼ç›¸å…³æ˜¾ç¤º
            onBillingModeChange();
        }
        
        // è®¡è´¹æ¨¡å¼å˜åŒ–
        function onBillingModeChange() {
            const mode = document.getElementById('licBillingMode').value;
            document.getElementById('licMaxUsesRow').style.display = mode === 'per_use' ? 'block' : 'none';
            document.getElementById('licUsageTimeRow').style.display = mode === 'time_based' ? 'block' : 'none';
        }
        
        // åˆ›å»ºæ¿€æ´»ç ï¼ˆæ”¯æŒæ‰¹é‡ï¼‰
        async function doCreateLicense() {
            const productId = document.getElementById('licProductId').value;
            const billingMode = document.getElementById('licBillingMode').value;
            const maxUses = parseInt(document.getElementById('licMaxUses').value) || 100;
            const usageTime = parseFloat(document.getElementById('licUsageTime').value) || 30;
            const expiryDays = parseInt(document.getElementById('licExpiryDays').value) || 365;
            const batchCount = Math.min(Math.max(parseInt(document.getElementById('licBatchCount').value) || 1, 1), 100);
            
            const msgDiv = document.getElementById('createLicenseMsg');
            const progressDiv = document.getElementById('createLicenseProgress');
            const progressBar = document.getElementById('createProgressBar');
            const progressText = document.getElementById('createProgressText');
            const createBtn = document.getElementById('createLicenseBtn');
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            createBtn.disabled = true;
            createBtn.textContent = 'åˆ›å»ºä¸­...';
            
            const body = {
                product_id: productId,
                billing_mode: billingMode,
                expiry_days: expiryDays
            };
            if (billingMode === 'per_use') body.max_uses = maxUses;
            else if (billingMode === 'time_based') body.usage_time = usageTime;
            
            let successKeys = [];
            let failCount = 0;
            
            // æ‰¹é‡åˆ›å»ºæ—¶æ˜¾ç¤ºè¿›åº¦æ¡
            if (batchCount > 1) {
                progressDiv.style.display = 'block';
                progressBar.style.width = '0%';
                progressText.textContent = `0/${batchCount}`;
            }
            
            for (let i = 0; i < batchCount; i++) {
                try {
                    const res = await fetch(`${API_BASE}/admin/api/license/create`, {
                        method: 'POST',
                        headers: getLicenseHeaders(),
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    
                    if (data.error) {
                        failCount++;
                    } else {
                        successKeys.push(data.data?.license_key || '');
                    }
                } catch (e) {
                    failCount++;
                }
                
                // æ›´æ–°è¿›åº¦
                if (batchCount > 1) {
                    const pct = ((i + 1) / batchCount * 100).toFixed(0);
                    progressBar.style.width = pct + '%';
                    progressText.textContent = `${i + 1}/${batchCount}`;
                }
            }
            
            // æ¢å¤æŒ‰é’®
            createBtn.disabled = false;
            createBtn.textContent = 'åˆ›å»º';
            
            if (failCount === batchCount) {
                // å…¨éƒ¨å¤±è´¥
                msgDiv.textContent = `âŒ åˆ›å»ºå¤±è´¥ï¼ˆ${failCount}ä¸ªï¼‰`;
                msgDiv.style.background = 'rgba(255, 71, 87, 0.1)';
                msgDiv.style.color = 'var(--accent-red)';
                msgDiv.style.display = 'block';
            } else if (successKeys.length > 0) {
                // æœ‰æˆåŠŸçš„ â†’ åˆ·æ–°åˆ—è¡¨å¹¶è‡ªåŠ¨å…³é—­å¼¹çª—
                loadLicenses(0);
                loadLicenseStats();
                
                if (batchCount === 1) {
                    // å•ä¸ªåˆ›å»ºï¼šçŸ­æš‚æ˜¾ç¤ºæˆåŠŸåå…³é—­
                    msgDiv.innerHTML = `âœ… åˆ›å»ºæˆåŠŸï¼æ¿€æ´»ç : <strong style="font-family: monospace; user-select: all;">${successKeys[0]}</strong>`;
                    msgDiv.style.background = 'rgba(0, 255, 136, 0.1)';
                    msgDiv.style.color = 'var(--accent-green)';
                    msgDiv.style.display = 'block';
                    setTimeout(() => closeCreateLicenseModal(), 1500);
                } else {
                    // æ‰¹é‡åˆ›å»ºï¼šæ˜¾ç¤ºç»“æœåè‡ªåŠ¨å…³é—­
                    let summary = `âœ… æˆåŠŸåˆ›å»º ${successKeys.length} ä¸ª`;
                    if (failCount > 0) summary += `ï¼Œå¤±è´¥ ${failCount} ä¸ª`;
                    msgDiv.innerHTML = summary + `<br><div style="margin-top: 8px; font-family: monospace; font-size: 11px; max-height: 80px; overflow-y: auto; user-select: all; line-height: 1.8;">${successKeys.join('<br>')}</div>`;
                    msgDiv.style.background = 'rgba(0, 255, 136, 0.1)';
                    msgDiv.style.color = 'var(--accent-green)';
                    msgDiv.style.display = 'block';
                    setTimeout(() => closeCreateLicenseModal(), 3000);
                }
            }
        }
        
        // æ˜¾ç¤ºæ¿€æ´»ç è¯¦æƒ…
        async function showLicenseDetail(licenseKey) {
            try {
                const res = await fetch(`${API_BASE}/admin/api/license/info/${licenseKey}`, {
                    headers: getLicenseHeaders()
                });
                if (!checkTokenValid(res)) return;
                const data = await res.json();
                
                if (data.error) {
                    showAlert('è·å–è¯¦æƒ…å¤±è´¥: ' + data.message, 'error');
                    return;
                }
                
                const license = data.data;
                const billingText = {
                    'per_use': 'æŒ‰æ¬¡æ•°',
                    'time_based': 'æŒ‰æ—¶é—´',
                    'unlimited': 'æ— é™åˆ¶'
                }[license.billing_mode] || license.billing_mode;
                
                const statusText = {
                    'active': 'å·²æ¿€æ´»',
                    'inactive': 'æœªæ¿€æ´»',
                    'expired': 'å·²è¿‡æœŸ',
                    'revoked': 'å·²æ’¤é”€'
                }[license.status] || license.status;
                
                let remainingText = '-';
                if (license.billing_mode === 'per_use') {
                    remainingText = `${license.remaining_uses || 0} / ${license.max_uses || 0} æ¬¡`;
                } else if (license.billing_mode === 'time_based') {
                    const minutes = license.remaining_time || 0;
                    const days = (minutes / 1440).toFixed(1);
                    remainingText = `${days} å¤© (${license.usage_time ? (license.usage_time/1440).toFixed(1) : '-'} å¤©æ€»æ—¶é•¿)`;
                } else {
                    remainingText = 'âˆ æ— é™åˆ¶';
                }
                
                document.getElementById('licenseDetailContent').innerHTML = `
                    <table style="width: 100%;">
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">æ¿€æ´»ç </td>
                            <td style="font-family: monospace; padding: 8px 0;">${license.license_key}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">äº§å“</td>
                            <td style="padding: 8px 0;">${license.product_id}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">è®¡è´¹æ¨¡å¼</td>
                            <td style="padding: 8px 0;">${billingText}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">å‰©ä½™</td>
                            <td style="padding: 8px 0; color: var(--accent-green);">${remainingText}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">çŠ¶æ€</td>
                            <td style="padding: 8px 0;">${statusText}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">ç»‘å®šæœºå™¨</td>
                            <td style="padding: 8px 0; font-family: monospace; font-size: 11px;">${license.machine_id || 'æœªç»‘å®š'}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">åˆ›å»ºæ—¶é—´</td>
                            <td style="padding: 8px 0;">${fmtTime(license.created_at)}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">æ¿€æ´»æ—¶é—´</td>
                            <td style="padding: 8px 0;">${fmtTime(license.activated_at)}</td></tr>
                        <tr><td style="color: var(--text-secondary); padding: 8px 0;">è¿‡æœŸæ—¶é—´</td>
                            <td style="padding: 8px 0;">${fmtTime(license.expiry_date)}</td></tr>
                    </table>
                `;
                
                document.getElementById('licenseDetailModal').style.display = 'flex';
            } catch (e) {
                showAlert('è·å–è¯¦æƒ…å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // å…³é—­æ¿€æ´»ç è¯¦æƒ…å¼¹çª—
        function closeLicenseDetailModal() {
            document.getElementById('licenseDetailModal').style.display = 'none';
        }
        
        // æ’¤é”€æ¿€æ´»ç 
        async function revokeLicense(licenseKey) {
            if (!confirm(`ç¡®å®šè¦æ’¤é”€æ¿€æ´»ç  ${licenseKey} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/license/revoke`, {
                    method: 'POST',
                    headers: getLicenseHeaders(),
                    body: JSON.stringify({
                        license_key: licenseKey,
                        reason: 'ç®¡ç†å‘˜æ’¤é”€'
                    })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    showAlert('æ’¤é”€å¤±è´¥: ' + data.message, 'error');
                } else {
                    showAlert('æ’¤é”€æˆåŠŸ', 'success');
                    loadLicenses(licenseCurrentPage);
                    loadLicenseStats();
                }
            } catch (e) {
                showAlert('æ’¤é”€å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // ===== æµé‡ä»ªè¡¨ç›˜åŠŸèƒ½ =====
        
        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboard() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/dashboard`);
                const data = await res.json();
                
                // æ›´æ–°å®æ—¶æŒ‡æ ‡
                document.getElementById('dashTodayRequests').textContent = formatNumber(data.today_requests || 0);
                document.getElementById('dashSuccessRate').textContent = (data.success_rate || 0).toFixed(1) + '%';
                document.getElementById('dashActiveUsers').textContent = data.active_users || 0;
                document.getElementById('dashPeakRPM').textContent = data.peak_rpm || 0;
                
                // æ›´æ–°24å°æ—¶è¶‹åŠ¿å›¾
                renderHourlyChart(data.hourly_data || []);
                
                // æ›´æ–°æ’è¡Œæ¦œ
                renderTopUsers(data.top_users || []);
                renderTopIps(data.top_ips || []);
                
                // æ›´æ–°æ—¶é—´
                document.getElementById('chartUpdateTime').textContent = 'æ›´æ–°äº ' + new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
            } catch (e) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜å¤±è´¥', e);
            }
        }
        
        // æ¸²æŸ“24å°æ—¶æŸ±çŠ¶å›¾
        function renderHourlyChart(data) {
            const container = document.getElementById('hourlyChart');
            const labelsContainer = document.getElementById('chartLabels');
            
            // ç¡®ä¿æœ‰24ä¸ªæ•°æ®ç‚¹
            const hourlyData = new Array(24).fill(0);
            data.forEach(item => {
                if (item.hour >= 0 && item.hour < 24) {
                    hourlyData[item.hour] = item.count || 0;
                }
            });
            
            const maxValue = Math.max(...hourlyData, 1);
            const currentHour = new Date().getHours();
            
            // ç”ŸæˆæŸ±çŠ¶å›¾
            container.innerHTML = hourlyData.map((value, hour) => {
                const height = (value / maxValue) * 100;
                const isCurrent = hour === currentHour;
                return `<div class="chart-bar" style="height: ${Math.max(height, 3)}%; ${isCurrent ? 'background: linear-gradient(to top, #00ff88, #00d4ff);' : ''}" data-value="${value} æ¬¡" title="${hour}:00 - ${value}æ¬¡"></div>`;
            }).join('');
            
            // ç”Ÿæˆæ—¶é—´æ ‡ç­¾ï¼ˆæ¯3å°æ—¶æ˜¾ç¤ºä¸€æ¬¡ï¼‰
            labelsContainer.innerHTML = hourlyData.map((_, hour) => {
                return `<div class="chart-label">${hour % 3 === 0 ? hour + ':00' : ''}</div>`;
            }).join('');
        }
        
        // æ¸²æŸ“Topç”¨æˆ·
        function renderTopUsers(users) {
            const container = document.getElementById('topUsersList');
            if (!users || users.length === 0) {
                container.innerHTML = '<div class="ranking-empty">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            container.innerHTML = users.slice(0, 10).map((user, index) => `
                <div class="ranking-item">
                    <div class="ranking-rank">${index + 1}</div>
                    <div class="ranking-name">${user.username}</div>
                    <div class="ranking-value">${user.count} æ¬¡</div>
                </div>
            `).join('');
        }
        
        // æ¸²æŸ“Top IP
        function renderTopIps(ips) {
            const container = document.getElementById('topIpsList');
            if (!ips || ips.length === 0) {
                container.innerHTML = '<div class="ranking-empty">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            container.innerHTML = ips.slice(0, 10).map((ip, index) => `
                <div class="ranking-item">
                    <div class="ranking-rank">${index + 1}</div>
                    <div class="ranking-name">${ip.ip}</div>
                    <div class="ranking-value">${ip.count} æ¬¡</div>
                </div>
            `).join('');
        }
        
        // æ·»åŠ æ´»åŠ¨è®°å½•
        function addActivityItem(type, icon, text, time) {
            const container = document.getElementById('activityStream');
            
            // æ¸…é™¤ç©ºçŠ¶æ€
            const empty = container.querySelector('.activity-empty');
            if (empty) empty.remove();
            
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <div class="activity-icon ${type}">${icon}</div>
                <div class="activity-content">
                    <div class="activity-text">${text}</div>
                    <div class="activity-time">${time}</div>
                </div>
            `;
            
            // æ’å…¥åˆ°æœ€å‰é¢
            container.insertBefore(item, container.firstChild);
            
            // æœ€å¤šä¿ç•™15æ¡
            while (container.children.length > 15) {
                container.removeChild(container.lastChild);
            }
        }
        
        // å¯åŠ¨ä»ªè¡¨ç›˜
        function startDashboard() {
            loadDashboard();
            // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
            if (dashboardTimer) clearInterval(dashboardTimer);
            dashboardTimer = setInterval(loadDashboard, 30000);
        }
        
        // åœæ­¢ä»ªè¡¨ç›˜
        function stopDashboard() {
            if (dashboardTimer) {
                clearInterval(dashboardTimer);
                dashboardTimer = null;
            }
        }
        
        // éªŒè¯Tokenæœ‰æ•ˆæ€§
        async function verifyToken() {
            const token = sessionStorage.getItem('admin_token');
            if (!token) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/api/verify_token`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.status === 401) {
                    let msg = 'æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
                    try {
                        const data = await res.json();
                        if (data.message) msg = data.message;
                    } catch(e) {}
                    handleKickedOut(msg);
                } else if (res.ok) {
                    // åˆ·æ–°æƒé™ä¿¡æ¯ï¼ˆç®¡ç†å‘˜å¯èƒ½ä¿®æ”¹äº†å­ç®¡ç†å‘˜æƒé™ï¼‰
                    try {
                        const data = await res.json();
                        if (data.valid && data.permissions !== undefined) {
                            sessionStorage.setItem('admin_permissions', JSON.stringify(data.permissions || {}));
                            applyPermissions();
                        }
                    } catch(e) {}
                }
            } catch (e) {
                // ç½‘ç»œé”™è¯¯ä¸å¼¹çª—ï¼Œé¿å…ç¦»çº¿æ—¶è¯¯æŠ¥
                console.error('éªŒè¯tokenå¤±è´¥', e);
            }
        }
        
        // ===== è´Ÿè½½å‡è¡¡ç®¡ç† =====
        let lbRefreshTimer = null;
        let lbData = null;

        async function loadLbStatus() {
            try {
                const [dispRes, sbRes] = await Promise.all([
                    fetch(`${API_BASE}/api/dispatcher`),
                    fetch(`${API_BASE}/api/dispatcher/singbox_status`)
                ]);
                lbData = await dispRes.json();
                renderLbStatus(lbData);
                const sbData = await sbRes.json();
                renderSingboxStatus(sbData);
            } catch (e) {
                console.error('åŠ è½½è´Ÿè½½å‡è¡¡çŠ¶æ€å¤±è´¥', e);
            }
        }

        function renderSingboxStatus(sb) {
            const stateEl = document.getElementById('lbSbState');
            const nodesEl = document.getElementById('lbSbNodes');
            const configEl = document.getElementById('lbSbConfig');
            if (!sb) return;
            if (sb.active) {
                stateEl.innerHTML = `<span style="color:#00ff88;">â— è¿è¡Œä¸­</span> <span style="color:var(--text-secondary);">(PID: ${sb.pid})</span> <button onclick="lbReloadSingbox()" style="margin-left:8px;background:rgba(102,126,234,0.2);color:#667eea;border:1px solid rgba(102,126,234,0.3);border-radius:4px;padding:3px 10px;cursor:pointer;font-size:11px;font-weight:bold;">é‡å¯</button>`;
            } else if (sb.installed) {
                stateEl.innerHTML = `<span style="color:#ff4757;">â— å·²åœæ­¢</span> <button onclick="lbStartSingbox()" style="margin-left:8px;background:#00ff88;color:#000;border:none;border-radius:4px;padding:3px 10px;cursor:pointer;font-size:11px;font-weight:bold;">å¯åŠ¨</button>`;
            } else {
                stateEl.innerHTML = `<span style="color:#ffa502;">â— æœªå®‰è£…</span>`;
            }
            nodesEl.textContent = sb.nodes_count ? `èŠ‚ç‚¹: ${sb.nodes_count}` : '';
            configEl.textContent = sb.config_exists ? sb.config_path : 'é…ç½®æ–‡ä»¶ä¸å­˜åœ¨';
        }

        function startLbRefresh() {
            stopLbRefresh();
            lbRefreshTimer = setInterval(loadLbStatus, 3000);
        }

        function stopLbRefresh() {
            if (lbRefreshTimer) { clearInterval(lbRefreshTimer); lbRefreshTimer = null; }
        }

        function renderLbStatus(data) {
            if (!data || data.error) return;
            document.getElementById('lbTotalExits').textContent = data.total_exits;
            document.getElementById('lbHealthyExits').textContent = data.healthy_exits;
            document.getElementById('lbTotalActive').textContent = data.total_active;
            document.getElementById('lbLoginLimit').textContent = data.max_login_per_min;
            document.getElementById('lbSummary').textContent =
                `${data.healthy_exits}/${data.total_exits} å¥åº· | ${data.total_active} æ´»è·ƒè¿æ¥`;

            const container = document.getElementById('lbExitCards');
            if (!data.exits || data.exits.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:40px;">æš‚æ— å‡ºå£é…ç½®</div>';
                return;
            }

            container.innerHTML = data.exits.map((ex, i) => {
                const isDirect = ex.type === 'direct';
                const healthColor = ex.healthy ? '#00ff88' : '#ff4757';
                const healthText = ex.healthy ? 'åœ¨çº¿' : 'ç¦»çº¿';
                const healthBg = ex.healthy ? 'rgba(0,255,136,0.1)' : 'rgba(255,71,87,0.1)';
                const borderColor = ex.healthy ? 'rgba(0,255,136,0.3)' : 'rgba(255,71,87,0.3)';

                // ç™»å½•å†·å´è¿›åº¦æ¡
                const cd = ex.login_cooldown || {};
                const cdUsed = cd.used || 0;
                const cdMax = cd.max || 10;
                const cdPct = Math.min(100, (cdUsed / cdMax) * 100);
                const cdColor = cdPct >= 100 ? '#ff4757' : cdPct >= 75 ? '#ffa502' : '#00ff88';
                const cdRemaining = cd.remaining || 0;
                const cdText = cdPct >= 100
                    ? `å·²æ»¡ (${cd.next_available_in}såå¼€å§‹é‡Šæ”¾)`
                    : cdUsed > 0
                        ? `${cdUsed}/${cdMax} (${cdRemaining}ä¸ªå¯ç”¨)`
                        : `${cdUsed}/${cdMax}`;

                // å†»ç»“+å‘Šè­¦æ ‡è®°
                let warnHtml = '';
                if (ex.frozen) {
                    warnHtml += `<div style="margin-top:6px;font-size:11px;color:#ff4757;">ğŸ§Š 403å†»ç»“ä¸­ (${Math.round(ex.frozen_remaining)}såè§£å†»)</div>`;
                }
                if (ex.warn_403 > 0 || ex.warn_429 > 0) {
                    const parts = [];
                    if (ex.warn_403 > 0) parts.push(`<span style="color:#ff4757;">403Ã—${ex.warn_403}</span>`);
                    if (ex.warn_429 > 0) parts.push(`<span style="color:#ffa502;">429Ã—${ex.warn_429}</span>`);
                    warnHtml += `<div style="margin-top:6px;font-size:11px;">âš ï¸ ${parts.join(' ')}</div>`;
                }

                const serverLabel = isDirect ? 'ç›´è¿æœåŠ¡å™¨' : `è´Ÿè½½å‡è¡¡æœåŠ¡å™¨${i}`;

                return `<div style="background:var(--bg-card);border-radius:10px;padding:14px;border:1px solid ${borderColor};position:relative;overflow:hidden;">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                        <div>
                            <div style="font-size:15px;font-weight:bold;color:var(--text-primary);">${serverLabel}</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;">${ex.name}${ex.proxy ? ' | ' + ex.proxy : ''}</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${healthColor};"></span>
                            <span style="font-size:12px;color:${healthColor};font-weight:bold;">${healthText}</span>
                            ${!isDirect ? `<button onclick="lbRemoveExit(${ex.index},'${ex.name}')" style="margin-left:4px;background:none;border:1px solid rgba(255,71,87,0.3);border-radius:4px;color:#ff4757;cursor:pointer;font-size:11px;padding:2px 6px;">åˆ é™¤</button>` : ''}
                        </div>
                    </div>
                    <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:nowrap;">
                        <div style="background:${healthBg};border-radius:6px;padding:6px 8px;flex:3;min-width:0;overflow:hidden;">
                            <div style="font-size:10px;color:var(--text-secondary);">å‡ºå£IP</div>
                            <div style="font-size:12px;font-weight:bold;color:${healthColor};font-family:monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${ex.exit_ip || ''}">${ex.exit_ip || 'æ£€æµ‹ä¸­...'}</div>
                        </div>
                        <div style="background:rgba(102,126,234,0.1);border-radius:6px;padding:6px 8px;flex:1;min-width:0;text-align:center;">
                            <div style="font-size:10px;color:var(--text-secondary);">å¹¶å‘</div>
                            <div style="font-size:15px;font-weight:bold;color:#667eea;">${ex.active}</div>
                        </div>
                        <div style="background:rgba(0,212,255,0.1);border-radius:6px;padding:6px 8px;flex:1;min-width:0;text-align:center;">
                            <div style="font-size:10px;color:var(--text-secondary);">è¯·æ±‚</div>
                            <div style="font-size:12px;font-weight:bold;color:var(--accent);">${ex.total_requests}</div>
                        </div>
                        <div style="background:rgba(255,165,0,0.08);border-radius:6px;padding:6px 8px;flex:1.2;min-width:0;text-align:center;cursor:pointer;" onclick="lbShowRateLimit(${i},'${ex.name}',${ex.rate_limit})" title="ç‚¹å‡»è°ƒæ•´é™é€Ÿ">
                            <div style="font-size:10px;color:var(--text-secondary);">é€Ÿç‡${ex.rate_limit > 0 ? ' âš¡' : ''}</div>
                            <div style="font-size:12px;font-weight:bold;color:${ex.rate_limit > 0 && ex.rpm >= ex.rate_limit * 0.8 ? '#ffa502' : 'var(--accent)'};">${ex.rpm}<span style="font-size:9px;color:var(--text-secondary);">/${ex.rate_limit || 'âˆ'}</span></div>
                        </div>
                    </div>
                    <!-- ç™»å½•å†·å´è¿›åº¦ -->
                    <div style="margin-top:4px;">
                        <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;">
                            <span style="color:var(--text-secondary);">ç™»å½•å†·å´ (1åˆ†é’Ÿçª—å£)</span>
                            <span style="color:${cdColor};font-weight:bold;">${cdText}</span>
                        </div>
                        <div style="background:var(--bg-primary);border-radius:3px;height:6px;overflow:hidden;">
                            <div style="height:100%;background:${cdColor};width:${cdPct}%;transition:width 0.5s;border-radius:3px;"></div>
                        </div>
                    </div>
                    ${warnHtml}
                </div>`;
            }).join('');
        }

        async function lbDetectIPs() {
            try {
                showToast('æ­£åœ¨æ£€æµ‹å‡ºå£IP...', 'info');
                const res = await fetch(`${API_BASE}/api/dispatcher/detect_ips`, {method: 'POST'});
                const data = await res.json();
                if (data.success) {
                    showToast('IPæ£€æµ‹å®Œæˆ');
                    loadLbStatus();
                } else {
                    showToast(data.message || 'æ£€æµ‹å¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('æ£€æµ‹è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function lbRemoveExit(index, name) {
            if (!confirm(`ç¡®å®šåˆ é™¤å‡ºå£ [${name}] (#${index})ï¼Ÿ`)) return;
            try {
                const res = await fetch(`${API_BASE}/api/dispatcher/remove`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({index})
                });
                const data = await res.json();
                if (data.success) { showToast(data.message); loadLbStatus(); }
                else { showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error'); }
            } catch (e) { showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error'); }
        }

        function showLbAddModal() {
            const content = `
                <div style="margin-bottom:12px;">
                    <label style="display:block;margin-bottom:4px;color:var(--text-secondary);font-size:13px;">å‡ºå£åç§°</label>
                    <input type="text" id="lbAddName" placeholder="å¦‚: è´Ÿè½½å‡è¡¡æ¬§æ´²æœåŠ¡å™¨1" style="width:100%;padding:8px 10px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                </div>
                <div style="margin-bottom:12px;">
                    <label style="display:block;margin-bottom:4px;color:var(--text-secondary);font-size:13px;">SOCKS5ç«¯å£ (æœ¬åœ°sing-box)</label>
                    <input type="number" id="lbAddPort" placeholder="å¦‚: 10001" min="1024" max="65535" style="width:100%;padding:8px 10px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                </div>
            `;
            showModal('â• æ·»åŠ SOCKS5å‡ºå£', content, async () => {
                const name = document.getElementById('lbAddName').value.trim();
                const port = parseInt(document.getElementById('lbAddPort').value);
                if (!name || !port) { showToast('è¯·å¡«å†™åç§°å’Œç«¯å£', 'error'); return; }
                try {
                    const res = await fetch(`${API_BASE}/api/dispatcher/add`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name, port})
                    });
                    const data = await res.json();
                    if (data.success) { closeModal(); showToast(data.message); loadLbStatus(); }
                    else { showToast(data.message || 'æ·»åŠ å¤±è´¥', 'error'); }
                } catch (e) { showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error'); }
            }, 'ç¡®è®¤æ·»åŠ ');
        }

        function showLbSubModal() {
            // è‡ªå»ºå¤§å¼¹çª—ï¼Œä¸¤æ­¥äº¤äº’: è§£æ â†’ åº”ç”¨
            const old = document.getElementById('lbSubModal');
            if (old) old.remove();

            const modal = document.createElement('div');
            modal.id = 'lbSubModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
            modal.innerHTML = `
                <div style="background:var(--bg-card);border-radius:12px;max-width:680px;width:95%;max-height:85vh;border:1px solid var(--border);display:flex;flex-direction:column;">
                    <h3 style="padding:18px 22px 14px;margin:0;color:var(--accent);border-bottom:1px solid var(--border);flex-shrink:0;">ğŸ“¡ å¯¼å…¥VPNè®¢é˜…</h3>
                    <div style="padding:14px 22px;overflow-y:auto;flex:1;" id="lbSubBody">
                        <div style="margin-bottom:10px;">
                            <label style="display:block;margin-bottom:4px;color:var(--text-secondary);font-size:13px;">è®¢é˜…é“¾æ¥ (è‡ªåŠ¨è·å–å¹¶è§£æ)</label>
                            <input type="text" id="lbSubUrl" placeholder="https://example.com/sub?token=xxx" style="width:100%;padding:8px 10px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);">
                        </div>
                        <div style="text-align:center;color:var(--text-secondary);font-size:12px;margin:6px 0;">â€”â€” æˆ– â€”â€”</div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block;margin-bottom:4px;color:var(--text-secondary);font-size:13px;">è®¢é˜…å†…å®¹ (ç²˜è´´Clash YAML / Base64 / SSé“¾æ¥)</label>
                            <textarea id="lbSubText" rows="4" placeholder="ç²˜è´´è®¢é˜…å†…å®¹..." style="width:100%;padding:8px 10px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:monospace;font-size:12px;resize:vertical;"></textarea>
                        </div>
                        <div id="lbSubResult" style="display:none;"></div>
                    </div>
                    <div style="display:flex;gap:10px;padding:14px 22px 18px;border-top:1px solid var(--border);flex-shrink:0;align-items:center;">
                        <button onclick="closeLbSubModal()" class="btn" style="padding:10px 20px;background:var(--bg-secondary);color:var(--text-secondary);border-radius:8px;font-size:14px;">å–æ¶ˆ</button>
                        <button id="lbSubActionBtn" onclick="lbSubAction()" class="btn btn-primary" style="flex:1;padding:10px 0;border-radius:8px;font-size:15px;font-weight:bold;">ğŸ” è§£æè®¢é˜…</button>
                        <span id="lbSubAddMsg" style="font-size:12px;color:var(--text-secondary);"></span>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window._lbSubStep = 'parse'; // å½“å‰æ­¥éª¤
        }

        function closeLbSubModal() {
            const m = document.getElementById('lbSubModal');
            if (m) m.remove();
        }

        async function lbSubAction() {
            if (window._lbSubStep === 'parse') {
                // ç¬¬ä¸€æ­¥: è§£æ
                const url = document.getElementById('lbSubUrl').value.trim();
                const text = document.getElementById('lbSubText').value.trim();
                if (!url && !text) { showToast('è¯·è¾“å…¥è®¢é˜…é“¾æ¥æˆ–å†…å®¹', 'error'); return; }
                const resultEl = document.getElementById('lbSubResult');
                const btn = document.getElementById('lbSubActionBtn');
                resultEl.style.display = 'block';
                resultEl.innerHTML = '<div style="color:var(--accent);padding:10px;text-align:center;">â³ æ­£åœ¨è§£æè®¢é˜…...</div>';
                btn.disabled = true;
                btn.textContent = 'è§£æä¸­...';
                try {
                    const res = await fetch(`${API_BASE}/api/dispatcher/parse_sub`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({url, text})
                    });
                    const data = await res.json();
                    if (data.error) {
                        resultEl.innerHTML = `<div style="color:#ff4757;padding:10px;">âŒ ${data.error}</div>`;
                        btn.disabled = false;
                        btn.textContent = 'ğŸ” é‡æ–°è§£æ';
                        return;
                    }
                    renderSubResult(data, resultEl);
                    // åˆ‡æ¢åˆ°ç¬¬äºŒæ­¥
                    window._lbSubStep = 'apply';
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ ä¸€é”®åº”ç”¨é€‰ä¸­èŠ‚ç‚¹';
                    btn.style.background = 'linear-gradient(135deg, #00c9b7, #7ed56f)';
                } catch (e) {
                    resultEl.innerHTML = `<div style="color:#ff4757;padding:10px;">è¯·æ±‚å¤±è´¥: ${e.message}</div>`;
                    btn.disabled = false;
                    btn.textContent = 'ğŸ” é‡æ–°è§£æ';
                }
            } else {
                // ç¬¬äºŒæ­¥: åº”ç”¨
                await lbBatchAddFromSub();
            }
        }

        function renderSubResult(data, el) {
            const regionHtml = Object.entries(data.regions || {}).map(([code, info]) =>
                `<span style="background:var(--bg-secondary);padding:2px 8px;border-radius:10px;font-size:11px;">${info.label} Ã—${info.count}</span>`
            ).join(' ');

            const serverEntries = Object.entries(data.servers || {});
            const nodesHtml = serverEntries.map(([server, indices], si) => {
                const firstNode = data.nodes[indices[0]];
                return `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;cursor:pointer;">
                    <input type="checkbox" class="lb-sub-node" data-server="${server}" data-name="${firstNode.region_label}æœåŠ¡å™¨${si+1}" data-type="${firstNode.type}" checked style="accent-color:var(--accent);">
                    <span style="flex:1;">
                        <strong>${firstNode.region_label}æœåŠ¡å™¨${si+1}</strong>
                        <span style="color:var(--text-secondary);margin-left:6px;">${firstNode.type.toUpperCase()} | ${server}:${firstNode.port}</span>
                        ${indices.length > 1 ? `<span style="color:var(--accent);margin-left:4px;">(${indices.length}èŠ‚ç‚¹)</span>` : ''}
                    </span>
                </label>`;
            }).join('');

            el.innerHTML = `
                <div style="background:var(--bg-secondary);border-radius:8px;padding:10px;margin-bottom:8px;">
                    <div style="font-size:13px;margin-bottom:6px;">âœ… æ ¼å¼: <strong style="color:var(--accent);">${data.format}</strong> | 
                        èŠ‚ç‚¹: <strong>${data.total_nodes}</strong> | 
                        å”¯ä¸€æœåŠ¡å™¨: <strong style="color:var(--accent-green);">${data.unique_servers}</strong></div>
                    <div style="display:flex;gap:4px;flex-wrap:wrap;">${regionHtml}</div>
                </div>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;">å‹¾é€‰è¦æ·»åŠ çš„æœåŠ¡å™¨ï¼š</div>
                <div style="max-height:220px;overflow-y:auto;margin-bottom:8px;border:1px solid var(--border);border-radius:6px;padding:4px 8px;">
                    ${nodesHtml}
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <label style="font-size:12px;color:var(--text-secondary);">èµ·å§‹ç«¯å£:</label>
                    <input type="number" id="lbSubBasePort" value="10001" min="1024" max="65000" style="width:80px;padding:4px 8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;">
                    <span style="font-size:11px;color:var(--text-secondary);">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸€é”®åº”ç”¨</span>
                </div>
            `;
        }

        async function lbBatchAddFromSub() {
            const checks = document.querySelectorAll('.lb-sub-node:checked');
            if (checks.length === 0) { showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹', 'error'); return; }
            const basePort = parseInt(document.getElementById('lbSubBasePort').value) || 10001;
            const msgEl = document.getElementById('lbSubAddMsg');
            msgEl.textContent = 'æ­£åœ¨åº”ç”¨: ç”Ÿæˆé…ç½® â†’ é‡è½½sing-box â†’ æ³¨å†Œå‡ºå£...';

            // æ”¶é›†é€‰ä¸­çš„æœåŠ¡å™¨ä¿¡æ¯
            const selected_servers = [];
            checks.forEach(chk => {
                selected_servers.push({ server: chk.dataset.server, name: chk.dataset.name });
            });

            // è·å–è®¢é˜…æº (ä»å¼¹çª—çš„è¾“å…¥æ¡†)
            const url = document.getElementById('lbSubUrl')?.value?.trim() || '';
            const text = document.getElementById('lbSubText')?.value?.trim() || '';

            try {
                const res = await fetch(`${API_BASE}/api/dispatcher/apply_sub`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url, text, selected_servers, base_port: basePort })
                });
                const data = await res.json();
                if (data.success) {
                    const sbIcon = data.singbox_reload ? 'âœ…' : 'âš ï¸';
                    msgEl.innerHTML = `${sbIcon} å®Œæˆ! ${data.nodes_count}ä¸ªèŠ‚ç‚¹å·²åº”ç”¨, sing-box: ${data.message}`;
                    showToast(`çƒ­é‡è½½æˆåŠŸ: ${data.nodes_count}ä¸ªå‡ºå£å·²ç”Ÿæ•ˆ`);
                    closeLbSubModal();
                } else {
                    msgEl.innerHTML = `<span style="color:#ffa502;">âš ï¸ ${data.message}</span><br>èŠ‚ç‚¹å·²æ³¨å†Œåˆ°dispatcher(${data.nodes_count || 0}ä¸ª), sing-boxéœ€æ‰‹åŠ¨é‡è½½`;
                    showToast(data.message || 'éƒ¨åˆ†å¤±è´¥', 'error');
                }
                loadLbStatus();
            } catch (e) {
                msgEl.textContent = `è¯·æ±‚å¤±è´¥: ${e.message}`;
                showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function lbReloadSingbox() {
            try {
                showToast('æ­£åœ¨çƒ­é‡è½½ sing-box...', 'info');
                const res = await fetch(`${API_BASE}/api/dispatcher/reload_singbox`, {method: 'POST'});
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                loadLbStatus();
            } catch (e) {
                showToast('çƒ­é‡è½½å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function lbStartSingbox() {
            try {
                showToast('æ­£åœ¨å¯åŠ¨ sing-box...', 'info');
                const res = await fetch(`${API_BASE}/api/dispatcher/start_singbox`, {method: 'POST'});
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                loadLbStatus();
            } catch (e) {
                showToast('å¯åŠ¨å¤±è´¥: ' + e.message, 'error');
            }
        }

        function lbShowLoginLimitModal() {
            const current = document.getElementById('lbLoginLimit').textContent || '10';
            const content = `
                <div style="margin-bottom:12px;">
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">
                        æ¯ä¸ªå‡ºå£æ¯åˆ†é’Ÿæœ€å¤šå…è®¸çš„ç™»å½•æ¬¡æ•°ï¼Œè¶…å‡ºåè‡ªåŠ¨è½®æ¢åˆ°å…¶ä»–å‡ºå£ã€‚
                    </div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="font-size:13px;color:var(--text-primary);">ç™»å½•é™é¢ (æ¬¡/åˆ†é’Ÿ/å‡ºå£):</label>
                        <input id="loginLimitInput" type="number" min="1" step="1" value="${current}"
                            style="background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text-primary);font-size:14px;width:100%;">
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;">
                        <button onclick="lbSetLoginLimit(5)" style="flex:1;padding:6px;border-radius:6px;border:1px solid rgba(255,165,0,0.3);background:rgba(255,165,0,0.1);color:#ffa502;cursor:pointer;font-size:12px;">5/min</button>
                        <button onclick="lbSetLoginLimit(8)" style="flex:1;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);cursor:pointer;font-size:12px;">8/min</button>
                        <button onclick="lbSetLoginLimit(10)" style="flex:1;padding:6px;border-radius:6px;border:1px solid rgba(0,212,255,0.3);background:rgba(0,212,255,0.1);color:var(--accent);cursor:pointer;font-size:12px;">10/min</button>
                        <button onclick="lbSetLoginLimit(15)" style="flex:1;padding:6px;border-radius:6px;border:1px solid rgba(0,255,136,0.3);background:rgba(0,255,136,0.1);color:#00ff88;cursor:pointer;font-size:12px;">15/min</button>
                    </div>
                </div>
            `;
            showModal('âœï¸ è°ƒæ•´ç™»å½•é™é¢', content, async () => {
                const val = parseInt(document.getElementById('loginLimitInput')?.value || '10');
                await lbSetLoginLimit(val);
            }, 'åº”ç”¨');
        }

        async function lbSetLoginLimit(value) {
            try {
                const res = await fetch(`${API_BASE}/api/dispatcher/max_login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ value })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                closeModal();
                loadLbStatus();
            } catch (e) {
                showToast('è®¾ç½®å¤±è´¥: ' + e.message, 'error');
            }
        }

        function lbShowRateLimit(index, name, currentLimit) {
            const content = `
                <div style="margin-bottom:12px;">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">å‡ºå£ #${index} | ${name}</div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">
                        å½“å‰é™é€Ÿ: <b style="color:var(--accent);">${currentLimit || 'ä¸é™é€Ÿ'}</b> ${currentLimit ? 'req/min' : ''}
                    </div>
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <label style="font-size:13px;color:var(--text-primary);">è®¾ç½®é€Ÿç‡ä¸Šé™ (req/min):</label>
                        <input id="rateLimitInput" type="number" min="0" step="5" value="${currentLimit || 0}" placeholder="0 = ä¸é™é€Ÿ"
                            style="background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text-primary);font-size:14px;width:100%;">
                        <div style="font-size:11px;color:var(--text-secondary);">
                            ğŸ’¡ è®¾ä¸º 0 è¡¨ç¤ºä¸é™é€Ÿ | æ”¶åˆ°403ä¼šè‡ªåŠ¨é™é€Ÿ10%<br>
                            å»ºè®®å€¼: 30~100/min (è§†ä¸Šæ¸¸æ‰¿å—èƒ½åŠ›)
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;">
                        <button onclick="lbSetRate(${index},0)" style="flex:1;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);cursor:pointer;font-size:12px;">ğŸ”“ å–æ¶ˆé™é€Ÿ</button>
                        <button onclick="lbSetRate(${index},30)" style="flex:1;padding:6px;border-radius:6px;border:1px solid rgba(255,165,0,0.3);background:rgba(255,165,0,0.1);color:#ffa502;cursor:pointer;font-size:12px;">ğŸ¢ 30/min</button>
                        <button onclick="lbSetRate(${index},60)" style="flex:1;padding:6px;border-radius:6px;border:1px solid rgba(0,212,255,0.3);background:rgba(0,212,255,0.1);color:var(--accent);cursor:pointer;font-size:12px;">âš¡ 60/min</button>
                    </div>
                </div>
            `;
            showModal(`âš¡ é€Ÿç‡æ§åˆ¶ - ${name}`, content, async () => {
                const val = parseInt(document.getElementById('rateLimitInput')?.value || '0');
                await lbSetRate(index, val);
            }, 'åº”ç”¨è®¾ç½®');
        }

        async function lbSetRate(index, limit) {
            try {
                const res = await fetch(`${API_BASE}/api/dispatcher/rate_limit`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ index, limit })
                });
                const data = await res.json();
                showToast(data.message, data.success ? 'success' : 'error');
                closeModal();
                loadLbStatus();
            } catch (e) {
                showToast('è®¾ç½®å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function lbShowErrorLogs(index, name) {
            try {
                const res = await fetch(`${API_BASE}/api/dispatcher/logs/${index}`);
                const data = await res.json();
                const logs = data.logs || [];
                let logsHtml;
                if (logs.length === 0) {
                    logsHtml = '<div style="color:var(--text-secondary);text-align:center;padding:20px;">æš‚æ— é”™è¯¯æ—¥å¿—</div>';
                } else {
                    logsHtml = logs.map(l =>
                        `<div style="display:flex;gap:8px;padding:4px 0;border-bottom:1px solid var(--border);font-size:12px;font-family:monospace;">
                            <span style="color:var(--text-secondary);white-space:nowrap;">${l.time}</span>
                            <span style="color:#ff4757;word-break:break-all;">${l.msg}</span>
                        </div>`
                    ).reverse().join('');
                }
                const content = `
                    <div style="font-size:13px;margin-bottom:8px;color:var(--text-secondary);">å‡ºå£ #${index} | ${name} | å…± ${logs.length} æ¡é”™è¯¯</div>
                    <div style="max-height:350px;overflow-y:auto;">${logsHtml}</div>
                `;
                showModal(`ğŸ“‹ é”™è¯¯æ—¥å¿— - ${name}`, content, () => closeModal(), 'å…³é—­');
            } catch (e) {
                showToast('è·å–æ—¥å¿—å¤±è´¥: ' + e.message, 'error');
            }
        }

        // åˆå§‹åŒ–åº”ç”¨ï¼ˆç™»å½•æˆåŠŸåè°ƒç”¨ï¼‰
        function initApp() {
            initWebSocket();
            refreshStats();
            // å¯åŠ¨ä»ªè¡¨ç›˜
            startDashboard();
            // å®šæ—¶åˆ·æ–°ç»Ÿè®¡
            setInterval(refreshStats, 10000);
            // å®šæœŸéªŒè¯tokenï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦è¢«è¸¢å‡ºï¼‰
            setInterval(verifyToken, 30000);
        }
        
        // é€šç”¨è®¤è¯header
        function getHeaders() {
            return { 'Authorization': `Bearer ${sessionStorage.getItem('admin_token') || ''}` };
        }

        // ===== ç™½åå•ç®¡ç† =====
        let wlPage = 0;
        let wlCreditConfigs = [];

        async function loadWhitelist(page = 0) {
            wlPage = page;
            const search = document.getElementById('wlSearch').value.trim();
            const params = new URLSearchParams({limit: 50, offset: page * 50});
            if (search) params.append('search', search);
            try {
                const [res, balRes, expRes, cfgRes] = await Promise.all([
                    fetch(`${API_BASE}/admin/api/whitelist?${params}`, {headers: getHeaders()}),
                    fetch(`${API_BASE}/admin/api/credits/balance`, {headers: getHeaders()}),
                    fetch(`${API_BASE}/admin/api/whitelist/expiring?days=7`, {headers: getHeaders()}),
                    fetch(`${API_BASE}/admin/api/credits/config`)
                ]);
                const data = await res.json();
                const balData = await balRes.json();
                const expData = await expRes.json();
                wlCreditConfigs = await cfgRes.json();

                // ä½™é¢æ˜¾ç¤º
                const balEl = document.getElementById('wlBalanceInfo');
                if (balData.unlimited) {
                    balEl.textContent = 'ğŸ’° ç§¯åˆ†: æ— é™';
                } else {
                    balEl.textContent = `ğŸ’° ç§¯åˆ†: ${balData.balance}`;
                }

                // åˆ°æœŸæé†’
                const alertEl = document.getElementById('wlExpiringAlert');
                if (Array.isArray(expData) && expData.length > 0) {
                    alertEl.style.display = 'block';
                    document.getElementById('wlExpiringList').textContent = expData.map(a =>
                        `${a.username}(${new Date(a.expire_time).toLocaleDateString()})`).join(', ');
                } else {
                    alertEl.style.display = 'none';
                }

                // è¡¨æ ¼
                const tbody = document.getElementById('wlTableBody');
                const rows = data.rows || [];
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:var(--text-secondary);">æš‚æ— æ•°æ®</td></tr>';
                } else {
                    tbody.innerHTML = rows.map(a => {
                        const statusColors = {active: '#00ff88', expired: '#ff5252', deleted: '#888'};
                        const statusNames = {active: 'æœ‰æ•ˆ', expired: 'å·²è¿‡æœŸ', deleted: 'å·²åˆ é™¤'};
                        const expDate = fmtTime(a.expire_time);
                        const isExpired = a.status === 'expired' || (a.expire_time && new Date(a.expire_time) < new Date());
                        const planCfg = wlCreditConfigs.find(c => c.plan_type === a.plan_type);
                        const planDisplay = planCfg ? planCfg.plan_name : (a.plan_type || '-');
                        return `<tr>
                            <td style="font-weight:bold;">${a.username}</td>
                            <td style="color:var(--text-secondary);">${a.nickname || '-'}</td>
                            <td>${planDisplay}</td>
                            <td style="color:${isExpired ? '#ff5252' : '#00ff88'};">${expDate}</td>
                            <td><span style="color:${statusColors[a.status] || '#888'};">${statusNames[a.status] || a.status}</span></td>
                            <td>${a.status !== 'deleted' ? `<button onclick="togglePersistLogin('${a.username}', ${!a.persistent_login})" style="padding:4px 14px; font-size:12px; border:${a.persistent_login ? 'none' : '1px solid var(--border)'}; border-radius:12px; cursor:pointer; transition:all 0.2s; background:${a.persistent_login ? 'linear-gradient(135deg,#00c9b7,#7ed56f)' : 'var(--bg-primary)'}; color:${a.persistent_login ? '#0a1a2e' : '#ff5252'}; font-weight:bold;">${a.persistent_login ? 'âœ… å·²å¼€å¯' : 'âŒ å…³é—­'}</button>` : '-'}</td>
                            <td style="color:var(--text-secondary);">${a.added_by === 'super_admin' ? 'ç³»ç»Ÿæ€»ç®¡ç†' : (a.added_by || '-')}</td>
                            <td style="color:var(--text-secondary); max-width:100px; overflow:hidden; text-overflow:ellipsis;">${a.remark || ''}</td>
                            <td>
                                ${a.status !== 'deleted' ? `<button class="btn" onclick="renewWhitelist('${a.username}')" style="padding:3px 8px; font-size:11px; margin-right:4px;">ç»­æœŸ</button>
                                <button class="btn btn-danger" onclick="deleteWhitelist('${a.username}')" style="padding:3px 8px; font-size:11px;">åˆ é™¤</button>` : '-'}
                            </td>
                        </tr>`;
                    }).join('');
                }

                // åˆ†é¡µ
                const total = data.total || 0;
                const pages = Math.ceil(total / 50);
                const pgEl = document.getElementById('wlPagination');
                if (pages > 1) {
                    pgEl.innerHTML = Array.from({length: Math.min(pages, 10)}, (_, i) =>
                        `<button class="btn" onclick="loadWhitelist(${i})" style="padding:4px 10px; font-size:12px; ${i === page ? 'background:var(--accent); color:white;' : ''}">${i+1}</button>`
                    ).join('') + `<span style="color:var(--text-secondary); font-size:12px; align-self:center;">å…±${total}æ¡</span>`;
                } else {
                    pgEl.innerHTML = total > 0 ? `<span style="color:var(--text-secondary); font-size:12px;">å…±${total}æ¡</span>` : '';
                }
            } catch (e) {
                console.error('åŠ è½½ç™½åå•å¤±è´¥', e);
            }
        }

        function showAddWhitelistModal() {
            const planOptions = wlCreditConfigs.map(c =>
                `<option value="${c.plan_type}">${c.plan_name} (${c.credits_cost}ç§¯åˆ†/${c.duration_days}å¤©)</option>`).join('');
            const content = `
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; color:var(--text-secondary); font-size:13px;">è´¦å·</label>
                    <input type="text" id="wlAddUsername" placeholder="è¾“å…¥è´¦å·" style="width:100%; padding:8px 10px; background:var(--bg-primary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary);">
                </div>
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; color:var(--text-secondary); font-size:13px;">å¥—é¤</label>
                    <select id="wlAddPlan" style="width:100%; padding:8px 10px; background:var(--bg-primary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary);">
                        ${planOptions}
                    </select>
                </div>
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; color:var(--text-secondary); font-size:13px;">å§“åï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="wlAddNickname" placeholder="å¯é€‰" style="width:100%; padding:8px 10px; background:var(--bg-primary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary);">
                </div>
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; color:var(--text-secondary); font-size:13px;">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="wlAddRemark" placeholder="å¯é€‰" style="width:100%; padding:8px 10px; background:var(--bg-primary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary);">
                </div>
            `;
            showModal('â• æˆæƒæ–°è´¦å·', content, async () => {
                const username = document.getElementById('wlAddUsername').value.trim();
                const password = '';
                const plan_type = document.getElementById('wlAddPlan').value;
                const nickname = document.getElementById('wlAddNickname').value.trim();
                const remark = document.getElementById('wlAddRemark').value;
                if (!username) { showToast('è¯·è¾“å…¥è´¦å·', 'error'); return; }
                try {
                    const res = await fetch(`${API_BASE}/admin/api/whitelist/add`, {
                        method: 'POST', headers: {...getHeaders(), 'Content-Type': 'application/json'},
                        body: JSON.stringify({username, password, plan_type, nickname, remark})
                    });
                    const data = await res.json();
                    if (data.success) { closeModal(); showToast(data.message || 'æˆæƒæˆåŠŸ'); loadWhitelist(wlPage); }
                    else { showToast(data.message || 'å¤±è´¥', 'error'); }
                } catch (e) { showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error'); }
            }, 'ç¡®è®¤æˆæƒ');
        }

        async function renewWhitelist(username) {
            const planOptions = wlCreditConfigs.map(c =>
                `<option value="${c.plan_type}">${c.plan_name} (${c.credits_cost}ç§¯åˆ†/${c.duration_days}å¤©)</option>`).join('');
            const content = `
                <p style="margin-bottom:12px; color:var(--text-secondary);">ç»­æœŸè´¦å·: <strong style="color:var(--accent);">${username}</strong></p>
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; color:var(--text-secondary); font-size:13px;">ç»­æœŸå¥—é¤</label>
                    <select id="wlRenewPlan" style="width:100%; padding:8px 10px; background:var(--bg-primary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary);">
                        ${planOptions}
                    </select>
                </div>
            `;
            showModal('ğŸ”„ ç»­æœŸè´¦å·', content, async () => {
                const plan_type = document.getElementById('wlRenewPlan').value;
                try {
                    const res = await fetch(`${API_BASE}/admin/api/whitelist/renew`, {
                        method: 'POST', headers: {...getHeaders(), 'Content-Type': 'application/json'},
                        body: JSON.stringify({username, plan_type})
                    });
                    const data = await res.json();
                    if (data.success) { closeModal(); showToast(data.message || 'ç»­æœŸæˆåŠŸ'); loadWhitelist(wlPage); }
                    else { showToast(data.message || 'å¤±è´¥', 'error'); }
                } catch (e) { showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error'); }
            }, 'ç¡®è®¤ç»­æœŸ');
        }

        async function deleteWhitelist(username) {
            if (!confirm(`ç¡®å®šåˆ é™¤è´¦å· [${username}] çš„æˆæƒï¼Ÿ\næ³¨æ„ï¼šç§¯åˆ†ä¸é€€è¿˜ï¼`)) return;
            try {
                const res = await fetch(`${API_BASE}/admin/api/whitelist/delete`, {
                    method: 'POST', headers: {...getHeaders(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({username})
                });
                const data = await res.json();
                if (data.success) { showToast(data.message || 'åˆ é™¤æˆåŠŸ'); loadWhitelist(wlPage); }
                else { showToast(data.message || 'å¤±è´¥', 'error'); }
            } catch (e) { showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error'); }
        }

        async function togglePersistLogin(username, enabled) {
            try {
                const res = await fetch(`${API_BASE}/admin/api/whitelist/toggle_persist`, {
                    method: 'POST', headers: {...getHeaders(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({username, enabled})
                });
                const data = await res.json();
                if (data.success) { showToast(data.message || 'æ“ä½œæˆåŠŸ'); loadWhitelist(wlPage); }
                else { showToast(data.message || 'æ“ä½œå¤±è´¥', 'error'); }
            } catch (e) { showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error'); }
        }

        // ===== ç§¯åˆ†ç®¡ç† =====
        let txPage = 0;

        async function loadCreditsPage() {
            const role = sessionStorage.getItem('admin_role');
            const isSup = role === 'super_admin';
            document.getElementById('creditsOverviewSection').style.display = isSup ? '' : 'none';
            document.getElementById('creditConfigSection').style.display = isSup ? '' : 'none';

            await Promise.all([
                isSup ? loadCreditsOverview() : Promise.resolve(),
                loadCreditConfig(),
                loadCreditTransactions()
            ]);
        }

        async function loadCreditsOverview() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/credits/overview`, {headers: getHeaders()});
                const data = await res.json();
                if (!Array.isArray(data)) return;
                const tbody = document.getElementById('creditsOverviewBody');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-secondary);">æš‚æ— å­ç®¡ç†å‘˜</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(s => `<tr>
                    <td style="font-weight:bold;">${s.name}</td>
                    <td style="color:var(--accent-yellow); font-weight:bold;">${s.credits}</td>
                    <td style="color:#00ff88;">${s.active_count}</td>
                    <td>${s.total_count}</td>
                    <td><button class="btn" onclick="document.getElementById('topupAdminName').value='${s.name}';document.getElementById('topupAmount').focus();" style="padding:3px 8px; font-size:11px;">å……å€¼</button>
                        <button class="btn" onclick="loadCreditTransactions('${s.name}')" style="padding:3px 8px; font-size:11px;">æµæ°´</button></td>
                </tr>`).join('');

                // æ›´æ–°æµæ°´ç­›é€‰ä¸‹æ‹‰
                const select = document.getElementById('txFilterAdmin');
                const currentVal = select.value;
                select.innerHTML = '<option value="">å…¨éƒ¨</option>' + data.map(s =>
                    `<option value="${s.name}" ${s.name === currentVal ? 'selected' : ''}>${s.name}</option>`).join('');
            } catch (e) { console.error('åŠ è½½ç§¯åˆ†æ¦‚è§ˆå¤±è´¥', e); }
        }

        async function loadCreditConfig() {
            try {
                const res = await fetch(`${API_BASE}/admin/api/credits/config`);
                const data = await res.json();
                if (!Array.isArray(data)) return;
                wlCreditConfigs = data;
                const el = document.getElementById('creditConfigList');
                if (data.length === 0) {
                    el.innerHTML = '<div style="color:var(--text-secondary); font-size:13px;">æš‚æ— å®šä»·é…ç½®</div>';
                    return;
                }
                el.innerHTML = '<div style="display:flex; flex-wrap:wrap; gap:8px;">' + data.map(c =>
                    `<div onclick="fillCreditConfig('${c.plan_type}','${c.plan_name}',${c.credits_cost},${c.duration_days})" style="background:var(--bg-secondary); border-radius:8px; padding:8px 12px; display:flex; align-items:center; gap:8px; cursor:pointer; transition:all 0.2s; border:2px solid transparent;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="if(!this.classList.contains('cfg-selected'))this.style.borderColor='transparent'" class="cfg-badge">
                        <span style="font-weight:bold; color:var(--accent);">${c.plan_name}</span>
                        <span style="color:var(--text-secondary); font-size:12px;">${c.credits_cost}ç§¯åˆ†/${c.duration_days}å¤©</span>
${isSuperAdmin() ? `<button onclick="event.stopPropagation();deleteCreditConfig('${c.plan_type}')" style="background:none; border:none; color:#ff5252; cursor:pointer; font-size:14px;">âœ•</button>` : ''}
                    </div>`
                ).join('') + '</div>';
            } catch (e) { console.error('åŠ è½½å®šä»·å¤±è´¥', e); }
        }

        function fillCreditConfig(planType, planName, credits, days) {
            document.getElementById('cfgPlanType').value = planType;
            document.getElementById('cfgPlanName').value = planName;
            document.getElementById('cfgCredits').value = credits;
            document.getElementById('cfgDays').value = days;
            document.querySelectorAll('.cfg-badge').forEach(b => {
                b.classList.remove('cfg-selected');
                b.style.borderColor = 'transparent';
            });
            event.currentTarget.classList.add('cfg-selected');
            event.currentTarget.style.borderColor = 'var(--accent)';
        }

        function clearCreditConfigForm() {
            document.getElementById('cfgPlanType').value = '';
            document.getElementById('cfgPlanName').value = '';
            document.getElementById('cfgCredits').value = '';
            document.getElementById('cfgDays').value = '';
            document.querySelectorAll('.cfg-badge').forEach(b => {
                b.classList.remove('cfg-selected');
                b.style.borderColor = 'transparent';
            });
        }

        async function saveCreditConfig() {
            const plan_type = document.getElementById('cfgPlanType').value.trim();
            const plan_name = document.getElementById('cfgPlanName').value.trim();
            const credits_cost = parseInt(document.getElementById('cfgCredits').value) || 0;
            const duration_days = parseInt(document.getElementById('cfgDays').value) || 0;
            if (!plan_type || !plan_name || credits_cost <= 0 || duration_days <= 0) {
                showAlert('è¯·å¡«å†™å®Œæ•´çš„å®šä»·ä¿¡æ¯', 'warning'); return;
            }
            try {
                const res = await fetch(`${API_BASE}/admin/api/credits/config`, {
                    method: 'POST', headers: {...getHeaders(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({plan_type, plan_name, credits_cost, duration_days})
                });
                const data = await res.json();
                showAlert(data.message || 'æ“ä½œå®Œæˆ', data.success ? 'success' : 'error');
                if (data.success) { clearCreditConfigForm(); loadCreditConfig(); }
            } catch (e) { showAlert('ä¿å­˜å¤±è´¥: ' + e.message, 'error'); }
        }

        async function deleteCreditConfig(planType) {
            if (!confirm(`ç¡®å®šåˆ é™¤å®šä»· [${planType}]ï¼Ÿ`)) return;
            try {
                const res = await fetch(`${API_BASE}/admin/api/credits/config/${planType}`, {
                    method: 'DELETE', headers: getHeaders()
                });
                const data = await res.json();
                showAlert(data.message || 'æ“ä½œå®Œæˆ', data.success ? 'success' : 'info');
                loadCreditConfig();
            } catch (e) { showAlert('åˆ é™¤å¤±è´¥: ' + e.message, 'error'); }
        }

        async function doTopup() {
            const admin_name = document.getElementById('topupAdminName').value.trim();
            const amount = parseInt(document.getElementById('topupAmount').value) || 0;
            const description = document.getElementById('topupDesc').value;
            if (!admin_name || amount <= 0) {
                showAlert('è¯·å¡«å†™å­ç®¡ç†å‘˜åç§°å’Œå……å€¼æ•°é‡', 'warning'); return;
            }
            const msgEl = document.getElementById('topupMsg');
            try {
                const res = await fetch(`${API_BASE}/admin/api/credits/topup`, {
                    method: 'POST', headers: {...getHeaders(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({admin_name, amount, description})
                });
                const data = await res.json();
                msgEl.style.display = 'block';
                msgEl.style.background = data.success ? 'rgba(0,255,136,0.1)' : 'rgba(255,82,82,0.1)';
                msgEl.style.color = data.success ? '#00ff88' : '#ff5252';
                msgEl.textContent = data.message || 'æ“ä½œå®Œæˆ';
                if (data.success) {
                    document.getElementById('topupAmount').value = '';
                    document.getElementById('topupDesc').value = '';
                    loadCreditsOverview();
                    loadCreditTransactions();
                }
                setTimeout(() => msgEl.style.display = 'none', 5000);
            } catch (e) {
                msgEl.style.display = 'block'; msgEl.style.background = 'rgba(255,82,82,0.1)';
                msgEl.style.color = '#ff5252'; msgEl.textContent = 'å……å€¼å¤±è´¥: ' + e.message;
            }
        }

        async function loadCreditTransactions(filterName) {
            txPage = 0;
            if (filterName !== undefined) {
                document.getElementById('txFilterAdmin').value = filterName || '';
            }
            const adminName = document.getElementById('txFilterAdmin').value;
            const params = new URLSearchParams({limit: 50, offset: 0});
            if (adminName) params.append('admin_name', adminName);
            try {
                const res = await fetch(`${API_BASE}/admin/api/credits/transactions?${params}`, {headers: getHeaders()});
                const data = await res.json();
                const tbody = document.getElementById('txTableBody');
                const rows = data.rows || [];
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--text-secondary);">æš‚æ— è®°å½•</td></tr>';
                } else {
                    tbody.innerHTML = rows.map(t => {
                        const isTopup = t.type === 'topup';
                        const amtColor = isTopup ? '#00ff88' : '#ff5252';
                        const amtPrefix = isTopup ? '+' : '';
                        const typeNames = {topup: 'å……å€¼', deduct: 'æ‰£é™¤', refund: 'é€€å›'};
                        return `<tr>
                            <td style="font-size:12px;">${fmtTime(t.created_at)}</td>
                            <td>${t.admin_name}</td>
                            <td style="color:${amtColor};">${typeNames[t.type] || t.type}</td>
                            <td style="color:${amtColor}; font-weight:bold;">${amtPrefix}${t.amount}</td>
                            <td>${t.balance_after}</td>
                            <td style="color:var(--text-secondary); max-width:150px; overflow:hidden; text-overflow:ellipsis;">${t.description || ''}</td>
                            <td style="color:var(--text-secondary);">${t.operator || ''}</td>
                        </tr>`;
                    }).join('');
                }
            } catch (e) { console.error('åŠ è½½æµæ°´å¤±è´¥', e); }
        }

        // å¦‚æœå·²ç™»å½•ï¼Œç›´æ¥åˆå§‹åŒ–
        if (isLoggedIn) {
            initApp();
        }
    </script>
</body>
</html>
